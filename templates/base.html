<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SportOase Buchungssystem{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=20251125e">
    <meta http-equiv="refresh" content="600">
    <script>
        (function() {
            try {
                var savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
</head>
<body>
    {% if session.user_id %}
    <div class="top-nav">
        <div class="container">
            <nav>
                <a href="https://www.erspattensen.de" target="_blank" class="nav-logo-link" title="Ernst-Reuter-Schule">
                    <img src="{{ url_for('static', filename='logo-ers.jpg') }}" alt="ERS Logo" class="nav-logo">
                </a>
                <a href="{{ url_for('dashboard') }}">Dashboard</a>
                {% if session.user_role == 'admin' %}
                <a href="{{ url_for('admin') }}">Admin</a>
                <div class="notification-container">
                    <button class="notification-bell" onclick="toggleNotifications()" aria-label="Benachrichtigungen">
                        ðŸ””
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h4>Benachrichtigungen</h4>
                            <button class="mark-all-read" onclick="markAllAsRead()">Alle als gelesen markieren</button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <p class="no-notifications">Keine neuen Benachrichtigungen</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                <a href="{{ url_for('change_password') }}">Passwort Ã¤ndern</a>
                <a href="{{ url_for('logout') }}">Logout</a>
                <div class="theme-toggle">
                    <label class="theme-switch">
                        <input type="checkbox" class="theme-switch-input" id="themeToggle" onchange="toggleTheme()">
                        <span class="theme-switch-slider"></span>
                    </label>
                </div>
            </nav>
        </div>
    </div>
    {% endif %}
    
    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="message message-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>
    
    <div class="credits-button" onclick="toggleCredits()">?</div>
    
    <div id="creditsModal" class="credits-modal">
        <div class="credits-content">
            <span class="credits-close" onclick="toggleCredits()">&times;</span>
            <h3>Credits</h3>
            <p><strong>Programmed in:</strong> Python version 3.13.4</p>
            <p><strong>using</strong> Flask-SQLAlchemy-3.1.1 blinker-1.9.0 cachetools-6.2.2 certifi-2025.11.12 charset_normalizer-3.4.4 click-8.3.0 dnspython-2.8.0 email_validator-2.3.0 flask-3.1.2 google-api-core-2.28.1 google-api-python-client-2.187.0 google-auth-2.41.1 google-auth-httplib2-0.2.1 google-auth-oauthlib-1.2.3 googleapis-common-protos-1.72.0 greenlet-3.2.4 gunicorn-23.0.0 httplib2-0.31.0 idna-3.11 itsdangerous-2.2.0 jinja2-3.1.6 markupsafe-3.0.3 oauthlib-3.3.1 packaging-25.0 proto-plus-1.26.1 protobuf-6.33.1 psycopg2-binary-2.9.11 pyasn1-0.6.1 pyasn1-modules-0.4.2 pyparsing-3.2.5 python-dotenv-1.2.1 pytz-2025.2 requests-2.32.5 requests-oauthlib-2.0.0 rsa-4.9.1 sqlalchemy-2.0.44 typing-extensions-4.15.0 uritemplate-4.2.0 urllib3-2.5.0 werkzeug-3.1.33</p>
            <p><strong>Security:</strong> CloudFlare SSL</p>
            <p><strong>Server:</strong> SSL / AES-256 Encrypted Server</p>
            <p><strong>Handcrafted by:</strong> Mauro Morelli</p>
        </div>
    </div>
    
    <script>
        function toggleCredits() {
            var modal = document.getElementById('creditsModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }
        
        window.onclick = function(event) {
            var modal = document.getElementById('creditsModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Notification System (nur fÃ¼r Admins)
        {% if session.user_role == 'admin' %}
        let notificationSound = null;
        let eventSource = null;

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = (now - date) / 1000;
            
            if (diff < 60) return 'Gerade eben';
            if (diff < 3600) return Math.floor(diff / 60) + ' Min';
            if (diff < 86400) return Math.floor(diff / 3600) + ' Std';
            return date.toLocaleDateString('de-DE');
        }

        function renderNotification(notification) {
            const div = document.createElement('div');
            div.className = 'notification-item' + (notification.is_read ? ' read' : '');
            div.innerHTML = `
                <div class="notification-content">
                    <p class="notification-message">${notification.message}</p>
                    <span class="notification-time">${formatDate(notification.created_at)}</span>
                </div>
                ${!notification.is_read ? `<button class="mark-read-btn" onclick="markAsRead(${notification.id})">âœ“</button>` : ''}
            `;
            return div;
        }

        function loadRecentNotifications() {
            fetch('/api/notifications/recent?limit=10')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('notificationList');
                    if (data.success && data.notifications.length > 0) {
                        list.innerHTML = '';
                        data.notifications.forEach(notif => {
                            list.appendChild(renderNotification(notif));
                        });
                    } else {
                        list.innerHTML = '<p class="no-notifications">Keine neuen Benachrichtigungen</p>';
                    }
                })
                .catch(error => console.error('Fehler beim Laden der Benachrichtigungen:', error));
        }

        function updateUnreadCount() {
            fetch('/api/notifications/unread_count')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationBadge(data.count);
                    }
                })
                .catch(error => console.error('Fehler beim Aktualisieren des ZÃ¤hlers:', error));
        }

        function markAsRead(notificationId) {
            fetch(`/api/notifications/${notificationId}/mark_read`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf_token: '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRecentNotifications();
                    updateUnreadCount();
                }
            })
            .catch(error => console.error('Fehler beim Markieren:', error));
        }

        function markAllAsRead() {
            fetch('/api/notifications/mark_all_read', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    csrf_token: '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRecentNotifications();
                    updateNotificationBadge(0);
                }
            })
            .catch(error => console.error('Fehler beim Markieren aller:', error));
        }

        function playNotificationSound() {
            if (!notificationSound) {
                notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQAAAAEAAAAAgAEAAAA=');
            }
            notificationSound.play().catch(e => console.log('Sound play failed:', e));
        }

        // SSE deaktiviert - Polling-basierte Updates stattdessen
        function startPolling() {
            // Aktualisiere alle 30 Sekunden
            setInterval(() => {
                updateUnreadCount();
                loadRecentNotifications();
            }, 30000);
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notificationDropdown');
            const bell = document.querySelector('.notification-bell');
            
            if (!dropdown.contains(event.target) && !bell.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            updateUnreadCount();
            loadRecentNotifications();
            startPolling();
        });
        {% endif %}
        
        // Theme Toggle Funktion
        function toggleTheme() {
            try {
                var html = document.documentElement;
                var currentTheme = html.getAttribute('data-theme') || 'light';
                var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                try {
                    localStorage.setItem('theme', newTheme);
                } catch (e) {}
                
                var toggle = document.getElementById('themeToggle');
                if (toggle) {
                    toggle.checked = newTheme === 'dark';
                }
            } catch (e) {
                console.log('Theme toggle error:', e);
            }
        }
        
        // Theme beim Laden setzen
        document.addEventListener('DOMContentLoaded', function() {
            try {
                var savedTheme = 'light';
                try {
                    savedTheme = localStorage.getItem('theme') || 'light';
                } catch (e) {}
                var toggle = document.getElementById('themeToggle');
                if (toggle) {
                    toggle.checked = savedTheme === 'dark';
                }
            } catch (e) {}
        });
    </script>
</body>
</html>
