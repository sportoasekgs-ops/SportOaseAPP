{% extends "base.html" %}

{% block title %}Dashboard - SportOase{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2 class="dashboard-title">
            <span class="title-icon">üìÖ</span>
            Buchungs√ºbersicht SportOASE
        </h2>
    </div>
    
    <!-- Gebrauchsanleitung & FAQ (aufklappbar) -->
    <details class="help-section">
        <summary class="help-toggle">
            <span class="help-icon">‚ÑπÔ∏è</span>
            <span>Anleitung & FAQ</span>
            <span class="toggle-arrow">‚ñº</span>
        </summary>
        <div class="help-content">
            <div class="help-grid">
                <!-- Schnellanleitung -->
                <div class="help-card">
                    <h4>üöÄ Schnellanleitung</h4>
                    <ol class="help-steps">
                        <li><strong>Slot ausw√§hlen:</strong> Klicke auf "Buchen" bei einem freien Slot</li>
                        <li><strong>Daten eingeben:</strong> Dein Name wird automatisch eingetragen - nur Klasse und Sch√ºler*innen-Daten eintragen</li>
                        <li><strong>Modul w√§hlen:</strong> Bei "Freie Wahl" ein Modul ausw√§hlen</li>
                        <li><strong>Absenden:</strong> "Buchung abschlie√üen" klicken</li>
                    </ol>
                </div>
                
                <!-- Funktionen -->
                <div class="help-card">
                    <h4>‚ú® Funktionen</h4>
                    <ul class="feature-list">
                        <li><span class="feature-icon">üìÖ</span> Wochen√ºbersicht mit allen Slots</li>
                        <li><span class="feature-icon">üìù</span> Einfache Buchung f√ºr 1-5 Sch√ºler*innen</li>
                        <li><span class="feature-icon">üîí</span> Datenschutz: Sch√ºler*innen-Namen nur f√ºr eigene Buchungen sichtbar</li>
                        <li><span class="feature-icon">‚è∞</span> Buchung bis 60 Min. vor Beginn m√∂glich</li>
                        <li><span class="feature-icon">üö´</span> Automatische Doppelbuchungs-Pr√ºfung</li>
                    </ul>
                </div>
                
                <!-- FAQ -->
                <div class="help-card">
                    <h4>‚ùì H√§ufige Fragen</h4>
                    <div class="faq-item">
                        <strong>Was bedeuten die Farben?</strong>
                        <p>Gr√ºn = Feste Angebote, Blau = Freie Wahl (Modul w√§hlbar)</p>
                    </div>
                    <div class="faq-item">
                        <strong>Wie viele Sch√ºler*innen pro Slot?</strong>
                        <p>Maximal 5 Sch√ºler*innen pro Stunde insgesamt</p>
                    </div>
                    <div class="faq-item">
                        <strong>Wird mein Name automatisch eingetragen?</strong>
                        <p>Ja! Dein Name wird aus Ihrem IServ-Login automatisch √ºbernommen.</p>
                    </div>
                    <div class="faq-item">
                        <strong>Kann ich eine Buchung bearbeiten / stornieren?</strong>
                        <p>Ja, in der Buchungs√ºbersicht oben bearbeiten oder zum l√∂schen auf den Papierkorb klicken </p>
                    </div>
                </div>
                
                <!-- Slot-Typen -->
                <div class="help-card">
                    <h4>üìã Angebots-Typen</h4>
                    <div class="slot-type-info">
                        <div class="slot-type">
                            <span class="type-badge type-fest">Fest</span>
                            <span>Vorgegebenes Angebot (z.B. Koordinationszirkel)</span>
                        </div>
                        <div class="slot-type">
                            <span class="type-badge type-frei">Frei</span>
                            <span>Modul w√§hlbar: Aktivierung, Entspannung, Konflikt-Reset</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sicherheitsstandards -->
                <div class="help-card">
                    <h4>üîê Sicherheit & Datenschutz</h4>
                    <ul class="feature-list">
                        <li><span class="feature-icon">üîë</span> IServ Single Sign-On (OAuth 2.0)</li>
                        <li><span class="feature-icon">üîí</span> HTTPS-Verschl√ºsselung</li>
                        <li><span class="feature-icon">üõ°Ô∏è</span> CSRF-Schutz f√ºr alle Formulare</li>
                        <li><span class="feature-icon">üëÅÔ∏è</span> Datenschutz: Sch√ºler*innen-Namen nur f√ºr Ersteller sichtbar</li>
                        <li><span class="feature-icon">üîè</span> Sichere Passwort-Speicherung</li>
                        <li><span class="feature-icon">üìä</span> PostgreSQL Datenbank</li>
                    </ul>
                </div>
            </div>
        </div>
    </details>
    
    <!-- Datumswahl -->
    <div class="date-selector">
        <form method="GET" action="{{ url_for('dashboard') }}">
            <label for="date">üìÜ Datum w√§hlen:</label>
            <input type="date" id="date" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
        </form>
    </div>
    
    <div class="selected-date-info">
        <h3>{{ weekday }}, {{ selected_date.strftime('%d.%m.%Y') }}</h3>
    </div>
    
    <!-- Wochen√ºbersicht -->
    <div class="week-overview">
        <div class="week-header-with-nav">
            <a href="{{ url_for('dashboard', date=prev_week_date) }}" class="week-nav-arrow" title="Vorherige Woche">
                <span class="arrow-icon">‚ùÆ</span>
            </a>
            <h3 class="week-title">
                <span class="week-icon">üìä</span>
                Wochenplan KW {{ calendar_week }}/{{ calendar_year }}
                <span class="week-dates">{{ monday_date }} - {{ friday_date }}</span>
            </h3>
            <a href="{{ url_for('dashboard', date=next_week_date) }}" class="week-nav-arrow" title="N√§chste Woche">
                <span class="arrow-icon">‚ùØ</span>
            </a>
        </div>
        <div class="week-table-wrapper">
            <div class="scroll-hint scroll-hint-left" style="display:none;">‚ùÆ</div>
            <table class="week-table">
            <thead>
                <tr>
                    <th>Stunde</th>
                    {% for day in week_overview %}
                    <th class="{% if day.is_today %}today-column{% endif %}">
                        <div class="week-day-header {% if day.is_today %}today-header{% endif %}">
                            <div class="day-name">{{ day.name }}</div>
                            <div class="day-date">{{ day.date_formatted }}</div>
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for period in range(1, 7) %}
                <tr>
                    <td><strong>{{ period }}.</strong></td>
                    {% for day in week_overview %}
                    <td class="{% if day.is_today %}today-column{% endif %} {% if day.schedule[period-1].blocked %}period-blocked{% elif day.schedule[period-1].is_weekend %}period-past{% elif day.schedule[period-1].is_past %}period-past{% else %}period-{{ day.schedule[period-1].type }}{% endif %} {% if day.schedule[period-1].can_book %}clickable-slot{% endif %}">
                        {% if day.schedule[period-1].blocked %}
                            <div class="period-header blocked-header">
                                <div class="slot-detail">{{ day.schedule[period-1].blocked_reason }}</div>
                            </div>
                            {% if user_role == 'admin' %}
                            <div class="slot-actions">
                                <form method="POST" action="{{ url_for('admin_unblock_slot') }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="date" value="{{ day.date }}">
                                    <input type="hidden" name="period" value="{{ period }}">
                                    <button type="submit" class="slot-btn slot-btn-success">Freigeben</button>
                                </form>
                            </div>
                            {% endif %}
                        {% else %}
                            {% set slot = day.schedule[period-1] %}
                            {% set label = slot.label %}
                            {% set course_class = 'course-frei' %}
                            {% set course_icon = '‚≠ê' %}
                            {% set course_tag = 'Flexibel' %}
                            {% if slot.type == 'fest' %}
                                {% if 'Wochenstart' in label %}
                                    {% set course_class = 'course-wochenstart' %}
                                    {% set course_icon = '‚òÄÔ∏è' %}
                                    {% set course_tag = 'Energie' %}
                                {% elif 'Konflikt' in label or 'Deeskalation' in label %}
                                    {% set course_class = 'course-konflikt' %}
                                    {% set course_icon = 'üõ°Ô∏è' %}
                                    {% set course_tag = 'Reset' %}
                                {% elif 'Koordination' in label %}
                                    {% set course_class = 'course-koordination' %}
                                    {% set course_icon = 'üéØ' %}
                                    {% set course_tag = 'Fokus' %}
                                {% elif 'Sozial' in label or 'Gruppen' in label %}
                                    {% set course_class = 'course-sozial' %}
                                    {% set course_icon = 'üë•' %}
                                    {% set course_tag = 'Team' %}
                                {% elif 'Mini-Fitness' in label or 'Aktivierung' in label %}
                                    {% set course_class = 'course-fitness' %}
                                    {% set course_icon = '‚ö°' %}
                                    {% set course_tag = 'Power' %}
                                {% elif 'Motorik' in label or 'Parcours' in label %}
                                    {% set course_class = 'course-motorik' %}
                                    {% set course_icon = 'üèÉ' %}
                                    {% set course_tag = 'Bewegung' %}
                                {% elif 'Turnen' in label or 'Balance' in label %}
                                    {% set course_class = 'course-turnen' %}
                                    {% set course_icon = 'ü§∏' %}
                                    {% set course_tag = 'Balance' %}
                                {% elif 'Atem' in label or 'Reflexion' in label %}
                                    {% set course_class = 'course-atem' %}
                                    {% set course_icon = 'üå¨Ô∏è' %}
                                    {% set course_tag = 'Atem' %}
                                {% elif 'Bodyscan' in label %}
                                    {% set course_class = 'course-bodyscan' %}
                                    {% set course_icon = 'üßò' %}
                                    {% set course_tag = 'Scan' %}
                                {% elif 'Ruhe' in label or 'Entspannung' in label %}
                                    {% set course_class = 'course-ruhe' %}
                                    {% set course_icon = 'üçÉ' %}
                                    {% set course_tag = 'Ruhe' %}
                                {% else %}
                                    {% set course_class = 'course-default' %}
                                    {% set course_icon = 'üìã' %}
                                    {% set course_tag = 'Fest' %}
                                {% endif %}
                            {% endif %}
                            
                            <div class="slot-card {{ course_class }}">
                                <div class="slot-course-name">
                                    {% if slot.type == 'fest' %}{{ label }}{% else %}Freie Wahl{% endif %}
                                </div>
                                
                                {% if slot.bookings %}
                                <div class="slot-students-list">
                                    {% for booking in slot.bookings %}
                                    {% set can_see = (user_role == 'admin') or (booking.teacher_id == current_user_id) %}
                                    {% for student in booking.students %}
                                    <span class="student-name {% if not can_see %}blurred{% endif %}">
                                        {% if can_see %}{{ student.name }} ({{ student.klasse }}){% else %}***{% endif %}
                                    </span>
                                    {% endfor %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <div class="slot-footer">
                                    <span class="course-tag">
                                        <span class="tag-icon">{{ course_icon }}</span>
                                        {{ course_tag }}
                                    </span>
                                    <span class="slot-availability">
                                        {% if slot.can_book %}
                                        <span class="availability-text">{{ slot.total_students }}/5 gebucht</span>
                                        {% elif slot.available == 0 and not slot.is_past %}
                                        <span class="full-text">Ausgebucht (5/5)</span>
                                        {% else %}
                                        <span class="status-text">{{ slot.total_students }}/5 gebucht</span>
                                        {% endif %}
                                    </span>
                                </div>
                                
                                {% if slot.can_book %}
                                <a href="{{ url_for('book', date_str=day.date, period=period) }}" class="book-btn" data-book-url="{{ url_for('book', date_str=day.date, period=period) }}">
                                    üìù Jetzt buchen
                                </a>
                                {% endif %}
                                
                                {% if user_role == 'admin' and not slot.is_past %}
                                <button type="button" class="slot-block-mini" title="Sperren" 
                                    onclick="openBlockModal('{{ day.date }}', {{ period }}, '{{ day.name }} {{ day.date_formatted }}')">üîí</button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
            <div class="scroll-hint scroll-hint-right">‚ùØ</div>
        </div>
    </div>
    
    <!-- Kontakt-Information -->
    <div class="contact-info-box">
        <div class="contact-content">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="SportOase Logo" class="contact-logo">
            <div class="contact-text">
                <p>Bei dringenden Anliegen bin ich direkt via E-Mail: <strong>morelli.maurizio@kgs-pattensen.de</strong> und telefonisch unter: <strong>0151 40349764</strong> erreichbar.</p>
            </div>
        </div>
    </div>
</div>

{% if user_role == 'admin' %}
<!-- Modal f√ºr Slot-Sperrung -->
<div id="blockModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîí Slot sperren</h3>
            <button type="button" class="modal-close" onclick="closeBlockModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('admin_block_slot') }}" id="blockForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="date" id="blockDate">
            <input type="hidden" name="period" id="blockPeriod">
            
            <div class="modal-body">
                <p class="modal-slot-info" id="blockSlotInfo"></p>
                
                <div class="form-group">
                    <label for="blockReason">Grund:</label>
                    <input type="text" name="reason" id="blockReason" class="form-control" 
                        placeholder="z.B. Umbau, Beratung, Fortbildung..." maxlength="50" required>
                </div>
                
                <div class="form-group">
                    <label>Icon ausw√§hlen:</label>
                    <div class="icon-picker">
                        <label class="icon-option">
                            <input type="radio" name="icon" value="üîß" checked>
                            <span class="icon-display">üîß</span>
                            <span class="icon-label">Umbau</span>
                        </label>
                        <label class="icon-option">
                            <input type="radio" name="icon" value="üí¨">
                            <span class="icon-display">üí¨</span>
                            <span class="icon-label">Beratung</span>
                        </label>
                        <label class="icon-option">
                            <input type="radio" name="icon" value="üìö">
                            <span class="icon-display">üìö</span>
                            <span class="icon-label">Fortbildung</span>
                        </label>
                        <label class="icon-option">
                            <input type="radio" name="icon" value="üèñÔ∏è">
                            <span class="icon-display">üèñÔ∏è</span>
                            <span class="icon-label">Ferien</span>
                        </label>
                        <label class="icon-option">
                            <input type="radio" name="icon" value="üéâ">
                            <span class="icon-display">üéâ</span>
                            <span class="icon-label">Event</span>
                        </label>
                        <label class="icon-option">
                            <input type="radio" name="icon" value="‚ö†Ô∏è">
                            <span class="icon-display">‚ö†Ô∏è</span>
                            <span class="icon-label">Sonstiges</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBlockModal()">Abbrechen</button>
                <button type="submit" class="btn btn-danger">Slot sperren</button>
            </div>
        </form>
    </div>
</div>

<script>
function openBlockModal(date, period, slotInfo) {
    document.getElementById('blockDate').value = date;
    document.getElementById('blockPeriod').value = period;
    document.getElementById('blockSlotInfo').textContent = slotInfo + ', ' + period + '. Stunde';
    document.getElementById('blockReason').value = '';
    document.getElementById('blockModal').style.display = 'flex';
}

function closeBlockModal() {
    document.getElementById('blockModal').style.display = 'none';
}

document.getElementById('blockModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBlockModal();
    }
});
</script>
{% endif %}

<!-- Slot-Klick-Handler (f√ºr alle Benutzer, Desktop & Mobile) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Alle buchbaren Slots klickbar machen
    document.querySelectorAll('.clickable-slot').forEach(function(cell) {
        // Klick auf die gesamte Zelle
        cell.addEventListener('click', function(e) {
            // Ignoriere Klicks auf Buttons, Formulare und den Buchen-Link selbst
            if (e.target.tagName === 'BUTTON' || e.target.closest('button') || 
                e.target.tagName === 'FORM' || e.target.closest('form') ||
                e.target.tagName === 'A' || e.target.closest('a')) {
                return;
            }
            
            // Finde den Buchen-Link und navigiere dorthin
            var bookBtn = cell.querySelector('.book-btn');
            if (bookBtn) {
                var bookUrl = bookBtn.getAttribute('href') || bookBtn.getAttribute('data-book-url');
                if (bookUrl) {
                    window.location.href = bookUrl;
                }
            }
        });
    });
    
    // Hover-Effekt f√ºr besseres visuelles Feedback
    document.querySelectorAll('.clickable-slot .slot-card').forEach(function(card) {
        card.style.cursor = 'pointer';
    });
});
</script>
{% endblock %}
