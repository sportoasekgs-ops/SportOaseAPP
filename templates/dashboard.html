{% extends "base.html" %}

{% block title %}Dashboard - SportOase{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2 class="dashboard-title">
            <span class="title-icon">ğŸ“…</span>
            BuchungsÃ¼bersicht SportOASE
        </h2>
    </div>
    
    <!-- Gebrauchsanleitung & FAQ (aufklappbar) -->
    <details class="help-section">
        <summary class="help-toggle">
            <span class="help-icon">â„¹ï¸</span>
            <span>Anleitung & FAQ</span>
            <span class="toggle-arrow">â–¼</span>
        </summary>
        <div class="help-content">
            <div class="help-grid">
                <!-- Schnellanleitung -->
                <div class="help-card">
                    <h4>ğŸš€ Schnellanleitung</h4>
                    <ol class="help-steps">
                        <li><strong>Slot auswÃ¤hlen:</strong> Klicken Sie auf "Buchen" bei einem freien Slot</li>
                        <li><strong>Daten eingeben:</strong> Ihr Name wird automatisch eingetragen - nur Klasse und SchÃ¼lerdaten eintragen</li>
                        <li><strong>Modul wÃ¤hlen:</strong> Bei "Freie Wahl" ein Modul auswÃ¤hlen</li>
                        <li><strong>Absenden:</strong> "Buchung abschlieÃŸen" klicken</li>
                    </ol>
                </div>
                
                <!-- Funktionen -->
                <div class="help-card">
                    <h4>âœ¨ Funktionen</h4>
                    <ul class="feature-list">
                        <li><span class="feature-icon">ğŸ“…</span> WochenÃ¼bersicht mit allen Slots</li>
                        <li><span class="feature-icon">ğŸ“</span> Einfache Buchung fÃ¼r 1-5 SchÃ¼ler</li>
                        <li><span class="feature-icon">ğŸ”’</span> Datenschutz: SchÃ¼lernamen nur fÃ¼r eigene Buchungen sichtbar</li>
                        <li><span class="feature-icon">â°</span> Buchung bis 60 Min. vor Beginn mÃ¶glich</li>
                        <li><span class="feature-icon">ğŸš«</span> Automatische Doppelbuchungs-PrÃ¼fung</li>
                    </ul>
                </div>
                
                <!-- FAQ -->
                <div class="help-card">
                    <h4>â“ HÃ¤ufige Fragen</h4>
                    <div class="faq-item">
                        <strong>Was bedeuten die Farben?</strong>
                        <p>GrÃ¼n = Feste Angebote, Blau = Freie Wahl (Modul wÃ¤hlbar)</p>
                    </div>
                    <div class="faq-item">
                        <strong>Wie viele SchÃ¼ler pro Slot?</strong>
                        <p>Maximal 5 SchÃ¼ler pro Stunde insgesamt</p>
                    </div>
                    <div class="faq-item">
                        <strong>Wird mein Name automatisch eingetragen?</strong>
                        <p>Ja! Ihr Name wird aus Ihrem IServ-Login automatisch Ã¼bernommen.</p>
                    </div>
                    <div class="faq-item">
                        <strong>Kann ich eine Buchung stornieren?</strong>
                        <p>Bitte wenden Sie sich an den Admin</p>
                    </div>
                </div>
                
                <!-- Slot-Typen -->
                <div class="help-card">
                    <h4>ğŸ“‹ Angebots-Typen</h4>
                    <div class="slot-type-info">
                        <div class="slot-type">
                            <span class="type-badge type-fest">Fest</span>
                            <span>Vorgegebenes Angebot (z.B. Koordinationszirkel)</span>
                        </div>
                        <div class="slot-type">
                            <span class="type-badge type-frei">Frei</span>
                            <span>Modul wÃ¤hlbar: Aktivierung, Entspannung, Konflikt-Reset</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sicherheitsstandards -->
                <div class="help-card">
                    <h4>ğŸ” Sicherheit & Datenschutz</h4>
                    <ul class="feature-list">
                        <li><span class="feature-icon">ğŸ”‘</span> IServ Single Sign-On (OAuth 2.0)</li>
                        <li><span class="feature-icon">ğŸ”’</span> HTTPS-VerschlÃ¼sselung</li>
                        <li><span class="feature-icon">ğŸ›¡ï¸</span> CSRF-Schutz fÃ¼r alle Formulare</li>
                        <li><span class="feature-icon">ğŸ‘ï¸</span> Datenschutz: SchÃ¼lernamen nur fÃ¼r Ersteller sichtbar</li>
                        <li><span class="feature-icon">ğŸ”</span> Sichere Passwort-Speicherung</li>
                        <li><span class="feature-icon">ğŸ“Š</span> PostgreSQL Datenbank</li>
                    </ul>
                </div>
            </div>
        </div>
    </details>
    
    <!-- Datumswahl -->
    <div class="date-selector">
        <form method="GET" action="{{ url_for('dashboard') }}">
            <label for="date">ğŸ“† Datum wÃ¤hlen:</label>
            <input type="date" id="date" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
        </form>
    </div>
    
    <div class="selected-date-info">
        <h3>{{ weekday }}, {{ selected_date.strftime('%d.%m.%Y') }}</h3>
    </div>
    
    <!-- WochenÃ¼bersicht -->
    <div class="week-overview">
        <div class="week-header-with-nav">
            <a href="{{ url_for('dashboard', date=prev_week_date) }}" class="week-nav-arrow" title="Vorherige Woche">
                <span class="arrow-icon">â®</span>
            </a>
            <h3 class="week-title">
                <span class="week-icon">ğŸ“Š</span>
                Wochenplan KW {{ calendar_week }}/{{ calendar_year }}
                <span class="week-dates">{{ monday_date }} - {{ friday_date }}</span>
            </h3>
            <a href="{{ url_for('dashboard', date=next_week_date) }}" class="week-nav-arrow" title="NÃ¤chste Woche">
                <span class="arrow-icon">â¯</span>
            </a>
        </div>
        <table class="week-table">
            <thead>
                <tr>
                    <th>Stunde</th>
                    {% for day in week_overview %}
                    <th>
                        <div class="week-day-header">
                            <div class="day-name">{{ day.name }}</div>
                            <div class="day-date">{{ day.date_formatted }}</div>
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for period in range(1, 7) %}
                <tr>
                    <td><strong>{{ period }}.</strong></td>
                    {% for day in week_overview %}
                    <td class="period-{{ day.schedule[period-1].type }} {% if day.schedule[period-1].blocked %}period-blocked{% elif day.schedule[period-1].is_weekend %}period-past{% elif day.schedule[period-1].is_past %}period-past{% endif %} {% if day.schedule[period-1].can_book %}clickable-slot{% endif %}">
                        {% if day.schedule[period-1].blocked %}
                            <div class="period-header blocked-header">
                                <span class="blocked-icon">âœ•</span>
                                <div class="slot-detail">{{ day.schedule[period-1].blocked_reason }}</div>
                            </div>
                            {% if user_role == 'admin' %}
                            <div class="slot-actions">
                                <form method="POST" action="{{ url_for('admin_unblock_slot') }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="date" value="{{ day.date }}">
                                    <input type="hidden" name="period" value="{{ period }}">
                                    <button type="submit" class="slot-btn slot-btn-success">Freigeben</button>
                                </form>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="slot-compact">
                                <div class="slot-header-row">
                                    <span class="slot-type-label {% if day.schedule[period-1].type == 'fest' %}type-fest{% else %}type-frei{% endif %}">
                                        {% if day.schedule[period-1].type == 'fest' %}{{ day.schedule[period-1].label }}{% else %}Freie Wahl{% endif %}
                                    </span>
                                    <span class="slot-capacity">{{ day.schedule[period-1].total_students }}/5</span>
                                </div>
                                
                                {% if day.schedule[period-1].can_book %}
                                <a href="{{ url_for('book', date_str=day.date, period=period) }}" class="slot-book-btn">
                                    + Buchen ({{ day.schedule[period-1].available }} frei)
                                </a>
                                {% elif day.schedule[period-1].available == 0 and not day.schedule[period-1].is_past %}
                                <span class="slot-full">Ausgebucht</span>
                                {% endif %}
                                
                                {% if day.schedule[period-1].bookings %}
                                <div class="slot-bookings">
                                    {% for booking in day.schedule[period-1].bookings %}
                                    <div class="slot-booking-entry">
                                        <span class="booking-offer">{{ booking.offer_label }}</span>
                                        {% set can_see_students = (user_role == 'admin') or (booking.teacher_id == current_user_id) %}
                                        {% for student in booking.students %}
                                        {% if can_see_students %}
                                        <span class="mini-student">{{ student.name[:10] }}{% if student.name|length > 10 %}..{% endif %}</span>
                                        {% else %}
                                        <span class="mini-student blurred">***</span>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                {% if user_role == 'admin' and not day.schedule[period-1].is_past %}
                                <form method="POST" action="{{ url_for('admin_block_slot') }}" class="admin-block-form">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="date" value="{{ day.date }}">
                                    <input type="hidden" name="period" value="{{ period }}">
                                    <input type="hidden" name="reason" value="Beratung">
                                    <button type="submit" class="slot-block-mini" title="Sperren">ğŸ”’</button>
                                </form>
                                {% endif %}
                            </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Kontakt-Information -->
    <div class="contact-info-box">
        <div class="contact-content">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="SportOase Logo" class="contact-logo">
            <div class="contact-text">
                <p>Bei dringenden Anliegen bin ich direkt via E-Mail: <strong>morelli.maurizio@kgs-pattensen.de</strong> und telefonisch unter: <strong>0151 40349764</strong> erreichbar.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
