{"file_contents":{"README.md":{"content":"# SportOase Buchungssystem\n\nWeb-Anwendung zur Verwaltung von Buchungen f√ºr die Schul-SportOase der KGS Pattensen (Ernst-Reuter-Schule).\n\n## Funktionen\n\n- **IServ SSO**: Login √ºber IServ-Schulaccount (OAuth2/OpenID Connect)\n- **Wochenplan-Anzeige**: √úbersicht √ºber feste und freie Zeitslots mit Farbkodierung\n- **Buchungssystem**: Lehrkr√§fte k√∂nnen 1-5 Sch√ºler pro Zeitslot anmelden\n- **Kapazit√§tskontrolle**: Maximal 5 Sch√ºler pro Zeitslot\n- **Vorlaufzeit**: Buchungen nur bis 60 Minuten vor Stundenbeginn m√∂glich\n- **Meine Buchungen**: Eigene Buchungen einsehen, bearbeiten und l√∂schen\n- **E-Mail-Benachrichtigungen**: Automatische Benachrichtigung bei neuen Buchungen\n- **Admin-Panel**: Verwaltung von Buchungen, Slot-Sperrungen und Benutzer√ºbersicht\n- **Mobile-optimiert**: Responsive Design mit 1-Tag-Ansicht auf Mobilger√§ten\n\n---\n\n## Rollenverwaltung\n\n| Rolle | Zugang |\n|-------|--------|\n| **Admin** | `morelli.maurizio@kgs-pattensen.de` oder IServ-Gruppe \"Administrator\" |\n| **Lehrer** | IServ-Gruppen: Lehrer, Mitarbeitende, Mitarbeiter, P√§dagogische Mitarbeiter, Sozialp√§dagogen, Beratung, Fairplaycoaches |\n\n---\n\n## Wochenplan-Struktur\n\n| Stunde | Zeit |\n|--------|------|\n| 1. | 07:50 - 08:35 |\n| 2. | 08:35 - 09:20 |\n| 3. | 09:40 - 10:25 |\n| 4. | 10:25 - 11:20 |\n| 5. | 11:40 - 12:25 |\n| 6. | 12:25 - 13:10 |\n\n### Feste Angebote (farbkodiert)\n\n- **Montag**: 1., 3., 5. Stunde fest\n- **Dienstag**: Alle Stunden frei\n- **Mittwoch**: 1., 3., 5. Stunde fest\n- **Donnerstag**: 2., 5. Stunde fest\n- **Freitag**: 2., 4., 5. Stunde fest\n\n---\n\n## Deployment auf Render\n\n### 1. PostgreSQL-Datenbank erstellen\n\n1. Render Dashboard ‚Üí **New +** ‚Üí **PostgreSQL**\n2. Name: `sportoase-db`, Region: Frankfurt, Plan: Free\n3. **Internal Database URL** kopieren\n4. `postgres://` zu `postgresql://` √§ndern!\n\n### 2. Web Service erstellen\n\n| Einstellung | Wert |\n|-------------|------|\n| Name | `sportoase-app` |\n| Build Command | `pip install -r requirements.txt` |\n| Start Command | `gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 120 main:app` |\n| Python Version | 3.11 |\n\n### 3. Environment Variables\n\n| Variable | Beschreibung |\n|----------|--------------|\n| `DATABASE_URL` | PostgreSQL Connection String (postgresql://...) |\n| `SESSION_SECRET` | Zuf√§lliger 64-Zeichen-String |\n| `ISERV_CLIENT_ID` | OAuth Client-ID aus IServ |\n| `ISERV_CLIENT_SECRET` | OAuth Client-Secret aus IServ |\n| `ISERV_DOMAIN` | `kgs-pattensen.de` |\n| `SMTP_USER` | `sportoase.kgs@gmail.com` |\n| `SMTP_PASS` | Gmail App-Passwort |\n\n### 4. Datenbank initialisieren\n\n```bash\n# In Render Shell:\npython db_setup.py\n```\n\n---\n\n## IServ SSO Integration\n\n### IServ-Admin-Konfiguration\n\n1. **Verwaltung ‚Üí System ‚Üí Single-Sign-On**\n2. Neue OAuth-App erstellen:\n   - Name: `SportOase Buchungssystem`\n   - Vertrauensw√ºrdig: ‚úÖ Ja\n   - Redirect URI: `https://sportoase.app/oauth/callback`\n   - Scopes: `openid`, `profile`, `email`\n\n3. **Client-ID** und **Client-Secret** notieren\n4. Benutzergruppen berechtigen: Administrator, Lehrer, Mitarbeitende\n\n### OAuth-Endpunkte (IServ)\n\n```\nAuthorization: https://kgs-pattensen.de/iserv/oauth/v2/auth\nToken: https://kgs-pattensen.de/iserv/oauth/v2/token\nUserInfo: https://kgs-pattensen.de/iserv/public/oauth/userinfo\n```\n\n---\n\n## Projektstruktur\n\n```\n‚îú‚îÄ‚îÄ app.py                  # Haupt-Anwendung mit Routes\n‚îú‚îÄ‚îÄ config.py               # Konfiguration (Stundenplan, SMTP)\n‚îú‚îÄ‚îÄ models.py               # Datenbank-Modelle\n‚îú‚îÄ‚îÄ db_setup.py             # Datenbank-Initialisierung\n‚îú‚îÄ‚îÄ oauth_config.py         # IServ OAuth-Konfiguration\n‚îú‚îÄ‚îÄ email_service.py        # E-Mail-Versand (SMTP)\n‚îú‚îÄ‚îÄ templates/              # Jinja2 HTML-Templates\n‚îÇ   ‚îú‚îÄ‚îÄ base.html\n‚îÇ   ‚îú‚îÄ‚îÄ login.html\n‚îÇ   ‚îú‚îÄ‚îÄ dashboard.html\n‚îÇ   ‚îú‚îÄ‚îÄ book.html\n‚îÇ   ‚îú‚îÄ‚îÄ meine_buchungen.html\n‚îÇ   ‚îú‚îÄ‚îÄ admin.html\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ static/\n‚îÇ   ‚îú‚îÄ‚îÄ style.css\n‚îÇ   ‚îî‚îÄ‚îÄ logo-ers.png\n‚îú‚îÄ‚îÄ render.yaml             # Render Deployment Config\n‚îú‚îÄ‚îÄ requirements.txt        # Python Dependencies\n‚îî‚îÄ‚îÄ gunicorn_config.py      # Production Server Config\n```\n\n---\n\n## Anpassungen\n\n### Stundenplan √§ndern (`config.py`)\n\n```python\nPERIOD_TIMES = { ... }       # Zeiten der Schulstunden\nFIXED_OFFERS = { ... }       # Feste Angebote pro Wochentag\nFREE_MODULES = [ ... ]       # Module f√ºr freie Stunden\nMAX_STUDENTS_PER_PERIOD = 5  # Max. Sch√ºler pro Slot\nBOOKING_ADVANCE_MINUTES = 60 # Vorlaufzeit in Minuten\n```\n\n---\n\n## Troubleshooting\n\n### App startet nicht\n- Logs in Render Dashboard pr√ºfen\n- `DATABASE_URL` beginnt mit `postgresql://` (nicht `postgres://`)\n\n### IServ Login funktioniert nicht\n- Redirect URI in IServ korrekt: `https://sportoase.app/oauth/callback`\n- Client-ID und Client-Secret korrekt kopiert\n- `ISERV_DOMAIN` ohne `https://` (nur `kgs-pattensen.de`)\n\n### E-Mails werden nicht gesendet\n- Gmail App-Passwort verwenden (nicht normales Passwort)\n- 2FA in Gmail aktiviert\n\n### Datenbank-Fehler\n- `python db_setup.py` in Render Shell ausf√ºhren\n\n---\n\n## Technologie-Stack\n\n- **Backend**: Python 3.11, Flask, SQLAlchemy\n- **Datenbank**: PostgreSQL (Neon auf Render)\n- **Auth**: OAuth2/OpenID Connect (Authlib)\n- **Server**: Gunicorn\n- **Styling**: CSS mit Pink/Magenta-Theme (#E91E63)\n\n---\n\n## Support\n\n- **E-Mail**: morelli.maurizio@kgs-pattensen.de\n- **Telefon**: 0151 40349764\n","path":null,"size_bytes":5399,"size_tokens":null},"models.py":{"content":"# Datenbankmodelle f√ºr die SportOase-Anwendung mit Flask-SQLAlchemy\n# Diese Datei definiert die Struktur der Datenbank-Tabellen f√ºr PostgreSQL\n\nfrom werkzeug.security import generate_password_hash, check_password_hash\nfrom datetime import datetime\nimport json\nfrom database import db\n\nclass User(db.Model):\n    \"\"\"Benutzer-Modell f√ºr Lehrkr√§fte und Admins\"\"\"\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(64), unique=True, nullable=False, index=True)\n    email = db.Column(db.String(120), index=True)\n    password_hash = db.Column(db.String(256), nullable=True)\n    role = db.Column(db.String(20), nullable=False)\n    \n    bookings = db.relationship('Booking', backref='teacher', lazy=True)\n    \n    def set_password(self, password):\n        \"\"\"Setzt das Passwort (gehasht)\"\"\"\n        self.password_hash = generate_password_hash(password)\n    \n    def check_password(self, password):\n        \"\"\"√úberpr√ºft das Passwort\"\"\"\n        return check_password_hash(self.password_hash, password)\n    \n    def to_dict(self):\n        \"\"\"Konvertiert User zu Dictionary f√ºr Kompatibilit√§t\"\"\"\n        return {\n            'id': self.id,\n            'username': self.username,\n            'email': self.email,\n            'password_hash': self.password_hash,\n            'role': self.role\n        }\n\nclass Booking(db.Model):\n    \"\"\"Buchungs-Modell\"\"\"\n    __tablename__ = 'bookings'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    date = db.Column(db.String(10), nullable=False, index=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    teacher_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    teacher_name = db.Column(db.String(100))\n    teacher_class = db.Column(db.String(50))\n    students_json = db.Column(db.Text, nullable=False)\n    offer_type = db.Column(db.String(10), nullable=False)\n    offer_label = db.Column(db.String(100), nullable=False)\n    calendar_event_id = db.Column(db.String(200), nullable=True)\n    notes = db.Column(db.Text, nullable=True)\n    is_exclusive = db.Column(db.Boolean, default=False, nullable=False)\n    is_approved = db.Column(db.Boolean, default=True, nullable=False)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    notifications = db.relationship('Notification', back_populates='booking', cascade='all, delete-orphan', passive_deletes=True)\n    \n    def to_dict(self):\n        \"\"\"Konvertiert Booking zu Dictionary f√ºr Kompatibilit√§t\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date,\n            'weekday': self.weekday,\n            'period': self.period,\n            'teacher_id': self.teacher_id,\n            'teacher_name': self.teacher_name,\n            'teacher_class': self.teacher_class,\n            'students_json': self.students_json,\n            'offer_type': self.offer_type,\n            'offer_label': self.offer_label,\n            'calendar_event_id': self.calendar_event_id,\n            'notes': self.notes,\n            'is_exclusive': self.is_exclusive,\n            'is_approved': self.is_approved,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at,\n            'teacher_email': self.teacher.email if self.teacher else None\n        }\n\nclass SlotName(db.Model):\n    \"\"\"Modell f√ºr anpassbare Slot-Namen\"\"\"\n    __tablename__ = 'slot_names'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    label = db.Column(db.String(200), nullable=False)\n    \n    __table_args__ = (\n        db.UniqueConstraint('weekday', 'period', name='unique_weekday_period'),\n    )\n    \n    def to_dict(self):\n        \"\"\"Konvertiert SlotName zu Dictionary\"\"\"\n        return {\n            'id': self.id,\n            'weekday': self.weekday,\n            'period': self.period,\n            'label': self.label\n        }\n\nclass BlockedSlot(db.Model):\n    \"\"\"Modell f√ºr von Admins blockierte Slots (z.B. f√ºr Beratungsgespr√§che)\"\"\"\n    __tablename__ = 'blocked_slots'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    date = db.Column(db.String(10), nullable=False, index=True)\n    weekday = db.Column(db.String(3), nullable=False)\n    period = db.Column(db.Integer, nullable=False)\n    reason = db.Column(db.String(200), default='Beratung')\n    icon = db.Column(db.String(10), default='üîß')\n    blocked_by = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)\n    \n    __table_args__ = (\n        db.UniqueConstraint('date', 'period', name='unique_date_period_block'),\n    )\n    \n    def to_dict(self):\n        \"\"\"Konvertiert BlockedSlot zu Dictionary\"\"\"\n        return {\n            'id': self.id,\n            'date': self.date,\n            'weekday': self.weekday,\n            'period': self.period,\n            'reason': self.reason,\n            'icon': self.icon or 'üîß',\n            'blocked_by': self.blocked_by,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at\n        }\n\nclass Notification(db.Model):\n    \"\"\"Modell f√ºr Benachrichtigungen an Admins\"\"\"\n    __tablename__ = 'notifications'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    booking_id = db.Column(db.Integer, db.ForeignKey('bookings.id', ondelete='CASCADE'), nullable=False, index=True)\n    recipient_role = db.Column(db.String(20), nullable=False, default='admin')\n    notification_type = db.Column(db.String(50), nullable=False, default='new_booking')\n    message = db.Column(db.String(500), nullable=False)\n    is_read = db.Column(db.Boolean, default=False, nullable=False, index=True)\n    read_at = db.Column(db.DateTime, nullable=True)\n    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow, index=True)\n    metadata_json = db.Column(db.Text, nullable=True)\n    \n    booking = db.relationship('Booking', back_populates='notifications')\n    \n    def to_dict(self):\n        \"\"\"Konvertiert Notification zu Dictionary\"\"\"\n        metadata = None\n        if self.metadata_json:\n            try:\n                metadata = json.loads(self.metadata_json)\n            except:\n                metadata = None\n        \n        return {\n            'id': self.id,\n            'booking_id': self.booking_id,\n            'recipient_role': self.recipient_role,\n            'notification_type': self.notification_type,\n            'message': self.message,\n            'is_read': self.is_read,\n            'read_at': self.read_at.isoformat() if isinstance(self.read_at, datetime) else self.read_at,\n            'created_at': self.created_at.isoformat() if isinstance(self.created_at, datetime) else self.created_at,\n            'metadata': metadata,\n            'booking': self.booking.to_dict() if self.booking else None\n        }\n\n# Hilfsfunktionen f√ºr Kompatibilit√§t mit dem alten Code\n\ndef create_user(username, password, role, email=None):\n    \"\"\"Erstellt einen neuen Benutzer in der Datenbank\"\"\"\n    try:\n        user = User(username=username, email=email, role=role)\n        user.set_password(password)\n        db.session.add(user)\n        db.session.commit()\n        return user.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen des Benutzers: {e}\")\n        return None\n\ndef get_user_by_username(username):\n    \"\"\"Sucht einen Benutzer anhand des Benutzernamens\"\"\"\n    user = User.query.filter_by(username=username).first()\n    return user.to_dict() if user else None\n\ndef get_user_by_email(email):\n    \"\"\"Sucht einen Benutzer anhand der E-Mail-Adresse\"\"\"\n    user = User.query.filter_by(email=email).first()\n    return user.to_dict() if user else None\n\ndef get_or_create_oauth_user(email, username, oauth_provider, oauth_id, role='teacher'):\n    \"\"\"Erstellt oder aktualisiert einen Benutzer basierend auf E-Mail (IServ SSO)\"\"\"\n    try:\n        # Suche nach E-Mail\n        user = User.query.filter_by(email=email).first()\n        \n        if user:\n            # Benutzer existiert, aktualisiere Rolle falls n√∂tig\n            user.role = role\n            print(f\"‚úÖ Benutzer gefunden und aktualisiert: {email} (ID: {user.id}, Rolle: {role})\")\n        else:\n            # Neuen Benutzer erstellen mit Dummy-Passwort-Hash (f√ºr OAuth-Benutzer)\n            user = User(\n                username=email,\n                email=email,\n                role=role\n            )\n            # Setze einen Dummy-Hash f√ºr OAuth-Benutzer (wird nie verwendet)\n            user.password_hash = generate_password_hash('oauth_user_no_password')\n            db.session.add(user)\n            print(f\"‚úÖ Neuer Benutzer erstellt: {email} (Rolle: {role})\")\n        \n        db.session.commit()\n        return user.to_dict()\n    except Exception as e:\n        db.session.rollback()\n        print(f\"‚ùå FEHLER beim Erstellen/Aktualisieren des Benutzers: {e}\")\n        print(f\"   E-Mail: {email}\")\n        import traceback\n        traceback.print_exc()\n        return None\n\ndef get_user_by_id(user_id):\n    \"\"\"Sucht einen Benutzer anhand der ID\"\"\"\n    user = User.query.get(user_id)\n    return user.to_dict() if user else None\n\ndef verify_password(user_dict, password):\n    \"\"\"√úberpr√ºft, ob das eingegebene Passwort korrekt ist\"\"\"\n    user = User.query.get(user_dict['id'])\n    return user.check_password(password) if user else False\n\ndef change_user_password(user_id, old_password, new_password):\n    \"\"\"√Ñndert das Passwort eines Benutzers\"\"\"\n    try:\n        user = User.query.get(user_id)\n        if not user:\n            return {'success': False, 'error': 'Benutzer nicht gefunden'}\n        \n        if not user.check_password(old_password):\n            return {'success': False, 'error': 'Altes Passwort ist falsch'}\n        \n        user.set_password(new_password)\n        db.session.commit()\n        return {'success': True, 'message': 'Passwort erfolgreich ge√§ndert'}\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim √Ñndern des Passworts: {e}\")\n        return {'success': False, 'error': 'Fehler beim √Ñndern des Passworts'}\n\ndef get_all_users():\n    \"\"\"Gibt alle Benutzer zur√ºck (f√ºr Admin-Ansicht)\"\"\"\n    users = User.query.order_by(User.role, User.username).all()\n    return [u.to_dict() for u in users]\n\ndef create_booking(date, weekday, period, teacher_id, students, offer_type, offer_label, teacher_name=None, teacher_class=None, calendar_event_id=None, notes=None, is_exclusive=False):\n    \"\"\"Erstellt eine neue Buchung in der Datenbank\"\"\"\n    try:\n        students_json = json.dumps(students, ensure_ascii=False)\n        booking = Booking(\n            date=date,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class,\n            students_json=students_json,\n            offer_type=offer_type,\n            offer_label=offer_label,\n            calendar_event_id=calendar_event_id,\n            notes=notes,\n            is_exclusive=is_exclusive,\n            is_approved=not is_exclusive,\n            created_at=datetime.now()\n        )\n        db.session.add(booking)\n        db.session.commit()\n        return booking.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen der Buchung: {e}\")\n        return None\n\ndef get_bookings_for_date_period(date, period):\n    \"\"\"Gibt alle Buchungen f√ºr ein bestimmtes Datum und Stunde zur√ºck\"\"\"\n    bookings = Booking.query.filter_by(date=date, period=period).order_by(Booking.created_at).all()\n    return [b.to_dict() for b in bookings]\n\ndef count_students_for_period(date, period):\n    \"\"\"Z√§hlt die Gesamtzahl der Sch√ºler f√ºr eine bestimmte Stunde\"\"\"\n    bookings = get_bookings_for_date_period(date, period)\n    total = 0\n    for booking in bookings:\n        students = json.loads(booking['students_json'])\n        total += len(students)\n    return total\n\ndef check_student_double_booking(student_name, student_class, date, period, exclude_booking_id=None):\n    \"\"\"\n    Pr√ºft, ob ein Sch√ºler bereits f√ºr dieses Datum und diese Stunde gebucht ist.\n    \n    Args:\n        student_name: Name des Sch√ºlers\n        student_class: Klasse des Sch√ºlers\n        date: Datum (YYYY-MM-DD)\n        period: Stunde (1-6)\n        exclude_booking_id: Optional - Buchungs-ID die ausgeschlossen werden soll (f√ºr Updates)\n    \n    Returns:\n        Dict mit 'is_booked' (bool) und 'booking_info' (str) oder None\n    \"\"\"\n    bookings = get_bookings_for_date_period(date, period)\n    \n    for booking in bookings:\n        # √úberspringe die Buchung, die ausgeschlossen werden soll\n        if exclude_booking_id and booking['id'] == exclude_booking_id:\n            continue\n            \n        students = json.loads(booking['students_json'])\n        \n        # Pr√ºfe ob der Sch√ºler in dieser Buchung ist\n        for student in students:\n            if (student.get('name', '').strip().lower() == student_name.strip().lower() and \n                student.get('klasse', '').strip().lower() == student_class.strip().lower()):\n                \n                return {\n                    'is_booked': True,\n                    'booking_info': f\"{student_name} ({student_class}) ist bereits in '{booking['offer_label']}' bei {booking['teacher_name']} gebucht.\"\n                }\n    \n    return {'is_booked': False, 'booking_info': None}\n\ndef get_all_bookings():\n    \"\"\"Gibt alle Buchungen zur√ºck (f√ºr Admin-Ansicht)\"\"\"\n    bookings = Booking.query.order_by(Booking.date.desc(), Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_bookings_by_date(date):\n    \"\"\"Gibt alle Buchungen f√ºr ein bestimmtes Datum zur√ºck\"\"\"\n    bookings = Booking.query.filter_by(date=date).order_by(Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_bookings_for_week(start_date, end_date):\n    \"\"\"Gibt alle Buchungen f√ºr eine Woche zur√ºck\"\"\"\n    bookings = Booking.query.filter(Booking.date >= start_date, Booking.date <= end_date).order_by(Booking.date, Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef get_booking_by_id(booking_id):\n    \"\"\"Gibt eine einzelne Buchung anhand der ID zur√ºck\"\"\"\n    booking = Booking.query.get(booking_id)\n    return booking.to_dict() if booking else None\n\ndef get_exclusive_booking_for_date_period(date, period):\n    \"\"\"Pr√ºft ob eine genehmigte exklusive Buchung f√ºr diesen Slot existiert\"\"\"\n    booking = Booking.query.filter_by(\n        date=date, \n        period=period, \n        is_exclusive=True, \n        is_approved=True\n    ).first()\n    return booking.to_dict() if booking else None\n\ndef get_pending_exclusive_bookings():\n    \"\"\"Gibt alle exklusiven Buchungen zur√ºck, die noch auf Freigabe warten\"\"\"\n    bookings = Booking.query.filter_by(\n        is_exclusive=True, \n        is_approved=False\n    ).order_by(Booking.date, Booking.period).all()\n    return [b.to_dict() for b in bookings]\n\ndef approve_exclusive_booking(booking_id):\n    \"\"\"Genehmigt eine exklusive Buchung\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        booking.is_approved = True\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Genehmigen der Buchung: {e}\")\n        return False\n\ndef reject_exclusive_booking(booking_id):\n    \"\"\"Lehnt eine exklusive Buchung ab (l√∂scht sie)\"\"\"\n    return delete_booking(booking_id)\n\ndef update_booking(booking_id, date, weekday, period, teacher_id, students, offer_type, offer_label, teacher_name=None, teacher_class=None, notes=None):\n    \"\"\"Aktualisiert eine bestehende Buchung in der Datenbank\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        booking.date = date\n        booking.weekday = weekday\n        booking.period = period\n        booking.teacher_id = teacher_id\n        booking.teacher_name = teacher_name\n        booking.teacher_class = teacher_class\n        booking.students_json = json.dumps(students, ensure_ascii=False)\n        booking.offer_type = offer_type\n        booking.offer_label = offer_label\n        booking.notes = notes\n        \n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Aktualisieren der Buchung: {e}\")\n        return False\n\ndef delete_booking(booking_id, delete_calendar_event_callback=None):\n    \"\"\"L√∂scht eine Buchung aus der Datenbank und optional den Google Calendar Eintrag\"\"\"\n    try:\n        booking = Booking.query.get(booking_id)\n        if not booking:\n            return False\n        \n        # Wenn Callback f√ºr Calendar-L√∂schung √ºbergeben wurde, nutze ihn\n        if delete_calendar_event_callback and booking.calendar_event_id:\n            try:\n                delete_calendar_event_callback(booking.calendar_event_id)\n            except Exception as e:\n                print(f\"Warnung: Calendar Eintrag konnte nicht gel√∂scht werden: {e}\")\n        \n        db.session.delete(booking)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim L√∂schen der Buchung: {e}\")\n        return False\n\ndef get_custom_slot_name(weekday, period):\n    \"\"\"Gibt den angepassten Slot-Namen aus der Datenbank zur√ºck\"\"\"\n    slot = SlotName.query.filter_by(weekday=weekday, period=period).first()\n    return slot.label if slot else None\n\ndef update_slot_name(weekday, period, label):\n    \"\"\"Aktualisiert oder erstellt einen angepassten Slot-Namen\"\"\"\n    try:\n        slot = SlotName.query.filter_by(weekday=weekday, period=period).first()\n        if slot:\n            slot.label = label\n        else:\n            slot = SlotName(weekday=weekday, period=period, label=label)\n            db.session.add(slot)\n        \n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Aktualisieren des Slot-Namens: {e}\")\n        return False\n\ndef get_all_custom_slot_names():\n    \"\"\"Gibt alle angepassten Slot-Namen zur√ºck\"\"\"\n    slots = SlotName.query.all()\n    return [s.to_dict() for s in slots]\n\ndef is_slot_blocked(date, period):\n    \"\"\"Pr√ºft, ob ein Slot f√ºr ein bestimmtes Datum und Stunde blockiert ist\"\"\"\n    blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n    return blocked is not None\n\ndef get_blocked_slot(date, period):\n    \"\"\"Gibt den blockierten Slot zur√ºck, falls vorhanden\"\"\"\n    blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n    return blocked.to_dict() if blocked else None\n\ndef block_slot(date, weekday, period, admin_id, reason='Beratung', icon='üîß'):\n    \"\"\"Blockiert einen Slot f√ºr Beratungsgespr√§che (nur Admin)\"\"\"\n    try:\n        if is_slot_blocked(date, period):\n            return False\n        \n        blocked = BlockedSlot(\n            date=date,\n            weekday=weekday,\n            period=period,\n            reason=reason,\n            icon=icon,\n            blocked_by=admin_id,\n            created_at=datetime.now()\n        )\n        db.session.add(blocked)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Blockieren des Slots: {e}\")\n        return False\n\ndef unblock_slot(date, period):\n    \"\"\"Gibt einen blockierten Slot wieder frei\"\"\"\n    try:\n        blocked = BlockedSlot.query.filter_by(date=date, period=period).first()\n        if not blocked:\n            return False\n        \n        db.session.delete(blocked)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Freigeben des Slots: {e}\")\n        return False\n\ndef get_blocked_slots_for_date(date):\n    \"\"\"Gibt alle blockierten Slots f√ºr ein bestimmtes Datum zur√ºck\"\"\"\n    blocked_slots = BlockedSlot.query.filter_by(date=date).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef get_blocked_slots_for_week(start_date, end_date):\n    \"\"\"Gibt alle blockierten Slots f√ºr eine Woche zur√ºck\"\"\"\n    blocked_slots = BlockedSlot.query.filter(BlockedSlot.date >= start_date, BlockedSlot.date <= end_date).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef get_all_blocked_slots():\n    \"\"\"Gibt alle blockierten Slots zur√ºck (f√ºr Admin-Ansicht)\"\"\"\n    blocked_slots = BlockedSlot.query.order_by(BlockedSlot.date.desc(), BlockedSlot.period).all()\n    return [b.to_dict() for b in blocked_slots]\n\ndef bulk_block_slots(start_date, end_date, admin_id, reason='Ferien', periods=None, icon=None):\n    \"\"\"\n    Blockiert alle Slots in einem Zeitraum (z.B. f√ºr Ferien).\n    \n    Args:\n        start_date: Startdatum (YYYY-MM-DD String)\n        end_date: Enddatum (YYYY-MM-DD String)\n        admin_id: ID des Admins der die Sperrung durchf√ºhrt\n        reason: Grund f√ºr die Sperrung\n        periods: Liste der Stunden (1-6), None = alle Stunden\n        icon: Emoji-Icon f√ºr die Blockierung (optional)\n    \n    Returns:\n        Dict mit 'success', 'blocked_count', 'skipped_count'\n    \"\"\"\n    from datetime import datetime, timedelta\n    \n    # Icon aus reason extrahieren, falls nicht explizit angegeben\n    if icon is None and reason:\n        first_char = reason[0] if reason else ''\n        if ord(first_char) > 127:\n            icon = first_char\n        else:\n            icon = 'üîß'\n    \n    try:\n        start = datetime.strptime(start_date, '%Y-%m-%d')\n        end = datetime.strptime(end_date, '%Y-%m-%d')\n        \n        if periods is None:\n            periods = [1, 2, 3, 4, 5, 6]\n        \n        weekday_map = {0: 'Mon', 1: 'Tue', 2: 'Wed', 3: 'Thu', 4: 'Fri', 5: 'Sat', 6: 'Sun'}\n        blocked_count = 0\n        skipped_count = 0\n        \n        current = start\n        while current <= end:\n            # Nur Wochentage (Montag-Freitag)\n            if current.weekday() < 5:\n                date_str = current.strftime('%Y-%m-%d')\n                weekday = weekday_map[current.weekday()]\n                \n                for period in periods:\n                    # Pr√ºfe ob bereits blockiert\n                    if not is_slot_blocked(date_str, period):\n                        blocked = BlockedSlot(\n                            date=date_str,\n                            weekday=weekday,\n                            period=period,\n                            reason=reason,\n                            icon=icon,\n                            blocked_by=admin_id,\n                            created_at=datetime.now()\n                        )\n                        db.session.add(blocked)\n                        blocked_count += 1\n                    else:\n                        skipped_count += 1\n            \n            current += timedelta(days=1)\n        \n        db.session.commit()\n        return {'success': True, 'blocked_count': blocked_count, 'skipped_count': skipped_count}\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Bulk-Blockieren: {e}\")\n        return {'success': False, 'error': str(e), 'blocked_count': 0, 'skipped_count': 0}\n\ndef bulk_unblock_slots(start_date, end_date, periods=None):\n    \"\"\"\n    Gibt alle blockierten Slots in einem Zeitraum wieder frei.\n    \n    Args:\n        start_date: Startdatum (YYYY-MM-DD String)\n        end_date: Enddatum (YYYY-MM-DD String)\n        periods: Liste der Stunden (1-6), None = alle Stunden\n    \n    Returns:\n        Dict mit 'success', 'unblocked_count'\n    \"\"\"\n    try:\n        query = BlockedSlot.query.filter(\n            BlockedSlot.date >= start_date,\n            BlockedSlot.date <= end_date\n        )\n        \n        if periods:\n            query = query.filter(BlockedSlot.period.in_(periods))\n        \n        blocked_slots = query.all()\n        unblocked_count = len(blocked_slots)\n        \n        for slot in blocked_slots:\n            db.session.delete(slot)\n        \n        db.session.commit()\n        return {'success': True, 'unblocked_count': unblocked_count}\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Bulk-Freigeben: {e}\")\n        return {'success': False, 'error': str(e), 'unblocked_count': 0}\n\ndef create_notification(booking_id, message, notification_type='new_booking', recipient_role='admin', metadata=None):\n    \"\"\"Erstellt eine neue Benachrichtigung\"\"\"\n    try:\n        metadata_json = json.dumps(metadata, ensure_ascii=False) if metadata else None\n        notification = Notification(\n            booking_id=booking_id,\n            recipient_role=recipient_role,\n            notification_type=notification_type,\n            message=message,\n            metadata_json=metadata_json,\n            is_read=False,\n            created_at=datetime.now()\n        )\n        db.session.add(notification)\n        db.session.commit()\n        return notification.id\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Erstellen der Benachrichtigung: {e}\")\n        return None\n\ndef get_unread_notifications(recipient_role='admin'):\n    \"\"\"Gibt alle ungelesenen Benachrichtigungen zur√ºck\"\"\"\n    notifications = Notification.query.filter_by(recipient_role=recipient_role, is_read=False).order_by(Notification.created_at.desc()).all()\n    return [n.to_dict() for n in notifications]\n\ndef get_recent_notifications(recipient_role='admin', limit=10):\n    \"\"\"Gibt die neuesten Benachrichtigungen zur√ºck (gelesen und ungelesen)\"\"\"\n    notifications = Notification.query.filter_by(recipient_role=recipient_role).order_by(Notification.created_at.desc()).limit(limit).all()\n    return [n.to_dict() for n in notifications]\n\ndef mark_notification_as_read(notification_id):\n    \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n    try:\n        notification = Notification.query.get(notification_id)\n        if not notification:\n            return False\n        notification.is_read = True\n        notification.read_at = datetime.now()\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Markieren der Benachrichtigung: {e}\")\n        return False\n\ndef mark_all_notifications_as_read(recipient_role='admin'):\n    \"\"\"Markiert alle Benachrichtigungen als gelesen\"\"\"\n    try:\n        notifications = Notification.query.filter_by(recipient_role=recipient_role, is_read=False).all()\n        for notification in notifications:\n            notification.is_read = True\n            notification.read_at = datetime.now()\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim Markieren aller Benachrichtigungen: {e}\")\n        return False\n\ndef get_unread_notification_count(recipient_role='admin'):\n    \"\"\"Gibt die Anzahl der ungelesenen Benachrichtigungen zur√ºck\"\"\"\n    return Notification.query.filter_by(recipient_role=recipient_role, is_read=False).count()\n\ndef delete_notification(notification_id):\n    \"\"\"L√∂scht eine Benachrichtigung\"\"\"\n    try:\n        notification = Notification.query.get(notification_id)\n        if not notification:\n            return False\n        db.session.delete(notification)\n        db.session.commit()\n        return True\n    except Exception as e:\n        db.session.rollback()\n        print(f\"Fehler beim L√∂schen der Benachrichtigung: {e}\")\n        return False\n","path":null,"size_bytes":27660,"size_tokens":null},"app.py":{"content":"# Haupt-Anwendungsdatei f√ºr die SportOase-Buchungssystem\n# Diese Datei enth√§lt alle Routen (URLs) und die Logik der Webanwendung\n\nfrom flask import Flask, render_template, request, redirect, url_for, session, flash, Response, jsonify\nfrom datetime import datetime, timedelta, date\nfrom werkzeug.middleware.proxy_fix import ProxyFix\nimport pytz\nimport json\nimport os\nimport queue\nimport threading\n\n# Flask-App erstellen\napp = Flask(__name__)\n\n# Session-Secret aus Umgebungsvariable (MUSS gesetzt sein!)\nsession_secret = os.environ.get('SESSION_SECRET')\nif not session_secret:\n    raise RuntimeError(\n        \"SESSION_SECRET Umgebungsvariable ist nicht gesetzt! \"\n        \"Bitte setzen Sie einen sicheren, zuf√§lligen Wert in Replit Secrets.\"\n    )\napp.secret_key = session_secret\napp.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)\n\n# Cookie-Einstellungen f√ºr iFrame-Kompatibilit√§t (IServ Embed)\napp.config['SESSION_COOKIE_SAMESITE'] = 'None'\napp.config['SESSION_COOKIE_SECURE'] = True\n\n@app.after_request\ndef add_iframe_headers(response):\n    \"\"\"Erlaubt Einbettung in IServ iFrame\"\"\"\n    # Erlaube Einbettung von kgs-pattensen.de\n    response.headers['X-Frame-Options'] = 'ALLOW-FROM https://kgs-pattensen.de'\n    response.headers['Content-Security-Policy'] = \"frame-ancestors 'self' https://kgs-pattensen.de\"\n    return response\n\n# SSE Broadcaster f√ºr Echtzeit-Benachrichtigungen\nnotification_subscribers = []\nsubscribers_lock = threading.Lock()\n\ndef broadcast_notification(notification_data):\n    \"\"\"Sendet eine Benachrichtigung an alle verbundenen SSE-Clients\"\"\"\n    with subscribers_lock:\n        dead_queues = []\n        for q in notification_subscribers:\n            try:\n                q.put_nowait(notification_data)\n            except queue.Full:\n                dead_queues.append(q)\n        \n        for q in dead_queues:\n            notification_subscribers.remove(q)\n\n# CSRF-Token Generierung und Validierung\nimport secrets\n\ndef generate_csrf_token():\n    \"\"\"Generiert ein CSRF-Token und speichert es in der Session\"\"\"\n    if 'csrf_token' not in session:\n        session['csrf_token'] = secrets.token_hex(32)\n    return session['csrf_token']\n\ndef validate_csrf_token(token):\n    \"\"\"Validiert das CSRF-Token\"\"\"\n    return token == session.get('csrf_token')\n\n@app.context_processor\ndef inject_csrf_token():\n    \"\"\"Macht csrf_token in allen Templates verf√ºgbar\"\"\"\n    return dict(csrf_token=generate_csrf_token())\n\n# Datenbank-Konfiguration\ndb_uri = os.environ.get(\"DATABASE_URL\") or os.environ.get(\"SQLALCHEMY_DATABASE_URI\")\n\n# Strip whitespace from database URL (in case of accidental spaces)\nif db_uri:\n    db_uri = db_uri.strip()\n\nif not db_uri:\n    raise RuntimeError(\n        \"Keine DB-URL gefunden. Bitte DATABASE_URL \"\n        \"oder SQLALCHEMY_DATABASE_URI setzen.\"\n    )\n\napp.config[\"SQLALCHEMY_DATABASE_URI\"] = db_uri\napp.config[\"SQLALCHEMY_ENGINE_OPTIONS\"] = {\n    \"pool_recycle\": 300,\n    \"pool_pre_ping\": True,\n}\napp.config[\"SQLALCHEMY_TRACK_MODIFICATIONS\"] = False\n\n# Importiere zentrale Datenbank-Instanz\nfrom database import db\n\n# Initialisiere SQLAlchemy mit der App\ndb.init_app(app)\n\n# Importiere Modelle und Hilfsfunktionen\nfrom models import (\n    create_user, get_user_by_username, get_user_by_email, \n    get_user_by_id, verify_password, get_all_users, create_booking,\n    get_bookings_for_date_period, count_students_for_period, get_all_bookings,\n    get_bookings_by_date, get_bookings_for_week, get_booking_by_id,\n    update_booking, delete_booking, User, Booking,\n    create_notification, get_unread_notifications, get_recent_notifications,\n    mark_notification_as_read, mark_all_notifications_as_read,\n    get_unread_notification_count, get_booking_by_id, check_student_double_booking,\n    change_user_password, get_or_create_oauth_user\n)\nfrom config import *\nfrom email_service import send_booking_notification\n\n# IServ OAuth-Integration initialisieren\nfrom oauth_config import init_oauth, determine_user_role\noauth_instance, iserv_client = init_oauth(app)\n\n# Schema-Erstellung erfolgt explizit √ºber db_setup.py\n# Nicht automatisch bei jedem Import!\n\n# Hilfsfunktion: Zeitzone Europe/Berlin\ndef get_berlin_tz():\n    \"\"\"Gibt die Zeitzone Europe/Berlin zur√ºck\"\"\"\n    return pytz.timezone('Europe/Berlin')\n\n# Hilfsfunktion: Pr√ºft, ob Benutzer eingeloggt ist\ndef login_required(f):\n    \"\"\"Decorator-Funktion: Sch√ºtzt Routen, sodass nur eingeloggte Benutzer darauf zugreifen k√∂nnen\"\"\"\n    from functools import wraps\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Bitte melden Sie sich an.', 'error')\n            return redirect(url_for('login'))\n        return f(*args, **kwargs)\n    return decorated_function\n\n# Hilfsfunktion: Pr√ºft, ob Benutzer Admin ist\ndef admin_required(f):\n    \"\"\"Decorator-Funktion: Sch√ºtzt Routen, sodass nur Admins darauf zugreifen k√∂nnen\"\"\"\n    from functools import wraps\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        if 'user_id' not in session:\n            flash('Bitte melden Sie sich an.', 'error')\n            return redirect(url_for('login'))\n        user = get_user_by_id(session['user_id'])\n        if not user or user['role'] != 'admin':\n            flash('Zugriff verweigert. Nur Admins haben Zugriff.', 'error')\n            return redirect(url_for('dashboard'))\n        return f(*args, **kwargs)\n    return decorated_function\n\n# Hilfsfunktion: Gibt Informationen √ºber eine Stunde zur√ºck\ndef get_period_info(weekday, period):\n    \"\"\"\n    Gibt Informationen √ºber eine Stunde zur√ºck (fest/frei, Bezeichnung)\n    weekday: z.B. \"Mon\", \"Tue\", ...\n    period: 1-6\n    \"\"\"\n    from models import get_custom_slot_name\n    \n    if weekday in FIXED_OFFERS and period in FIXED_OFFERS[weekday]:\n        custom_label = get_custom_slot_name(weekday, period)\n        label = custom_label if custom_label else FIXED_OFFERS[weekday][period]\n        return {\n            'type': 'fest',\n            'label': label\n        }\n    else:\n        return {\n            'type': 'frei',\n            'label': 'Freie Wahl'\n        }\n\n# Hilfsfunktion: Pr√ºft, ob ein Datum in der Vergangenheit liegt\ndef is_past_date(check_date, period=None):\n    \"\"\"\n    Pr√ºft, ob ein Datum (und optional eine Stunde) in der Vergangenheit liegt\n    \"\"\"\n    berlin_tz = get_berlin_tz()\n    now = datetime.now(berlin_tz)\n    \n    if period is not None:\n        # Pr√ºfe mit spezifischer Stunde\n        period_start_time = PERIOD_TIMES[period]['start']\n        hour, minute = map(int, period_start_time.split(':'))\n        period_datetime = berlin_tz.localize(\n            datetime.combine(check_date, datetime.min.time()).replace(hour=hour, minute=minute)\n        )\n        return period_datetime < now\n    else:\n        # Pr√ºfe nur Datum\n        today = now.date()\n        return check_date < today\n\n# Hilfsfunktion: Pr√ºft, ob eine Buchung zeitlich m√∂glich ist\ndef check_booking_time(booking_date, period):\n    \"\"\"\n    Pr√ºft, ob die Buchung mindestens 60 Minuten in der Zukunft liegt\n    Gibt (True, None) zur√ºck wenn OK, sonst (False, Fehlermeldung)\n    \"\"\"\n    berlin_tz = get_berlin_tz()\n    now = datetime.now(berlin_tz)\n    \n    # Erstelle Datetime-Objekt f√ºr den Stundenbeginn\n    period_start_time = PERIOD_TIMES[period]['start']\n    hour, minute = map(int, period_start_time.split(':'))\n    \n    # Kombiniere Datum und Zeit\n    period_datetime = berlin_tz.localize(\n        datetime.combine(booking_date, datetime.min.time()).replace(hour=hour, minute=minute)\n    )\n    \n    # Berechne Zeitdifferenz\n    time_diff = period_datetime - now\n    \n    if time_diff.total_seconds() < BOOKING_ADVANCE_MINUTES * 60:\n        return False, f\"Buchungen sind nur bis {BOOKING_ADVANCE_MINUTES} Minuten vor Stundenbeginn m√∂glich.\"\n    \n    return True, None\n\n# Route: Startseite (leitet direkt zu IServ weiter)\n@app.route('/')\ndef index():\n    \"\"\"Startseite - leitet zum Dashboard oder IServ-Login weiter\"\"\"\n    if 'user_id' in session:\n        return redirect(url_for('dashboard'))\n    return redirect(url_for('login_iserv'))\n\n# Route: Direkter IServ-Embed Login (f√ºr iFrame-Integration)\n@app.route('/iserv/embed')\ndef iserv_embed_login():\n    \"\"\"\n    Direkter Login f√ºr IServ-Embed (iFrame) Integration.\n    IServ sendet Benutzer-Informationen √ºber URL-Parameter:\n    - %user% ‚Üí user Parameter\n    - %email% ‚Üí email Parameter\n    - %domain% ‚Üí domain Parameter (zur Verifizierung)\n    \n    Sicherheit:\n    - Nur @kgs-pattensen.de E-Mails\n    - Nur bereits registrierte Benutzer (neue m√ºssen OAuth nutzen)\n    - Zus√§tzliche Token-Validierung √ºber ISERV_EMBED_SECRET\n    \"\"\"\n    import hmac\n    import hashlib\n    import time\n    \n    user = request.args.get('user', '').strip()\n    email = request.args.get('email', '').strip().lower()\n    domain = request.args.get('domain', '').strip().lower()\n    token = request.args.get('token', '').strip()\n    timestamp = request.args.get('ts', '').strip()\n    \n    # Debug-Log\n    print(f\"üîê IServ Embed Versuch: user={user}, email={email}, domain={domain}\")\n    \n    # Pr√ºfe ob alle Parameter vorhanden sind\n    if not user or not email:\n        flash('Ung√ºltige IServ-Anmeldung.', 'error')\n        return render_template('login.html')\n    \n    # Pr√ºfe ob E-Mail zur Schule geh√∂rt (wichtigste Sicherheitspr√ºfung)\n    if not email.endswith('@kgs-pattensen.de'):\n        flash('Nur @kgs-pattensen.de E-Mail-Adressen sind erlaubt.', 'error')\n        return render_template('login.html')\n    \n    # Optional: HMAC-Token Validierung (wenn ISERV_EMBED_SECRET gesetzt ist)\n    embed_secret = os.environ.get('ISERV_EMBED_SECRET')\n    if embed_secret:\n        # Wenn Secret konfiguriert, muss Token g√ºltig sein\n        if not token or not timestamp:\n            print(f\"‚ö†Ô∏è IServ Embed: Token fehlt f√ºr {email}\")\n            flash('Ung√ºltige Anmeldung (Token fehlt).', 'error')\n            return render_template('login.html')\n        \n        # Pr√ºfe Zeitstempel (max 5 Minuten alt)\n        try:\n            ts = int(timestamp)\n            if abs(time.time() - ts) > 300:\n                print(f\"‚ö†Ô∏è IServ Embed: Token abgelaufen f√ºr {email}\")\n                flash('Anmeldung abgelaufen. Bitte erneut versuchen.', 'error')\n                return render_template('login.html')\n        except ValueError:\n            flash('Ung√ºltige Anmeldung.', 'error')\n            return render_template('login.html')\n        \n        # Validiere HMAC\n        expected = hmac.new(\n            embed_secret.encode(),\n            f\"{email}:{timestamp}\".encode(),\n            hashlib.sha256\n        ).hexdigest()\n        \n        if not hmac.compare_digest(token, expected):\n            print(f\"‚ö†Ô∏è IServ Embed: Ung√ºltiger Token f√ºr {email}\")\n            flash('Ung√ºltige Anmeldung.', 'error')\n            return render_template('login.html')\n    \n    # Hole bestehenden Benutzer aus der Datenbank\n    existing_user = get_user_by_email(email)\n    \n    if existing_user:\n        # Benutzer existiert bereits - direkt einloggen\n        session['user_id'] = existing_user['id']\n        session['user_username'] = existing_user['username']\n        session['user_email'] = existing_user['email']\n        session['user_role'] = existing_user['role']\n        \n        print(f\"üîê IServ Embed Login: {email} (bestehender Benutzer)\")\n        return redirect(url_for('dashboard'))\n    else:\n        # Neuer Benutzer - muss sich erst √ºber OAuth registrieren\n        flash('Bitte melden Sie sich einmalig √ºber \"Mit IServ anmelden\" an.', 'info')\n        return render_template('login.html')\n\n# Route: Login-Seite (nur IServ-Button)\n@app.route('/login')\ndef login():\n    \"\"\"Login-Seite - zeigt nur IServ-Login-Button\"\"\"\n    return render_template('login.html')\n\n# Route: IServ SSO Login initiieren\n@app.route('/login/iserv')\ndef login_iserv():\n    \"\"\"Startet den IServ OAuth2-Login-Flow\"\"\"\n    if not iserv_client:\n        flash('IServ-Login ist nicht konfiguriert.', 'error')\n        return redirect(url_for('login'))\n    \n    redirect_uri = url_for('oauth_callback', _external=True)\n    return iserv_client.authorize_redirect(redirect_uri)\n\n# Route: OAuth Callback von IServ\n@app.route('/oauth/callback')\ndef oauth_callback():\n    \"\"\"Callback-Route f√ºr IServ OAuth2\"\"\"\n    if not iserv_client:\n        flash('IServ-Login ist nicht konfiguriert.', 'error')\n        return redirect(url_for('login'))\n    \n    try:\n        token = iserv_client.authorize_access_token()\n        userinfo = token.get('userinfo')\n        \n        if not userinfo:\n            userinfo = iserv_client.userinfo(token=token)\n        \n        email = userinfo.get('email')\n        sub = userinfo.get('sub')\n        name = userinfo.get('name', email)\n        \n        if not email or not sub:\n            flash('Fehler beim Abrufen der Benutzerdaten von IServ.', 'error')\n            return redirect(url_for('login'))\n        \n        # determine_user_role gibt jetzt (role, iserv_group) zur√ºck\n        role, iserv_group = determine_user_role(userinfo)\n        \n        # Log OAuth-Daten f√ºr Debugging\n        print(f\"üîê IServ Login: {email}\")\n        print(f\"   Sub-ID: {sub}\")\n        print(f\"   Rolle: {role}\")\n        print(f\"   IServ-Gruppe: {iserv_group}\")\n        print(f\"   UserInfo: {userinfo}\")\n        \n        # Pr√ºfe ob Benutzer Zugang hat (nur Lehrer, Mitarbeitende, Administrator)\n        if role is None:\n            flash('Kein Zugang. Nur Lehrer und Mitarbeitende k√∂nnen sich anmelden.', 'error')\n            print(f\"‚ùå Zugang verweigert f√ºr: {email} (keine berechtigte Gruppe)\")\n            return redirect(url_for('login'))\n        \n        # Verwende E-Mail direkt als Username f√ºr OAuth-Benutzer\n        user = get_or_create_oauth_user(\n            email=email,\n            username=email,  # E-Mail als Username (vermeidet Unique-Constraint-Fehler)\n            oauth_provider='iserv',\n            oauth_id=sub,\n            role=role\n        )\n        \n        if not user:\n            flash('Fehler beim Erstellen des Benutzers.', 'error')\n            return redirect(url_for('login'))\n        \n        # WICHTIG: Session komplett leeren, um OAuth-Token/userinfo zu entfernen\n        # Authlib speichert gro√üe Datenmengen in der Session, die das Cookie-Limit √ºberschreiten\n        session.clear()\n        \n        # Nur die wesentlichen Benutzerdaten speichern\n        session['user_id'] = user['id']\n        session['user_username'] = user['username']\n        session['user_email'] = user['email']\n        session['user_role'] = user['role']\n        \n        flash(f'Willkommen, {name}!', 'success')\n        return redirect(url_for('dashboard'))\n        \n    except Exception as e:\n        print(f\"OAuth Fehler: {e}\")\n        flash('Fehler beim IServ-Login. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(url_for('login'))\n\n# Route: Logout\n@app.route('/logout')\ndef logout():\n    \"\"\"Meldet den Benutzer ab\"\"\"\n    session.clear()\n    flash('Sie wurden abgemeldet.', 'info')\n    return redirect(url_for('login'))\n\n# Route: OAuth Debug - Zeigt Rollen/Gruppen-Daten von IServ\n@app.route('/oauth/debug')\ndef oauth_debug():\n    \"\"\"\n    Debug-Route: Zeigt die OAuth-Daten von IServ (nur f√ºr Admins sichtbar).\n    N√ºtzlich um zu sehen, welche Rollen/Gruppen IServ √ºbergibt.\n    \"\"\"\n    if 'user_id' not in session:\n        flash('Bitte melden Sie sich an.', 'error')\n        return redirect(url_for('login'))\n    \n    user = get_user_by_id(session['user_id'])\n    if not user or user['role'] != 'admin':\n        flash('Nur f√ºr Administratoren zug√§nglich.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    return '''\n    <!DOCTYPE html>\n    <html lang=\"de\">\n    <head>\n        <meta charset=\"UTF-8\">\n        <title>OAuth Debug - SportOase</title>\n        <style>\n            body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f5f5f5; }\n            h1 { color: #333; }\n            .card { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n            .info { color: #666; }\n            code { background: #e8e8e8; padding: 2px 6px; border-radius: 4px; }\n            pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; }\n            .success { color: #22c55e; }\n            .warning { color: #f59e0b; }\n            a { color: #3b82f6; }\n        </style>\n    </head>\n    <body>\n        <h1>OAuth Debug Info</h1>\n        \n        <div class=\"card\">\n            <h2>Aktuelle Session</h2>\n            <p><strong>User ID:</strong> ''' + str(session.get('user_id', 'N/A')) + '''</p>\n            <p><strong>Username:</strong> ''' + str(session.get('user_username', 'N/A')) + '''</p>\n            <p><strong>E-Mail:</strong> ''' + str(session.get('user_email', 'N/A')) + '''</p>\n            <p><strong>Rolle:</strong> ''' + str(session.get('user_role', 'N/A')) + '''</p>\n        </div>\n        \n        <div class=\"card\">\n            <h2>IServ OAuth Konfiguration</h2>\n            <p><strong>Angeforderte Scopes:</strong> <code>openid profile email roles groups</code></p>\n            <p class=\"info\">Diese Scopes m√ºssen in IServ Admin ‚Üí Single-Sign-On f√ºr diese App aktiviert sein.</p>\n        </div>\n        \n        <div class=\"card\">\n            <h2>So testen Sie die Rollen-Erkennung</h2>\n            <ol>\n                <li>Loggen Sie sich aus: <a href=\"/logout\">Logout</a></li>\n                <li>Loggen Sie sich erneut √ºber IServ ein</li>\n                <li>Pr√ºfen Sie die Server-Logs (im Terminal/Workflow)</li>\n                <li>Die Logs zeigen genau, welche Rollen/Gruppen IServ √ºbergibt</li>\n            </ol>\n            <p class=\"warning\">‚ö†Ô∏è Die OAuth-Daten werden aus Sicherheitsgr√ºnden nicht in der Session gespeichert.</p>\n        </div>\n        \n        <div class=\"card\">\n            <h2>IServ Admin Einstellungen</h2>\n            <p>In IServ unter <strong>Verwaltung ‚Üí System ‚Üí Single-Sign-On</strong>:</p>\n            <ol>\n                <li>√ñffnen Sie die SportOase OAuth-App</li>\n                <li>Unter \"Beschr√§nkungen ‚Üí Auf Scopes beschr√§nken\" aktivieren Sie:\n                    <ul>\n                        <li>‚úì OpenID</li>\n                        <li>‚úì E-Mail</li>\n                        <li>‚úì Profil</li>\n                        <li>‚úì <strong>Rollen</strong> (wichtig!)</li>\n                        <li>‚úì <strong>Gruppen</strong> (optional, als Fallback)</li>\n                    </ul>\n                </li>\n                <li>Speichern Sie die √Ñnderungen</li>\n            </ol>\n        </div>\n        \n        <p><a href=\"/dashboard\">‚Üê Zur√ºck zum Dashboard</a></p>\n    </body>\n    </html>\n    '''\n\n# Route: Passwort √§ndern\n@app.route('/change_password', methods=['GET', 'POST'])\n@admin_required\ndef change_password():\n    \"\"\"Erm√∂glicht Admins Passw√∂rter zu √§ndern\"\"\"\n    if request.method == 'POST':\n        # CSRF-Token Validierung\n        csrf_token = request.form.get('csrf_token', '')\n        if not validate_csrf_token(csrf_token):\n            flash('Ung√ºltiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n            return redirect(url_for('change_password'))\n        \n        old_password = request.form.get('old_password', '')\n        new_password = request.form.get('new_password', '')\n        confirm_password = request.form.get('confirm_password', '')\n        \n        # Validierung\n        if not old_password or not new_password or not confirm_password:\n            flash('Bitte f√ºllen Sie alle Felder aus.', 'error')\n            return redirect(url_for('change_password'))\n        \n        if new_password != confirm_password:\n            flash('Die neuen Passw√∂rter stimmen nicht √ºberein.', 'error')\n            return redirect(url_for('change_password'))\n        \n        if len(new_password) < 6:\n            flash('Das neue Passwort muss mindestens 6 Zeichen lang sein.', 'error')\n            return redirect(url_for('change_password'))\n        \n        # Passwort √§ndern\n        result = change_user_password(session['user_id'], old_password, new_password)\n        \n        if result['success']:\n            flash(result['message'], 'success')\n            return redirect(url_for('dashboard'))\n        else:\n            flash(result['error'], 'error')\n            return redirect(url_for('change_password'))\n    \n    return render_template('change_password.html')\n\n# Route: Dashboard\n@app.route('/dashboard')\n@login_required\ndef dashboard():\n    \"\"\"Hauptseite - zeigt Wochenplan und Buchungsm√∂glichkeiten\"\"\"\n    # Hole aktuelles Datum oder gew√§hltes Datum\n    selected_date_str = request.args.get('date', datetime.now(get_berlin_tz()).strftime('%Y-%m-%d'))\n    \n    try:\n        selected_date = datetime.strptime(selected_date_str, '%Y-%m-%d').date()\n    except:\n        selected_date = datetime.now(get_berlin_tz()).date()\n    \n    # Wochentag ermitteln (Mon, Tue, ...)\n    weekday = selected_date.strftime('%a')\n    weekday_name = selected_date.strftime('%A')  # Ausgeschriebener Name\n    \n    # Deutsche Wochentagsnamen\n    weekday_names_de = {\n        'Monday': 'Montag',\n        'Tuesday': 'Dienstag',\n        'Wednesday': 'Mittwoch',\n        'Thursday': 'Donnerstag',\n        'Friday': 'Freitag',\n        'Saturday': 'Samstag',\n        'Sunday': 'Sonntag'\n    }\n    weekday_name_de = weekday_names_de.get(weekday_name, weekday_name)\n    \n    # Erstelle Stundenplan f√ºr den Tag\n    from models import is_slot_blocked, get_blocked_slot\n    schedule = []\n    for period in range(1, 7):\n        period_info = get_period_info(weekday, period)\n        student_count = count_students_for_period(selected_date_str, period)\n        available = MAX_STUDENTS_PER_PERIOD - student_count\n        \n        # Pr√ºfe, ob Slot blockiert ist\n        blocked_slot = get_blocked_slot(selected_date_str, period)\n        is_blocked = blocked_slot is not None\n        \n        # Pr√ºfe, ob Termin in der Vergangenheit liegt\n        is_past = is_past_date(selected_date, period)\n        \n        # Pr√ºfe, ob es ein Wochenende ist\n        is_weekend = selected_date.weekday() in [5, 6]\n        \n        # Pr√ºfe, ob Buchung zeitlich m√∂glich ist\n        can_book, time_message = check_booking_time(selected_date, period)\n        \n        # can_book muss False sein f√ºr vergangene Termine oder Wochenenden\n        if is_past:\n            can_book = False\n            if not time_message:\n                time_message = \"Dieser Termin liegt in der Vergangenheit.\"\n        elif is_weekend:\n            can_book = False\n            if not time_message:\n                time_message = \"Buchungen sind am Wochenende nicht m√∂glich.\"\n        \n        schedule.append({\n            'period': period,\n            'time': f\"{PERIOD_TIMES[period]['start']} - {PERIOD_TIMES[period]['end']}\",\n            'type': period_info['type'],\n            'label': period_info['label'],\n            'booked': student_count,\n            'available': available,\n            'can_book': can_book and available > 0 and not is_blocked and not is_past and not is_weekend,\n            'time_message': time_message,\n            'blocked': blocked_slot,\n            'blocked_reason': blocked_slot.get('reason', 'Beratung') if blocked_slot else None,\n            'blocked_icon': blocked_slot.get('icon', 'üîß') if blocked_slot else None,\n            'is_past': is_past,\n            'is_weekend': is_weekend\n        })\n    \n    # Erstelle Wochen√ºbersicht (Montag-Freitag) mit Buchungsdaten\n    from models import get_bookings_for_week, get_blocked_slots_for_week, is_slot_blocked\n    \n    # Berechne Montag und Freitag der aktuellen Woche\n    days_since_monday = selected_date.weekday()\n    monday = selected_date - timedelta(days=days_since_monday)\n    friday = monday + timedelta(days=4)\n    \n    # Berechne Kalenderwoche\n    calendar_week = monday.isocalendar()[1]\n    calendar_year = monday.isocalendar()[0]\n    \n    # Berechne vorherige und n√§chste Woche f√ºr Navigation\n    prev_week_monday = monday - timedelta(days=7)\n    next_week_monday = monday + timedelta(days=7)\n    \n    # Hole alle Buchungen f√ºr diese Woche\n    week_bookings = get_bookings_for_week(monday.strftime('%Y-%m-%d'), friday.strftime('%Y-%m-%d'))\n    \n    # Hole alle blockierten Slots f√ºr diese Woche\n    blocked_slots = get_blocked_slots_for_week(monday.strftime('%Y-%m-%d'), friday.strftime('%Y-%m-%d'))\n    \n    # Organisiere blockierte Slots nach Datum und Stunde\n    blocked_by_date_period = {}\n    for blocked in blocked_slots:\n        key = f\"{blocked['date']}_{blocked['period']}\"\n        blocked_by_date_period[key] = blocked\n    \n    # Organisiere Buchungen nach Datum und Stunde\n    bookings_by_date_period = {}\n    exclusive_by_date_period = {}\n    pending_exclusive_by_date_period = {}\n    \n    for booking in week_bookings:\n        booking_dict = dict(booking)\n        key = f\"{booking_dict['date']}_{booking_dict['period']}\"\n        if key not in bookings_by_date_period:\n            bookings_by_date_period[key] = []\n        \n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        booking_info = {\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'teacher_id': booking_dict.get('teacher_id'),\n            'student_count': len(students),\n            'students': students,\n            'offer_label': booking_dict.get('offer_label', 'N/A'),\n            'is_exclusive': booking_dict.get('is_exclusive', False),\n            'is_approved': booking_dict.get('is_approved', True)\n        }\n        bookings_by_date_period[key].append(booking_info)\n        \n        # Speichere exklusive genehmigte Buchungen separat\n        if booking_dict.get('is_exclusive') and booking_dict.get('is_approved'):\n            exclusive_by_date_period[key] = booking_info\n        \n        # Speichere ausstehende exklusive Buchungen (noch nicht genehmigt)\n        if booking_dict.get('is_exclusive') and not booking_dict.get('is_approved'):\n            pending_exclusive_by_date_period[key] = booking_info\n    \n    week_overview = []\n    weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']\n    weekday_names = ['Mo', 'Di', 'Mi', 'Do', 'Fr']\n    \n    for i, wd in enumerate(weekdays):\n        day_date = monday + timedelta(days=i)\n        day_date_str = day_date.strftime('%Y-%m-%d')\n        \n        day_schedule = []\n        for period in range(1, 7):\n            info = get_period_info(wd, period)\n            key = f\"{day_date_str}_{period}\"\n            period_bookings = bookings_by_date_period.get(key, [])\n            blocked_slot = blocked_by_date_period.get(key)\n            exclusive_booking = exclusive_by_date_period.get(key)\n            \n            total_students = sum(b['student_count'] for b in period_bookings)\n            pending_exclusive = pending_exclusive_by_date_period.get(key)\n            \n            # Bei exklusiver Buchung ist der Slot voll belegt\n            if exclusive_booking:\n                available = 0\n            else:\n                available = MAX_STUDENTS_PER_PERIOD - total_students\n            \n            # Pr√ºfe, ob Termin in der Vergangenheit liegt\n            is_past = is_past_date(day_date, period)\n            \n            # Pr√ºfe, ob es ein Wochenende ist\n            is_weekend = day_date.weekday() in [5, 6]\n            \n            # Pr√ºfe, ob Buchung f√ºr diesen Slot m√∂glich ist\n            can_book, _ = check_booking_time(day_date, period)\n            can_book = can_book and available > 0 and not blocked_slot and not is_past and not is_weekend and not exclusive_booking\n            \n            day_schedule.append({\n                'period': period,\n                'type': info['type'],\n                'label': info['label'],\n                'bookings': period_bookings,\n                'total_students': total_students,\n                'available': available,\n                'can_book': can_book,\n                'blocked': blocked_slot,\n                'blocked_reason': blocked_slot.get('reason', 'Beratung') if blocked_slot else None,\n                'blocked_icon': blocked_slot.get('icon', 'üîß') if blocked_slot else None,\n                'is_past': is_past,\n                'is_weekend': is_weekend,\n                'is_exclusive': exclusive_booking is not None,\n                'exclusive_booking': exclusive_booking,\n                'pending_exclusive': pending_exclusive\n            })\n        # Pr√ºfe ob heute\n        today = datetime.now(get_berlin_tz()).date()\n        is_today = day_date == today\n        \n        week_overview.append({\n            'weekday': wd,\n            'name': weekday_names[i],\n            'date': day_date_str,\n            'date_formatted': day_date.strftime('%d.%m.'),\n            'schedule': day_schedule,\n            'is_today': is_today\n        })\n    \n    return render_template('dashboard.html',\n                         selected_date=selected_date,\n                         weekday=weekday_name_de,\n                         schedule=schedule,\n                         week_overview=week_overview,\n                         user_role=session.get('user_role'),\n                         current_user_id=session.get('user_id'),\n                         calendar_week=calendar_week,\n                         calendar_year=calendar_year,\n                         prev_week_date=prev_week_monday.strftime('%Y-%m-%d'),\n                         next_week_date=next_week_monday.strftime('%Y-%m-%d'),\n                         monday_date=monday.strftime('%d.%m.%Y'),\n                         friday_date=friday.strftime('%d.%m.%Y'))\n\n# Route: Kalenderansicht (Monats-/Jahres√ºbersicht)\n@app.route('/calendar')\n@app.route('/calendar/<int:year>/<int:month>')\n@login_required\ndef calendar_view(year=None, month=None):\n    \"\"\"Monats-/Jahreskalenderansicht mit Buchungs√ºbersicht\"\"\"\n    import calendar\n    from models import get_bookings_for_week, get_blocked_slots_for_week\n    \n    # Aktuelles Datum\n    today = datetime.now(get_berlin_tz()).date()\n    \n    # Standard: aktueller Monat\n    if year is None:\n        year = today.year\n    if month is None:\n        month = today.month\n    \n    # Validierung\n    if month < 1:\n        month = 12\n        year -= 1\n    elif month > 12:\n        month = 1\n        year += 1\n    \n    # Deutsche Monatsnamen\n    month_names_de = {\n        1: 'Januar', 2: 'Februar', 3: 'M√§rz', 4: 'April',\n        5: 'Mai', 6: 'Juni', 7: 'Juli', 8: 'August',\n        9: 'September', 10: 'Oktober', 11: 'November', 12: 'Dezember'\n    }\n    \n    # Kalender erstellen\n    cal = calendar.Calendar(firstweekday=0)  # Montag als erster Tag\n    month_days = cal.monthdayscalendar(year, month)\n    \n    # Ersten und letzten Tag des Monats ermitteln\n    first_day = date(year, month, 1)\n    if month == 12:\n        last_day = date(year + 1, 1, 1) - timedelta(days=1)\n    else:\n        last_day = date(year, month + 1, 1) - timedelta(days=1)\n    \n    # Buchungen und blockierte Slots f√ºr den gesamten Monat holen\n    from models import Booking, BlockedSlot\n    \n    month_bookings = Booking.query.filter(\n        Booking.date >= first_day.strftime('%Y-%m-%d'),\n        Booking.date <= last_day.strftime('%Y-%m-%d')\n    ).all()\n    \n    month_blocked = BlockedSlot.query.filter(\n        BlockedSlot.date >= first_day.strftime('%Y-%m-%d'),\n        BlockedSlot.date <= last_day.strftime('%Y-%m-%d')\n    ).all()\n    \n    # Z√§hle Buchungen pro Tag\n    bookings_per_day = {}\n    for booking in month_bookings:\n        day_key = booking.date\n        if day_key not in bookings_per_day:\n            bookings_per_day[day_key] = 0\n        students = json.loads(booking.students_json) if booking.students_json else []\n        bookings_per_day[day_key] += len(students)\n    \n    # Z√§hle blockierte Slots pro Tag\n    blocked_per_day = {}\n    blocked_reasons = {}\n    for blocked in month_blocked:\n        day_key = blocked.date\n        if day_key not in blocked_per_day:\n            blocked_per_day[day_key] = 0\n            blocked_reasons[day_key] = blocked.reason or 'Blockiert'\n        blocked_per_day[day_key] += 1\n    \n    # Kalenderwochen erstellen mit Infos\n    weeks = []\n    for week in month_days:\n        week_data = []\n        for day_num in week:\n            if day_num == 0:\n                week_data.append(None)\n            else:\n                day_date = date(year, month, day_num)\n                day_str = day_date.strftime('%Y-%m-%d')\n                is_weekend = day_date.weekday() in [5, 6]\n                is_today = day_date == today\n                is_past = day_date < today\n                \n                booking_count = bookings_per_day.get(day_str, 0)\n                blocked_count = blocked_per_day.get(day_str, 0)\n                blocked_reason = blocked_reasons.get(day_str, '')\n                \n                # Status ermitteln\n                if is_weekend:\n                    status = 'weekend'\n                elif blocked_count >= 6:  # Alle 6 Stunden blockiert\n                    status = 'blocked'\n                elif blocked_count > 0:\n                    status = 'partial_blocked'\n                elif booking_count >= 30:  # 6 Stunden * 5 Pl√§tze = 30\n                    status = 'full'\n                elif booking_count > 0:\n                    status = 'has_bookings'\n                else:\n                    status = 'free'\n                \n                week_data.append({\n                    'day': day_num,\n                    'date': day_str,\n                    'is_weekend': is_weekend,\n                    'is_today': is_today,\n                    'is_past': is_past,\n                    'booking_count': booking_count,\n                    'blocked_count': blocked_count,\n                    'blocked_reason': blocked_reason,\n                    'status': status\n                })\n        weeks.append(week_data)\n    \n    # Navigation\n    prev_month = month - 1 if month > 1 else 12\n    prev_year = year if month > 1 else year - 1\n    next_month = month + 1 if month < 12 else 1\n    next_year = year if month < 12 else year + 1\n    \n    return render_template('calendar.html',\n                         year=year,\n                         month=month,\n                         month_name=month_names_de[month],\n                         weeks=weeks,\n                         today=today,\n                         prev_year=prev_year,\n                         prev_month=prev_month,\n                         next_year=next_year,\n                         next_month=next_month,\n                         user_role=session.get('user_role'))\n\n# Route: Buchungsseite\n@app.route('/book/<date_str>/<int:period>', methods=['GET', 'POST'])\n@login_required\ndef book(date_str, period):\n    \"\"\"Seite zum Erstellen einer neuen Buchung\"\"\"\n    from config import SCHOOL_CLASSES\n    \n    # Hole den Benutzernamen aus der Session f√ºr das Formular\n    user_display_name = session.get('user_username', '')\n    # Falls E-Mail als Username verwendet wird, extrahiere den Namen\n    if '@' in user_display_name:\n        user_display_name = user_display_name.split('@')[0].replace('.', ' ').title()\n    \n    # Validiere Datum und Stunde\n    try:\n        booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n    except:\n        flash('Ung√ºltiges Datum.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    if period < 1 or period > 6:\n        flash('Ung√ºltige Stunde.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Pr√ºfe, ob Termin in der Vergangenheit liegt\n    if is_past_date(booking_date, period):\n        flash('Dieser Termin liegt in der Vergangenheit und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Pr√ºfe, ob es ein Wochenende ist (Samstag=5, Sonntag=6)\n    if booking_date.weekday() in [5, 6]:\n        flash('Buchungen sind am Wochenende nicht m√∂glich.', 'error')\n        return redirect(url_for('dashboard'))\n    \n    # Ermittle Wochentag und Stundeninfo\n    weekday = booking_date.strftime('%a')\n    period_info = get_period_info(weekday, period)\n    \n    # Pr√ºfe verf√ºgbare Pl√§tze\n    current_students = count_students_for_period(date_str, period)\n    available_spots = MAX_STUDENTS_PER_PERIOD - current_students\n    \n    if available_spots <= 0:\n        flash('Diese Stunde ist bereits voll belegt.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Pr√ºfe, ob Slot f√ºr Beratung blockiert ist (nur Admins k√∂nnen blockierte Slots sehen)\n    from models import is_slot_blocked, get_blocked_slot\n    if is_slot_blocked(date_str, period):\n        blocked_info = get_blocked_slot(date_str, period)\n        reason = blocked_info.get('reason', 'Beratung') if blocked_info else 'Beratung'\n        flash(f'Dieser Slot ist f√ºr {reason} blockiert und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Pr√ºfe, ob bereits eine genehmigte exklusive Buchung existiert\n    from models import Booking\n    exclusive_booking = Booking.query.filter_by(\n        date=date_str,\n        period=period,\n        is_exclusive=True,\n        is_approved=True\n    ).first()\n    if exclusive_booking:\n        flash('Dieser Slot ist f√ºr ein Einzelangebot reserviert und kann nicht gebucht werden.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    # Pr√ºfe Zeitfenster\n    can_book, time_message = check_booking_time(booking_date, period)\n    if not can_book:\n        flash(time_message or 'Buchung nicht m√∂glich.', 'error')\n        return redirect(url_for('dashboard', date=date_str))\n    \n    if request.method == 'POST':\n        # Hole Lehrkraft-Informationen\n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not teacher_name or not teacher_class:\n            flash('Bitte geben Sie Ihren Namen und Ihre Klasse ein.', 'error')\n            return render_template('book.html', \n                                 date_str=date_str,\n                                 period=period,\n                                 period_info=period_info,\n                                 period_time=PERIOD_TIMES[period],\n                                 available_spots=available_spots,\n                                 free_modules=FREE_MODULES,\n                                 user_name=user_display_name,\n                                 school_classes=SCHOOL_CLASSES)\n        \n        # Hole Anzahl der Sch√ºler\n        num_students = int(request.form.get('num_students', 1))\n        \n        if num_students < 1 or num_students > 5:\n            flash('Bitte w√§hlen Sie zwischen 1 und 5 Sch√ºlern.', 'error')\n            return render_template('book.html', \n                                 date_str=date_str,\n                                 period=period,\n                                 period_info=period_info,\n                                 period_time=PERIOD_TIMES[period],\n                                 available_spots=available_spots,\n                                 free_modules=FREE_MODULES,\n                                 user_name=user_display_name,\n                                 school_classes=SCHOOL_CLASSES)\n        \n        # Pr√ºfe erneut verf√ºgbare Pl√§tze\n        if num_students > available_spots:\n            flash(f'Nicht genug Pl√§tze verf√ºgbar. Nur noch {available_spots} Pl√§tze frei.', 'error')\n            return redirect(url_for('dashboard', date=date_str))\n        \n        # Sammle Sch√ºlerdaten und pr√ºfe Doppelbuchungen\n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte f√ºllen Sie alle Sch√ºlerfelder aus.', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES,\n                                     user_name=user_display_name,\n                                     school_classes=SCHOOL_CLASSES)\n            \n            # Pr√ºfe auf Doppelbuchung\n            double_booking = check_student_double_booking(name, klasse, date_str, period)\n            if double_booking['is_booked']:\n                flash(f'‚ö†Ô∏è Doppelbuchung verhindert: {double_booking[\"booking_info\"]}', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES,\n                                     user_name=user_display_name,\n                                     school_classes=SCHOOL_CLASSES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        # Hole Modul-Wahl (nur bei freien Stunden)\n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte w√§hlen Sie ein Modul.', 'error')\n                return render_template('book.html', \n                                     date_str=date_str,\n                                     period=period,\n                                     period_info=period_info,\n                                     period_time=PERIOD_TIMES[period],\n                                     available_spots=available_spots,\n                                     free_modules=FREE_MODULES,\n                                     user_name=user_display_name,\n                                     school_classes=SCHOOL_CLASSES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        # Hole optionale Notizen\n        notes = request.form.get('notes', '').strip()\n        \n        # Pr√ºfe ob exklusive Buchung (nur 1 Sch√ºler)\n        is_exclusive = request.form.get('is_exclusive') == '1' and len(students) == 1\n        \n        # Erstelle Buchung in Datenbank\n        booking_id = create_booking(\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=session['user_id'],\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class,\n            notes=notes if notes else None,\n            is_exclusive=is_exclusive\n        )\n        \n        if booking_id:\n            # Sende E-Mail-Benachrichtigung\n            booking_data = {\n                'date': date_str,\n                'weekday': weekday,\n                'period': period,\n                'students': students,\n                'offer_type': period_info['type'],\n                'offer_label': offer_label,\n                'teacher_name': teacher_name,\n                'teacher_class': teacher_class,\n                'students_json': json.dumps(students, ensure_ascii=False),\n                'is_exclusive': is_exclusive\n            }\n            \n            # Erstelle Notification in der Datenbank\n            if is_exclusive:\n                notification_message = f\"üîí EXKLUSIVE Buchung (Freigabe n√∂tig): {teacher_name} m√∂chte 1 Sch√ºler exklusiv f√ºr {offer_label} am {date_str} (Stunde {period}) anmelden.\"\n                notification_type = 'exclusive_booking_pending'\n            else:\n                notification_message = f\"Neue Buchung: {teacher_name} hat {len(students)} Sch√ºler f√ºr {offer_label} am {date_str} (Stunde {period}) angemeldet.\"\n                notification_type = 'new_booking'\n            \n            notification_id = create_notification(\n                booking_id=booking_id,\n                message=notification_message,\n                notification_type=notification_type,\n                recipient_role='admin',\n                metadata={\n                    'teacher_name': teacher_name,\n                    'teacher_class': teacher_class,\n                    'date': date_str,\n                    'period': period,\n                    'offer_label': offer_label,\n                    'students_count': len(students),\n                    'is_exclusive': is_exclusive\n                }\n            )\n            \n            # Sende E-Mail-Benachrichtigung an Admin (SMTP)\n            try:\n                send_booking_notification(booking_data)\n            except Exception as e:\n                print(f\"E-Mail-Benachrichtigung fehlgeschlagen: {e}\")\n            \n            # Sende E-Mail-Best√§tigung an Lehrer (nur wenn Checkbox aktiviert)\n            send_email_confirmation = request.form.get('send_email_confirmation') == '1'\n            \n            # Hole E-Mail direkt aus der Datenbank (zuverl√§ssiger als Session)\n            user_id = session.get('user_id')\n            user_email = ''\n            if user_id:\n                user_data = get_user_by_id(user_id)\n                if user_data:\n                    user_email = user_data.get('email', '')\n            \n            print(f\"[BUCHUNG] E-Mail-Checkbox aktiviert: {send_email_confirmation}\")\n            print(f\"[BUCHUNG] User ID: {user_id}\")\n            print(f\"[BUCHUNG] User E-Mail (aus DB): {user_email}\")\n            \n            if send_email_confirmation and user_email:\n                print(f\"[BUCHUNG] Versuche E-Mail-Best√§tigung an {user_email} zu senden...\")\n                try:\n                    if is_exclusive:\n                        # Bei Einzelbuchung: \"Buchung steht aus\" statt \"erfolgreich gebucht\"\n                        from email_service import send_exclusive_pending_email\n                        result = send_exclusive_pending_email(user_email, booking_data)\n                        print(f\"[BUCHUNG] Einzelbuchung-Pending-E-Mail Ergebnis: {result}\")\n                    else:\n                        # Normale Buchung: Standard-Best√§tigung\n                        from email_service import send_user_booking_confirmation\n                        result = send_user_booking_confirmation(user_email, booking_data)\n                        print(f\"[BUCHUNG] E-Mail-Versand Ergebnis: {result}\")\n                except Exception as e:\n                    print(f\"[BUCHUNG] Benutzer-E-Mail-Best√§tigung fehlgeschlagen: {e}\")\n            else:\n                print(f\"[BUCHUNG] Keine E-Mail gesendet (Checkbox: {send_email_confirmation}, Email vorhanden: {bool(user_email)})\")\n            \n            # Broadcast an SSE-Clients\n            if notification_id:\n                unread_count = get_unread_notification_count(recipient_role='admin')\n                broadcast_notification({\n                    'type': 'new_booking',\n                    'notification_id': notification_id,\n                    'message': notification_message,\n                    'booking_data': {\n                        'date': date_str,\n                        'period': period,\n                        'teacher_name': teacher_name,\n                        'offer_label': offer_label,\n                        'students_count': len(students)\n                    },\n                    'unread_count': unread_count\n                })\n            \n            if is_exclusive:\n                flash(f'Exklusive Buchung eingereicht! Die Buchung wartet auf Freigabe durch den Admin. Sie werden per E-Mail benachrichtigt.', 'info')\n            else:\n                flash(f'Buchung erfolgreich! {len(students)} Sch√ºler f√ºr {offer_label} angemeldet.', 'success')\n            return redirect(url_for('dashboard', date=date_str))\n        else:\n            flash('Fehler beim Erstellen der Buchung.', 'error')\n    \n    # Hole E-Mail aus der Datenbank f√ºr die Anzeige\n    display_user_email = ''\n    user_id = session.get('user_id')\n    if user_id:\n        user_data = get_user_by_id(user_id)\n        if user_data:\n            display_user_email = user_data.get('email', '')\n    \n    return render_template('book.html',\n                         date_str=date_str,\n                         period=period,\n                         period_info=period_info,\n                         period_time=PERIOD_TIMES[period],\n                         available_spots=available_spots,\n                         free_modules=FREE_MODULES,\n                         user_name=user_display_name,\n                         user_email=display_user_email,\n                         school_classes=SCHOOL_CLASSES)\n\n# Hilfsfunktion: Pr√ºft ob eine Buchung noch bearbeitet/gel√∂scht werden kann\ndef can_modify_booking(booking_date_str, period):\n    \"\"\"\n    Pr√ºft ob eine Buchung noch bearbeitet/gel√∂scht werden kann.\n    √Ñnderungen sind bis 1 Stunde vor dem Termin m√∂glich.\n    \n    Returns:\n        Tuple (can_modify: bool, reason: str or None)\n    \"\"\"\n    try:\n        booking_date = datetime.strptime(booking_date_str, '%Y-%m-%d').date()\n        now = datetime.now(get_berlin_tz())\n        today = now.date()\n        \n        # Vergangenes Datum?\n        if booking_date < today:\n            return False, \"Vergangener Termin\"\n        \n        # Heute: Pr√ºfe ob weniger als 1 Stunde bis zum Termin\n        if booking_date == today:\n            period_start_str = PERIOD_TIMES[period]['start']\n            period_start_time = datetime.strptime(period_start_str, '%H:%M').time()\n            period_start = datetime.combine(today, period_start_time)\n            period_start = get_berlin_tz().localize(period_start)\n            \n            # 1 Stunde vor Beginn\n            cutoff_time = period_start - timedelta(hours=1)\n            \n            if now >= cutoff_time:\n                return False, \"Weniger als 1 Stunde vor Termin\"\n        \n        return True, None\n    except Exception as e:\n        print(f\"Fehler bei can_modify_booking: {e}\")\n        return False, \"Fehler bei der Pr√ºfung\"\n\n# Route: Meine Buchungen\n@app.route('/meine-buchungen')\n@login_required\ndef meine_buchungen():\n    \"\"\"Zeigt alle Buchungen des Benutzers (oder alle f√ºr Admin)\"\"\"\n    from models import get_all_bookings, Booking\n    \n    user_id = session['user_id']\n    is_admin = session.get('user_role') == 'admin'\n    \n    # Admin sieht alle Buchungen, normale Benutzer nur ihre eigenen\n    if is_admin:\n        all_bookings = get_all_bookings()\n    else:\n        bookings_query = Booking.query.filter_by(teacher_id=user_id).order_by(Booking.date.desc(), Booking.period).all()\n        all_bookings = [b.to_dict() for b in bookings_query]\n    \n    # Deutsche Wochentagsnamen\n    weekday_names_de = {\n        'Mon': 'Montag', 'Tue': 'Dienstag', 'Wed': 'Mittwoch',\n        'Thu': 'Donnerstag', 'Fri': 'Freitag', 'Sat': 'Samstag', 'Sun': 'Sonntag'\n    }\n    \n    bookings_display = []\n    for booking in all_bookings:\n        booking_dict = dict(booking)\n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        \n        # Pr√ºfe ob Buchung bearbeitet/gel√∂scht werden kann\n        can_modify, modify_reason = can_modify_booking(booking_dict['date'], booking_dict['period'])\n        \n        # Admin kann immer bearbeiten\n        if is_admin:\n            can_modify = True\n            modify_reason = None\n        \n        # Datum formatieren\n        try:\n            booking_date = datetime.strptime(booking_dict['date'], '%Y-%m-%d').date()\n            date_formatted = booking_date.strftime('%d.%m.%Y')\n            is_past = booking_date < datetime.now(get_berlin_tz()).date()\n        except:\n            date_formatted = booking_dict['date']\n            is_past = False\n        \n        # Created_at formatieren\n        created_at = booking_dict.get('created_at', '')\n        if created_at:\n            try:\n                if isinstance(created_at, str):\n                    created_dt = datetime.fromisoformat(created_at.replace('Z', '+00:00'))\n                else:\n                    created_dt = created_at\n                created_at_formatted = created_dt.strftime('%d.%m.%Y %H:%M')\n            except:\n                created_at_formatted = str(created_at)\n        else:\n            created_at_formatted = '-'\n        \n        bookings_display.append({\n            'id': booking_dict['id'],\n            'date': booking_dict['date'],\n            'date_formatted': date_formatted,\n            'weekday': booking_dict['weekday'],\n            'weekday_name': weekday_names_de.get(booking_dict['weekday'], booking_dict['weekday']),\n            'period': booking_dict['period'],\n            'period_time': f\"{PERIOD_TIMES[booking_dict['period']]['start']} - {PERIOD_TIMES[booking_dict['period']]['end']}\",\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'offer_label': booking_dict['offer_label'],\n            'offer_type': booking_dict['offer_type'],\n            'students': students,\n            'can_modify': can_modify,\n            'modify_reason': modify_reason,\n            'is_past': is_past,\n            'created_at_formatted': created_at_formatted\n        })\n    \n    return render_template('meine_buchungen.html',\n                         bookings=bookings_display,\n                         is_admin=is_admin)\n\n# Route: Eigene Buchung bearbeiten\n@app.route('/meine-buchungen/bearbeiten/<int:booking_id>', methods=['GET', 'POST'])\n@login_required\ndef edit_my_booking(booking_id):\n    \"\"\"Benutzer kann eigene Buchung bearbeiten (bis 1 Stunde vorher)\"\"\"\n    from models import get_booking_by_id, update_booking, Booking\n    \n    user_id = session['user_id']\n    is_admin = session.get('user_role') == 'admin'\n    \n    booking_row = get_booking_by_id(booking_id)\n    if not booking_row:\n        flash('Buchung nicht gefunden.', 'error')\n        return redirect(url_for('meine_buchungen'))\n    \n    booking = dict(booking_row)\n    \n    # Pr√ºfe Berechtigung: Eigene Buchung oder Admin\n    if booking['teacher_id'] != user_id and not is_admin:\n        flash('Sie k√∂nnen nur Ihre eigenen Buchungen bearbeiten.', 'error')\n        return redirect(url_for('meine_buchungen'))\n    \n    # Pr√ºfe ob Bearbeitung noch m√∂glich ist (au√üer Admin)\n    if not is_admin:\n        can_modify, modify_reason = can_modify_booking(booking['date'], booking['period'])\n        if not can_modify:\n            flash(f'Diese Buchung kann nicht mehr bearbeitet werden: {modify_reason}', 'error')\n            return redirect(url_for('meine_buchungen'))\n    \n    # Deutsche Wochentagsnamen\n    weekday_names_de = {\n        'Mon': 'Montag', 'Tue': 'Dienstag', 'Wed': 'Mittwoch',\n        'Thu': 'Donnerstag', 'Fri': 'Freitag', 'Sat': 'Samstag', 'Sun': 'Sonntag'\n    }\n    \n    students = json.loads(booking['students_json']) if booking.get('students_json') else []\n    \n    # Berechne verf√ºgbare Pl√§tze (ohne die aktuelle Buchung)\n    current_students = count_students_for_period(booking['date'], booking['period'])\n    available_spots = MAX_STUDENTS_PER_PERIOD - (current_students - len(students))\n    \n    # Datum formatieren\n    try:\n        booking_date = datetime.strptime(booking['date'], '%Y-%m-%d').date()\n        date_formatted = booking_date.strftime('%d.%m.%Y')\n    except:\n        date_formatted = booking['date']\n    \n    if request.method == 'POST':\n        # CSRF-Token Validierung\n        csrf_token = request.form.get('csrf_token', '')\n        if not validate_csrf_token(csrf_token):\n            flash('Ung√ºltiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n            return redirect(url_for('edit_my_booking', booking_id=booking_id))\n        \n        try:\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ung√ºltige Sch√ºleranzahl.', 'error')\n            return redirect(url_for('edit_my_booking', booking_id=booking_id))\n        \n        if num_students < 1 or num_students > available_spots:\n            flash(f'Bitte w√§hlen Sie zwischen 1 und {available_spots} Sch√ºler*innen.', 'error')\n            return redirect(url_for('edit_my_booking', booking_id=booking_id))\n        \n        # Sammle Sch√ºlerdaten\n        new_students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte f√ºllen Sie alle Sch√ºlerfelder aus.', 'error')\n                return redirect(url_for('edit_my_booking', booking_id=booking_id))\n            \n            # Pr√ºfe auf Doppelbuchung (au√üer bei der aktuellen Buchung)\n            double_booking = check_student_double_booking(name, klasse, booking['date'], booking['period'], exclude_booking_id=booking_id)\n            if double_booking['is_booked']:\n                flash(f'‚ö†Ô∏è Doppelbuchung verhindert: {double_booking[\"booking_info\"]}', 'error')\n                return redirect(url_for('edit_my_booking', booking_id=booking_id))\n            \n            new_students.append({'name': name, 'klasse': klasse})\n        \n        # Hole Modul-Wahl (nur bei freien Stunden)\n        if booking['offer_type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte w√§hlen Sie ein Modul.', 'error')\n                return redirect(url_for('edit_my_booking', booking_id=booking_id))\n            offer_label = selected_module\n        else:\n            offer_label = booking['offer_label']\n        \n        # Aktualisiere Buchung (Notizen bleiben unver√§ndert bei Lehrer-Bearbeitung)\n        if update_booking(\n            booking_id=booking_id,\n            date=booking['date'],\n            weekday=booking['weekday'],\n            period=booking['period'],\n            teacher_id=booking['teacher_id'],\n            students=new_students,\n            offer_type=booking['offer_type'],\n            offer_label=offer_label,\n            teacher_name=booking.get('teacher_name'),\n            teacher_class=booking.get('teacher_class'),\n            notes=booking.get('notes')\n        ):\n            flash('Buchung erfolgreich aktualisiert!', 'success')\n            return redirect(url_for('meine_buchungen'))\n        else:\n            flash('Fehler beim Aktualisieren der Buchung.', 'error')\n    \n    # Booking-Objekt f√ºr Template vorbereiten\n    booking_display = {\n        'id': booking['id'],\n        'date': booking['date'],\n        'date_formatted': date_formatted,\n        'weekday': booking['weekday'],\n        'weekday_name': weekday_names_de.get(booking['weekday'], booking['weekday']),\n        'period': booking['period'],\n        'offer_label': booking['offer_label'],\n        'offer_type': booking['offer_type'],\n        'students': students\n    }\n    \n    return render_template('edit_my_booking.html',\n                         booking=booking_display,\n                         period_times=PERIOD_TIMES,\n                         free_modules=FREE_MODULES,\n                         school_classes=SCHOOL_CLASSES,\n                         max_students=available_spots,\n                         available_spots=available_spots - len(students))\n\n# Route: Eigene Buchung l√∂schen\n@app.route('/meine-buchungen/loeschen/<int:booking_id>', methods=['POST'])\n@login_required\ndef delete_my_booking(booking_id):\n    \"\"\"Benutzer kann eigene Buchung l√∂schen (bis 1 Stunde vorher)\"\"\"\n    from models import get_booking_by_id, delete_booking\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ung√ºltiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(url_for('meine_buchungen'))\n    \n    user_id = session['user_id']\n    is_admin = session.get('user_role') == 'admin'\n    \n    booking_row = get_booking_by_id(booking_id)\n    if not booking_row:\n        flash('Buchung nicht gefunden.', 'error')\n        return redirect(url_for('meine_buchungen'))\n    \n    booking = dict(booking_row)\n    \n    # Pr√ºfe Berechtigung: Eigene Buchung oder Admin\n    if booking['teacher_id'] != user_id and not is_admin:\n        flash('Sie k√∂nnen nur Ihre eigenen Buchungen l√∂schen.', 'error')\n        return redirect(url_for('meine_buchungen'))\n    \n    # Pr√ºfe ob L√∂schen noch m√∂glich ist (au√üer Admin)\n    if not is_admin:\n        can_modify, modify_reason = can_modify_booking(booking['date'], booking['period'])\n        if not can_modify:\n            flash(f'Diese Buchung kann nicht mehr gel√∂scht werden: {modify_reason}', 'error')\n            return redirect(url_for('meine_buchungen'))\n    \n    # L√∂sche Buchung\n    if delete_booking(booking_id):\n        flash('Buchung erfolgreich gel√∂scht.', 'success')\n    else:\n        flash('Buchung konnte nicht gel√∂scht werden.', 'error')\n    \n    return redirect(url_for('meine_buchungen'))\n\n# Route: Admin-Bereich\n@app.route('/admin', methods=['GET', 'POST'])\n@admin_required\ndef admin():\n    \"\"\"Admin-Seite f√ºr Benutzerverwaltung und Buchungs√ºbersicht\"\"\"\n    \n    if request.method == 'POST':\n        # Neue Lehrkraft anlegen\n        username = request.form.get('username', '').strip()\n        password = request.form.get('password', '')\n        email = request.form.get('email', '').strip()\n        \n        if not username or not password:\n            flash('Bitte f√ºllen Sie alle Felder aus.', 'error')\n        else:\n            user_id = create_user(username, password, 'teacher', email if email else None)\n            if user_id:\n                flash(f'Lehrkraft {username} erfolgreich angelegt.', 'success')\n            else:\n                flash('Benutzername existiert bereits.', 'error')\n    \n    # Hole alle Benutzer\n    users = get_all_users()\n    \n    # Hole ausstehende exklusive Buchungen\n    from models import get_pending_exclusive_bookings\n    pending_exclusive = get_pending_exclusive_bookings()\n    pending_exclusive_display = []\n    for booking in pending_exclusive:\n        booking_dict = dict(booking)\n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        pending_exclusive_display.append({\n            'id': booking_dict['id'],\n            'date': booking_dict['date'],\n            'weekday': booking_dict['weekday'],\n            'period': booking_dict['period'],\n            'teacher_email': booking_dict.get('teacher_email'),\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'offer_label': booking_dict['offer_label'],\n            'offer_type': booking_dict['offer_type'],\n            'students': students,\n            'student_count': len(students),\n            'notes': booking_dict.get('notes')\n        })\n    \n    # Hole alle Buchungen\n    filter_date = request.args.get('filter_date', '')\n    if filter_date:\n        bookings = get_bookings_by_date(filter_date)\n    else:\n        bookings = get_all_bookings()\n    \n    # Konvertiere Buchungen f√ºr Anzeige\n    bookings_display = []\n    for booking in bookings:\n        booking_dict = dict(booking)\n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        bookings_display.append({\n            'id': booking_dict['id'],\n            'date': booking_dict['date'],\n            'weekday': booking_dict['weekday'],\n            'period': booking_dict['period'],\n            'teacher_email': booking_dict['teacher_email'],\n            'teacher_name': booking_dict.get('teacher_name', 'N/A'),\n            'teacher_class': booking_dict.get('teacher_class', 'N/A'),\n            'offer_label': booking_dict['offer_label'],\n            'offer_type': booking_dict['offer_type'],\n            'students': students,\n            'student_count': len(students),\n            'notes': booking_dict.get('notes'),\n            'is_exclusive': booking_dict.get('is_exclusive', False),\n            'is_approved': booking_dict.get('is_approved', True)\n        })\n    \n    return render_template('admin.html',\n                         users=users,\n                         bookings=bookings_display,\n                         pending_exclusive=pending_exclusive_display,\n                         filter_date=filter_date)\n\n# Route: Exklusive Buchung genehmigen\n@app.route('/admin/approve_exclusive/<int:booking_id>', methods=['POST'])\n@admin_required\ndef approve_exclusive(booking_id):\n    \"\"\"Genehmigt eine exklusive Buchung und entfernt alle anderen Buchungen f√ºr denselben Slot\"\"\"\n    from models import approve_exclusive_booking, get_booking_by_id, Booking\n    from database import db\n    \n    # Hole zuerst Buchungsdetails\n    booking = get_booking_by_id(booking_id)\n    if not booking:\n        flash('Buchung nicht gefunden.', 'error')\n        return redirect(url_for('admin'))\n    \n    booking_dict = dict(booking)\n    date_str = booking_dict['date']\n    period = booking_dict['period']\n    teacher_email = booking_dict.get('teacher_email')\n    teacher_name = booking_dict.get('teacher_name', 'Lehrkraft')\n    students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n    student_name = students[0]['name'] if students else 'Sch√ºler/in'\n    \n    # Finde alle anderen Buchungen f√ºr denselben Slot (nicht-exklusiv oder andere IDs)\n    conflicting_bookings = Booking.query.filter(\n        Booking.date == date_str,\n        Booking.period == period,\n        Booking.id != booking_id\n    ).all()\n    \n    # Sammle Daten f√ºr E-Mail-Benachrichtigungen VOR dem L√∂schen\n    affected_teachers = []\n    for conflict in conflicting_bookings:\n        conflict_students = json.loads(conflict.students_json) if conflict.students_json else []\n        affected_teachers.append({\n            'email': conflict.teacher_email,\n            'name': conflict.teacher_name or 'Lehrkraft',\n            'booking_info': {\n                'date': conflict.date,\n                'period': conflict.period,\n                'offer_label': conflict.offer_label,\n                'students': conflict_students\n            }\n        })\n    \n    # Genehmige exklusive Buchung\n    success = approve_exclusive_booking(booking_id)\n    \n    if success:\n        # L√∂sche alle konfliktierenden Buchungen\n        removed_count = 0\n        for conflict in conflicting_bookings:\n            db.session.delete(conflict)\n            removed_count += 1\n        \n        if removed_count > 0:\n            db.session.commit()\n            print(f\"[EXCLUSIVE] {removed_count} konfliktierende Buchungen f√ºr {date_str} Stunde {period} entfernt\")\n        \n        # Sende Best√§tigungs-E-Mail an den Antragsteller\n        if teacher_email:\n            from email_service import send_exclusive_approved_email\n            send_exclusive_approved_email(\n                teacher_email=teacher_email,\n                teacher_name=teacher_name,\n                student_name=student_name,\n                date_str=date_str,\n                period=period\n            )\n        \n        # Sende Stornierungs-E-Mails an betroffene Lehrer\n        from email_service import send_booking_removed_due_to_exclusive\n        for teacher in affected_teachers:\n            if teacher['email']:\n                try:\n                    send_booking_removed_due_to_exclusive(\n                        teacher_email=teacher['email'],\n                        teacher_name=teacher['name'],\n                        booking_info=teacher['booking_info'],\n                        exclusive_info={'teacher': teacher_name, 'student': student_name}\n                    )\n                    print(f\"[EXCLUSIVE] Stornierungs-E-Mail an {teacher['email']} gesendet\")\n                except Exception as e:\n                    print(f\"[EXCLUSIVE] E-Mail an {teacher['email']} fehlgeschlagen: {e}\")\n        \n        if removed_count > 0:\n            flash(f'Exklusive Buchung genehmigt. {removed_count} andere Buchung(en) wurden storniert und die Lehrkr√§fte benachrichtigt.', 'success')\n        else:\n            flash('Exklusive Buchung wurde genehmigt. Der Slot ist jetzt vollst√§ndig reserviert.', 'success')\n    else:\n        flash('Fehler beim Genehmigen der Buchung.', 'error')\n    \n    return redirect(url_for('admin'))\n\n# Route: Exklusive Buchung ablehnen\n@app.route('/admin/reject_exclusive/<int:booking_id>', methods=['POST'])\n@admin_required\ndef reject_exclusive(booking_id):\n    \"\"\"Lehnt eine exklusive Buchung ab (l√∂scht sie)\"\"\"\n    from models import reject_exclusive_booking, get_booking_by_id\n    \n    # Hole Ablehnungsgrund aus dem Formular\n    rejection_reason = request.form.get('reason', '').strip()\n    \n    # Hole Buchungsdetails f√ºr E-Mail vor dem L√∂schen\n    booking = get_booking_by_id(booking_id)\n    teacher_email = None\n    teacher_name = None\n    student_name = None\n    date_str = None\n    period = None\n    \n    if booking:\n        booking_dict = dict(booking)\n        teacher_email = booking_dict.get('teacher_email')\n        teacher_name = booking_dict.get('teacher_name', 'Lehrkraft')\n        students = json.loads(booking_dict['students_json']) if booking_dict.get('students_json') else []\n        student_name = students[0]['name'] if students else 'Sch√ºler/in'\n        date_str = booking_dict['date']\n        period = booking_dict['period']\n    \n    success = reject_exclusive_booking(booking_id)\n    if success:\n        # Sende Ablehnungs-E-Mail\n        if teacher_email:\n            from email_service import send_exclusive_rejected_email\n            send_exclusive_rejected_email(\n                teacher_email=teacher_email,\n                teacher_name=teacher_name,\n                student_name=student_name,\n                date_str=date_str,\n                period=period,\n                rejection_reason=rejection_reason\n            )\n        \n        flash('Exklusive Buchung wurde abgelehnt und gel√∂scht. Die Lehrkraft wurde benachrichtigt.', 'success')\n    else:\n        flash('Fehler beim Ablehnen der Buchung.', 'error')\n    \n    return redirect(url_for('admin'))\n\n# Route: Buchung erstellen (nur Admin)\n@app.route('/admin/create_booking', methods=['GET', 'POST'])\n@admin_required\ndef admin_create_booking():\n    \"\"\"Admin kann Buchungen f√ºr beliebige Lehrkr√§fte erstellen\"\"\"\n    from models import get_booking_by_id\n    \n    if request.method == 'POST':\n        date_str = request.form.get('date', '').strip()\n        \n        try:\n            period = int(request.form.get('period', 1))\n            teacher_id = int(request.form.get('teacher_id', 0))\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ung√ºltige Eingabe f√ºr Stunde, Lehrkraft oder Sch√ºleranzahl.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not date_str or not teacher_id or not teacher_name or not teacher_class or num_students < 1 or num_students > 5:\n            flash('Bitte f√ºllen Sie alle Pflichtfelder aus und w√§hlen Sie 1-5 Sch√ºler.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        try:\n            booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        except:\n            flash('Ung√ºltiges Datum.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        weekday = booking_date.strftime('%a')\n        period_info = get_period_info(weekday, period)\n        \n        # Pr√ºfe Kapazit√§t vor dem Erstellen der Buchung\n        current_students = count_students_for_period(date_str, period)\n        available_spots = MAX_STUDENTS_PER_PERIOD - current_students\n        \n        if num_students > available_spots:\n            flash(f'Nicht genug Pl√§tze verf√ºgbar. Nur noch {available_spots} Pl√§tze frei.', 'error')\n            users = get_all_users()\n            return render_template('admin_edit_booking.html',\n                                 booking=None,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte f√ºllen Sie alle Sch√ºlerfelder aus.', 'error')\n                users = get_all_users()\n                return render_template('admin_edit_booking.html',\n                                     booking=None,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte w√§hlen Sie ein Modul.', 'error')\n                users = get_all_users()\n                return render_template('admin_edit_booking.html',\n                                     booking=None,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        # Hole optionale Notizen (Admin-Buchungen)\n        notes = request.form.get('notes', '').strip()\n        \n        booking_id = create_booking(\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class,\n            notes=notes if notes else None\n        )\n        \n        if booking_id:\n            flash(f'Buchung erfolgreich erstellt! {len(students)} Sch√ºler f√ºr {offer_label} angemeldet.', 'success')\n            return redirect(url_for('admin'))\n        else:\n            flash('Fehler beim Erstellen der Buchung.', 'error')\n    \n    users = get_all_users()\n    return render_template('admin_edit_booking.html',\n                         booking=None,\n                         users=users,\n                         free_modules=FREE_MODULES,\n                         period_times=PERIOD_TIMES)\n\n# Route: Buchung bearbeiten (nur Admin)\n@app.route('/admin/edit_booking/<int:booking_id>', methods=['GET', 'POST'])\n@admin_required\ndef admin_edit_booking(booking_id):\n    \"\"\"Admin kann bestehende Buchungen bearbeiten\"\"\"\n    from models import get_booking_by_id, update_booking\n    \n    booking_row = get_booking_by_id(booking_id)\n    if not booking_row:\n        flash('Buchung nicht gefunden.', 'error')\n        return redirect(url_for('admin'))\n    \n    booking = dict(booking_row)\n    \n    if request.method == 'POST':\n        date_str = request.form.get('date', '').strip()\n        \n        try:\n            period = int(request.form.get('period', 1))\n            teacher_id = int(request.form.get('teacher_id', 0))\n            num_students = int(request.form.get('num_students', 1))\n        except (ValueError, TypeError):\n            flash('Ung√ºltige Eingabe f√ºr Stunde, Lehrkraft oder Sch√ºleranzahl.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        teacher_name = request.form.get('teacher_name', '').strip()\n        teacher_class = request.form.get('teacher_class', '').strip()\n        \n        if not date_str or not teacher_id or not teacher_name or not teacher_class or num_students < 1 or num_students > 5:\n            flash('Bitte f√ºllen Sie alle Pflichtfelder aus und w√§hlen Sie 1-5 Sch√ºler.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        try:\n            booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        except:\n            flash('Ung√ºltiges Datum.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        weekday = booking_date.strftime('%a')\n        period_info = get_period_info(weekday, period)\n        \n        # Pr√ºfe Kapazit√§t: Berechne verf√ºgbare Pl√§tze ohne die aktuelle Buchung\n        current_students = count_students_for_period(date_str, period)\n        old_booking_students = len(json.loads(booking['students_json']) if booking.get('students_json') else [])\n        available_spots = MAX_STUDENTS_PER_PERIOD - (current_students - old_booking_students)\n        \n        if num_students > available_spots:\n            flash(f'Nicht genug Pl√§tze verf√ºgbar. Nur noch {available_spots} Pl√§tze frei.', 'error')\n            users = get_all_users()\n            students = json.loads(booking['students_json']) if booking.get('students_json') else []\n            booking_display = dict(booking)\n            booking_display['students'] = students\n            return render_template('admin_edit_booking.html',\n                                 booking=booking_display,\n                                 users=users,\n                                 free_modules=FREE_MODULES,\n                                 period_times=PERIOD_TIMES)\n        \n        students = []\n        for i in range(num_students):\n            name = request.form.get(f'student_name_{i}', '').strip()\n            klasse = request.form.get(f'student_class_{i}', '').strip()\n            \n            if not name or not klasse:\n                flash('Bitte f√ºllen Sie alle Sch√ºlerfelder aus.', 'error')\n                users = get_all_users()\n                students = json.loads(booking['students_json']) if booking.get('students_json') else []\n                booking_display = dict(booking)\n                booking_display['students'] = students\n                return render_template('admin_edit_booking.html',\n                                     booking=booking_display,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            \n            students.append({'name': name, 'klasse': klasse})\n        \n        if period_info['type'] == 'frei':\n            selected_module = request.form.get('module', '')\n            if selected_module not in FREE_MODULES:\n                flash('Bitte w√§hlen Sie ein Modul.', 'error')\n                users = get_all_users()\n                students = json.loads(booking['students_json']) if booking.get('students_json') else []\n                booking_display = dict(booking)\n                booking_display['students'] = students\n                return render_template('admin_edit_booking.html',\n                                     booking=booking_display,\n                                     users=users,\n                                     free_modules=FREE_MODULES,\n                                     period_times=PERIOD_TIMES)\n            offer_label = selected_module\n        else:\n            offer_label = period_info['label']\n        \n        # Hole optionale Notizen (Admin kann Notizen bearbeiten)\n        notes = request.form.get('notes', '').strip()\n        \n        if update_booking(\n            booking_id=booking_id,\n            date=date_str,\n            weekday=weekday,\n            period=period,\n            teacher_id=teacher_id,\n            students=students,\n            offer_type=period_info['type'],\n            offer_label=offer_label,\n            teacher_name=teacher_name,\n            teacher_class=teacher_class,\n            notes=notes if notes else None\n        ):\n            flash(f'Buchung erfolgreich aktualisiert!', 'success')\n            return redirect(url_for('admin'))\n        else:\n            flash('Fehler beim Aktualisieren der Buchung.', 'error')\n    \n    users = get_all_users()\n    students = json.loads(booking['students_json']) if booking.get('students_json') else []\n    booking_display = dict(booking)\n    booking_display['students'] = students\n    \n    return render_template('admin_edit_booking.html',\n                         booking=booking_display,\n                         users=users,\n                         free_modules=FREE_MODULES,\n                         period_times=PERIOD_TIMES)\n\n# Route: Buchung l√∂schen (nur Admin)\n@app.route('/admin/delete_booking/<int:booking_id>', methods=['POST'])\n@admin_required\ndef delete_booking_route(booking_id):\n    \"\"\"L√∂scht eine Buchung\"\"\"\n    from models import delete_booking\n    \n    # L√∂sche Buchung\n    if delete_booking(booking_id):\n        flash('Buchung erfolgreich gel√∂scht.', 'success')\n    else:\n        flash('Buchung konnte nicht gel√∂scht werden.', 'error')\n    \n    return redirect(url_for('admin'))\n\n# Route: Slots verwalten (nur Admin)\n@app.route('/admin/manage_slots', methods=['GET', 'POST'])\n@admin_required\ndef manage_slots():\n    \"\"\"Admin kann feste Slot-Namen umbenennen\"\"\"\n    from models import update_slot_name\n    \n    if request.method == 'POST':\n        weekday = request.form.get('weekday')\n        period_str = request.form.get('period')\n        period = int(period_str) if period_str else 0\n        label = request.form.get('label', '').strip()\n        \n        if weekday and period and label:\n            if update_slot_name(weekday, period, label):\n                flash(f'Slot-Name erfolgreich aktualisiert!', 'success')\n            else:\n                flash('Fehler beim Aktualisieren des Slot-Namens.', 'error')\n        else:\n            flash('Bitte f√ºllen Sie alle Felder aus.', 'error')\n        \n        return redirect(url_for('manage_slots'))\n    \n    fixed_slots = []\n    weekdays = {\n        'Mon': 'Montag',\n        'Tue': 'Dienstag', \n        'Wed': 'Mittwoch',\n        'Thu': 'Donnerstag',\n        'Fri': 'Freitag'\n    }\n    \n    for weekday_code, weekday_name in weekdays.items():\n        if weekday_code in FIXED_OFFERS:\n            for period, default_label in FIXED_OFFERS[weekday_code].items():\n                period_info = get_period_info(weekday_code, period)\n                fixed_slots.append({\n                    'weekday_code': weekday_code,\n                    'weekday_name': weekday_name,\n                    'period': period,\n                    'period_time': f\"{PERIOD_TIMES[period]['start']} - {PERIOD_TIMES[period]['end']}\",\n                    'default_label': default_label,\n                    'current_label': period_info['label']\n                })\n    \n    return render_template('admin_manage_slots.html', \n                         fixed_slots=fixed_slots)\n\n@app.route('/admin/block_slot', methods=['POST'])\n@admin_required\ndef admin_block_slot():\n    \"\"\"Admin blockiert einen Slot f√ºr Beratungsgespr√§che\"\"\"\n    from models import block_slot, is_slot_blocked\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ung√ºltiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    date_str = request.form.get('date', '').strip()\n    period = request.form.get('period', type=int)\n    reason = request.form.get('reason', 'Beratung').strip()\n    icon = request.form.get('icon', 'üîß').strip()\n    \n    # Validiere Grund-L√§nge\n    if reason and len(reason) > 200:\n        reason = reason[:200]\n    \n    # Validiere Icon\n    allowed_icons = ['üîß', 'üí¨', 'üìö', 'üèñÔ∏è', 'üéâ', '‚ö†Ô∏è']\n    if icon not in allowed_icons:\n        icon = 'üîß'\n    \n    if not date_str or not period:\n        flash('Ung√ºltige Slot-Daten.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    try:\n        booking_date = datetime.strptime(date_str, '%Y-%m-%d').date()\n        weekday = booking_date.strftime('%a')\n    except:\n        flash('Ung√ºltiges Datum.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    if is_slot_blocked(date_str, period):\n        flash('Dieser Slot ist bereits blockiert.', 'warning')\n    else:\n        admin_id = session.get('user_id')\n        if block_slot(date_str, weekday, period, admin_id, reason, icon):\n            flash(f'Slot erfolgreich f√ºr {reason} blockiert.', 'success')\n        else:\n            flash('Fehler beim Blockieren des Slots.', 'error')\n    \n    return redirect(request.referrer or url_for('dashboard'))\n\n@app.route('/admin/unblock_slot', methods=['POST'])\n@admin_required\ndef admin_unblock_slot():\n    \"\"\"Admin gibt einen blockierten Slot wieder frei\"\"\"\n    from models import unblock_slot\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ung√ºltiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    date_str = request.form.get('date', '').strip()\n    period = request.form.get('period', type=int)\n    \n    if not date_str or not period:\n        flash('Ung√ºltige Slot-Daten.', 'error')\n        return redirect(request.referrer or url_for('dashboard'))\n    \n    if unblock_slot(date_str, period):\n        flash('Slot erfolgreich freigegeben.', 'success')\n    else:\n        flash('Fehler beim Freigeben des Slots.', 'error')\n    \n    return redirect(request.referrer or url_for('dashboard'))\n\n@app.route('/admin/setup_holidays_2026', methods=['POST'])\n@admin_required\ndef admin_setup_holidays_2026():\n    \"\"\"Legt alle Niedersachsen-Ferien und Feiertage f√ºr 2026 automatisch an\"\"\"\n    from models import bulk_block_slots\n    \n    # CSRF-Token Validierung\n    csrf_token = request.form.get('csrf_token', '')\n    if not validate_csrf_token(csrf_token):\n        flash('Ung√ºltiges Sicherheits-Token.', 'error')\n        return redirect(url_for('admin_bulk_block'))\n    \n    admin_id = session.get('user_id')\n    total_blocked = 0\n    total_skipped = 0\n    \n    # Niedersachsen Schulferien 2026\n    holidays_2026 = [\n        # Winterferien: 02.02. - 03.02.2026\n        ('2026-02-02', '2026-02-03', '‚ùÑÔ∏è Winterferien', '‚ùÑÔ∏è'),\n        # Osterferien: 23.03. - 04.04.2026\n        ('2026-03-23', '2026-04-04', 'üê£ Osterferien', 'üê£'),\n        # Pfingstferien: 26.05.2026\n        ('2026-05-26', '2026-05-26', 'üå∏ Pfingstferien', 'üå∏'),\n        # Sommerferien: 16.07. - 26.08.2026\n        ('2026-07-16', '2026-08-26', '‚òÄÔ∏è Sommerferien', '‚òÄÔ∏è'),\n        # Herbstferien: 12.10. - 24.10.2026\n        ('2026-10-12', '2026-10-24', 'üçÇ Herbstferien', 'üçÇ'),\n        # Weihnachtsferien: 23.12.2026 - 06.01.2027\n        ('2026-12-23', '2027-01-06', 'üéÑ Weihnachtsferien', 'üéÑ'),\n    ]\n    \n    # Gesetzliche Feiertage Niedersachsen 2026\n    public_holidays_2026 = [\n        ('2026-01-01', '2026-01-01', 'üéÜ Neujahr', 'üéÜ'),\n        ('2026-04-03', '2026-04-03', '‚úùÔ∏è Karfreitag', '‚úùÔ∏è'),\n        ('2026-04-06', '2026-04-06', '‚úùÔ∏è Ostermontag', '‚úùÔ∏è'),\n        ('2026-05-01', '2026-05-01', 'üîß Tag der Arbeit', 'üîß'),\n        ('2026-05-14', '2026-05-14', '‚òÅÔ∏è Christi Himmelfahrt', '‚òÅÔ∏è'),\n        ('2026-05-25', '2026-05-25', 'üïäÔ∏è Pfingstmontag', 'üïäÔ∏è'),\n        ('2026-10-03', '2026-10-03', 'üá©üá™ Tag der Deutschen Einheit', 'üá©üá™'),\n        ('2026-10-31', '2026-10-31', '‚õ™ Reformationstag', '‚õ™'),\n        ('2026-12-25', '2026-12-25', 'üéÑ 1. Weihnachtstag', 'üéÑ'),\n        ('2026-12-26', '2026-12-26', 'üéÑ 2. Weihnachtstag', 'üéÑ'),\n    ]\n    \n    all_holidays = holidays_2026 + public_holidays_2026\n    \n    for start_date, end_date, reason, icon in all_holidays:\n        result = bulk_block_slots(start_date, end_date, admin_id, reason, icon=icon)\n        if result['success']:\n            total_blocked += result['blocked_count']\n            total_skipped += result['skipped_count']\n    \n    flash(f'‚úÖ Ferien 2026 angelegt: {total_blocked} Slots blockiert, {total_skipped} bereits vorhanden.', 'success')\n    return redirect(url_for('admin_bulk_block'))\n\n@app.route('/admin/bulk_block', methods=['GET', 'POST'])\n@admin_required\ndef admin_bulk_block():\n    \"\"\"Admin kann mehrere Slots auf einmal sperren (z.B. f√ºr Ferien)\"\"\"\n    from models import bulk_block_slots, bulk_unblock_slots, get_all_blocked_slots\n    \n    blocked_slots = get_all_blocked_slots()\n    \n    if request.method == 'POST':\n        # CSRF-Token Validierung\n        csrf_token = request.form.get('csrf_token', '')\n        if not validate_csrf_token(csrf_token):\n            flash('Ung√ºltiges Sicherheits-Token. Bitte versuchen Sie es erneut.', 'error')\n            return redirect(url_for('admin_bulk_block'))\n        \n        action = request.form.get('action', 'block')\n        start_date = request.form.get('start_date', '').strip()\n        end_date = request.form.get('end_date', '').strip()\n        reason = request.form.get('reason', 'Ferien').strip()\n        \n        # Stunden ausw√§hlen (Checkboxen)\n        periods = request.form.getlist('periods', type=int)\n        if not periods:\n            periods = None  # Alle Stunden\n        \n        # Validierung\n        if not start_date or not end_date:\n            flash('Bitte Start- und Enddatum angeben.', 'error')\n            return redirect(url_for('admin_bulk_block'))\n        \n        try:\n            start = datetime.strptime(start_date, '%Y-%m-%d')\n            end = datetime.strptime(end_date, '%Y-%m-%d')\n            if start > end:\n                flash('Startdatum muss vor dem Enddatum liegen.', 'error')\n                return redirect(url_for('admin_bulk_block'))\n        except:\n            flash('Ung√ºltiges Datumsformat.', 'error')\n            return redirect(url_for('admin_bulk_block'))\n        \n        admin_id = session.get('user_id')\n        \n        if action == 'block':\n            result = bulk_block_slots(start_date, end_date, admin_id, reason, periods)\n            if result['success']:\n                flash(f\"‚úÖ {result['blocked_count']} Slots erfolgreich gesperrt ({result['skipped_count']} bereits gesperrt √ºbersprungen).\", 'success')\n            else:\n                flash(f\"Fehler beim Sperren: {result.get('error', 'Unbekannter Fehler')}\", 'error')\n        elif action == 'unblock':\n            result = bulk_unblock_slots(start_date, end_date, periods)\n            if result['success']:\n                flash(f\"‚úÖ {result['unblocked_count']} Slots erfolgreich freigegeben.\", 'success')\n            else:\n                flash(f\"Fehler beim Freigeben: {result.get('error', 'Unbekannter Fehler')}\", 'error')\n        \n        return redirect(url_for('admin_bulk_block'))\n    \n    return render_template('admin_bulk_block.html', blocked_slots=blocked_slots)\n\n# ============================================================================\n# Notifications & Server-Sent Events (SSE) Routes\n# ============================================================================\n\n# SSE deaktiviert - verursacht Worker-Timeouts in Produktion mit Gunicorn\n# @app.route('/notifications/stream')\n# @admin_required\n# def notifications_stream():\n#     \"\"\"SSE-Endpunkt f√ºr Echtzeit-Benachrichtigungen (nur f√ºr Admins)\"\"\"\n#     def event_stream():\n#         \"\"\"Generator f√ºr Server-Sent Events\"\"\"\n#         q = queue.Queue(maxsize=50)\n#         \n#         with subscribers_lock:\n#             notification_subscribers.append(q)\n#         \n#         try:\n#             while True:\n#                 try:\n#                     message = q.get(timeout=30)\n#                     yield f\"data: {json.dumps(message)}\\n\\n\"\n#                 except queue.Empty:\n#                     yield f\"data: {json.dumps({'type': 'ping'})}\\n\\n\"\n#         finally:\n#             with subscribers_lock:\n#                 if q in notification_subscribers:\n#                     notification_subscribers.remove(q)\n#     \n#     return Response(event_stream(), mimetype='text/event-stream')\n\n@app.route('/api/notifications/recent', methods=['GET'])\n@admin_required\ndef api_get_recent_notifications():\n    \"\"\"Holt die neuesten Benachrichtigungen\"\"\"\n    limit = request.args.get('limit', 10, type=int)\n    limit = min(limit, 50)\n    \n    notifications = get_recent_notifications(recipient_role='admin', limit=limit)\n    return jsonify({\n        'success': True,\n        'notifications': notifications\n    })\n\n@app.route('/api/notifications/unread_count', methods=['GET'])\n@admin_required\ndef api_get_unread_count():\n    \"\"\"Holt die Anzahl der ungelesenen Benachrichtigungen\"\"\"\n    count = get_unread_notification_count(recipient_role='admin')\n    return jsonify({\n        'success': True,\n        'count': count\n    })\n\n@app.route('/api/notifications/<int:notification_id>/mark_read', methods=['POST'])\n@admin_required\ndef api_mark_notification_read(notification_id):\n    \"\"\"Markiert eine Benachrichtigung als gelesen\"\"\"\n    csrf_token = request.json.get('csrf_token', '') if request.json else ''\n    if not validate_csrf_token(csrf_token):\n        return jsonify({\n            'success': False,\n            'error': 'Invalid CSRF token'\n        }), 403\n    \n    success = mark_notification_as_read(notification_id)\n    return jsonify({\n        'success': success\n    })\n\n@app.route('/api/notifications/mark_all_read', methods=['POST'])\n@admin_required\ndef api_mark_all_notifications_read():\n    \"\"\"Markiert alle Benachrichtigungen als gelesen\"\"\"\n    csrf_token = request.json.get('csrf_token', '') if request.json else ''\n    if not validate_csrf_token(csrf_token):\n        return jsonify({\n            'success': False,\n            'error': 'Invalid CSRF token'\n        }), 403\n    \n    success = mark_all_notifications_as_read(recipient_role='admin')\n    return jsonify({\n        'success': success\n    })\n\n# Error-Handler f√ºr Production mit Fallback\n@app.errorhandler(404)\ndef not_found_error(error):\n    \"\"\"Handler f√ºr 404 Not Found Fehler\"\"\"\n    try:\n        return render_template('errors/404.html'), 404\n    except Exception:\n        return '<h1>404 - Seite nicht gefunden</h1><p><a href=\"/\">Zur Startseite</a></p>', 404\n\n@app.errorhandler(500)\ndef internal_error(error):\n    \"\"\"Handler f√ºr 500 Internal Server Error\"\"\"\n    try:\n        db.session.rollback()\n    except Exception:\n        pass\n    try:\n        return render_template('errors/500.html'), 500\n    except Exception:\n        return '<h1>500 - Interner Serverfehler</h1><p>Bitte versuchen Sie es sp√§ter erneut.</p>', 500\n\n@app.errorhandler(403)\ndef forbidden_error(error):\n    \"\"\"Handler f√ºr 403 Forbidden Fehler\"\"\"\n    try:\n        return render_template('errors/403.html'), 403\n    except Exception:\n        return '<h1>403 - Zugriff verweigert</h1><p><a href=\"/\">Zur Startseite</a></p>', 403\n\n# Logging-Konfiguration f√ºr Production\nimport logging\nfrom logging.handlers import RotatingFileHandler\nimport os\n\nif os.environ.get('FLASK_ENV') == 'production' or not os.environ.get('FLASK_DEBUG'):\n    if not os.path.exists('logs'):\n        try:\n            os.mkdir('logs')\n        except OSError:\n            pass\n    \n    try:\n        file_handler = RotatingFileHandler('logs/sportoase.log', maxBytes=10240000, backupCount=10)\n        file_handler.setFormatter(logging.Formatter(\n            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'\n        ))\n        file_handler.setLevel(logging.INFO)\n        app.logger.addHandler(file_handler)\n        app.logger.setLevel(logging.INFO)\n        app.logger.info('SportOase Buchungssystem gestartet (Production Mode)')\n    except Exception as e:\n        print(f\"Fehler beim Einrichten des Logging-Handlers: {e}\")\n\nif __name__ == '__main__':\n    # Starte die Anwendung\n    app.run(host='0.0.0.0', port=5000, debug=True)\n","path":null,"size_bytes":98758,"size_tokens":null},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"email-validator>=2.3.0\",\n    \"flask>=3.1.2\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"gunicorn>=23.0.0\",\n    \"psycopg2-binary>=2.9.11\",\n    \"pytz>=2025.2\",\n    \"werkzeug>=3.1.3\",\n]\n","path":null,"size_bytes":323,"size_tokens":null},"email_service.py":{"content":"import os\nimport json\nimport logging\nfrom datetime import datetime\n\nimport resend\n\nfrom config import ADMIN_EMAIL\n\n\ndef format_date_german(date_str):\n    \"\"\"Konvertiert YYYY-MM-DD zu TT.MM.JJJJ\"\"\"\n    try:\n        if '-' in str(date_str):\n            parts = str(date_str).split('-')\n            if len(parts) == 3:\n                return f\"{parts[2]}.{parts[1]}.{parts[0]}\"\n    except:\n        pass\n    return str(date_str)\n\n\ndef get_german_weekday(weekday_abbr):\n    \"\"\"Konvertiert englische Wochentag-Abk√ºrzung zu deutschem Namen\"\"\"\n    weekday_map = {\n        'Mon': 'Montag',\n        'Tue': 'Dienstag',\n        'Wed': 'Mittwoch',\n        'Thu': 'Donnerstag',\n        'Fri': 'Freitag',\n        'Sat': 'Samstag',\n        'Sun': 'Sonntag'\n    }\n    return weekday_map.get(weekday_abbr, weekday_abbr)\n\n\ndef get_resend_credentials():\n    \"\"\"Holt Resend API-Key - zuerst aus ENV, dann √ºber Replit Connector\"\"\"\n\n    env_api_key = os.environ.get('RESEND_API_KEY')\n    env_from_email = os.environ.get('RESEND_FROM_EMAIL',\n                                    'SportOase <mauro@sportoase.app>')\n\n    if env_api_key:\n        print(f\"[EMAIL] Resend API-Key aus Environment Variable gefunden\")\n        return env_api_key, env_from_email\n\n    hostname = os.environ.get('REPLIT_CONNECTORS_HOSTNAME')\n\n    x_replit_token = None\n    if os.environ.get('REPL_IDENTITY'):\n        x_replit_token = 'repl ' + os.environ.get('REPL_IDENTITY')\n    elif os.environ.get('WEB_REPL_RENEWAL'):\n        x_replit_token = 'depl ' + os.environ.get('WEB_REPL_RENEWAL')\n\n    if not x_replit_token or not hostname:\n        print(\"[EMAIL] Weder ENV noch Replit Connector verf√ºgbar\")\n        return None, None\n\n    try:\n        import requests\n        response = requests.get(\n            f'https://{hostname}/api/v2/connection?include_secrets=true&connector_names=resend',\n            headers={\n                'Accept': 'application/json',\n                'X_REPLIT_TOKEN': x_replit_token\n            },\n            timeout=10)\n        data = response.json()\n        connection = data.get('items', [{}])[0] if data.get('items') else {}\n        settings = connection.get('settings', {})\n\n        api_key = settings.get('api_key')\n        from_email = settings.get('from_email')\n\n        if api_key:\n            print(f\"[EMAIL] Resend API-Key √ºber Replit Connector gefunden\")\n            return api_key, from_email\n        else:\n            print(\"[EMAIL] Resend nicht konfiguriert\")\n            return None, None\n\n    except Exception as e:\n        print(f\"[EMAIL] Fehler beim Abrufen der Resend-Credentials: {e}\")\n        return None, None\n\n\ndef send_email_resend(to_email, subject, body_html, body_text=None):\n    \"\"\"Sendet E-Mail √ºber Resend API\"\"\"\n    logger = logging.getLogger(__name__)\n\n    logger.info(f\"Versuche E-Mail zu senden an: {to_email}\")\n\n    try:\n        api_key, from_email = get_resend_credentials()\n\n        if not api_key:\n            print(\n                f\"[EMAIL] WARNUNG: Resend nicht konfiguriert - E-Mail an {to_email} nicht gesendet\"\n            )\n            return False\n\n        resend.api_key = api_key\n\n        from_address = \"SportOase <mauro@sportoase.app>\"\n\n        params = {\n            \"from\": from_address,\n            \"to\": [to_email],\n            \"subject\": subject,\n            \"html\": body_html,\n        }\n\n        if body_text:\n            params[\"text\"] = body_text\n\n        print(f\"[EMAIL] Sende von {from_address} an {to_email}...\")\n        result = resend.Emails.send(params)\n\n        print(\n            f\"[EMAIL] Erfolgreich gesendet an {to_email} (ID: {result.get('id', 'unknown')})\"\n        )\n        return True\n\n    except Exception as e:\n        print(f\"[EMAIL] FEHLER beim E-Mail-Versand an {to_email}: {e}\")\n        return False\n\n\ndef get_email_styles():\n    \"\"\"Zentrale Styles f√ºr alle E-Mails\"\"\"\n    return {\n        'container': 'font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff;',\n        'header': 'background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); padding: 24px 30px; border-radius: 12px 12px 0 0;',\n        'header_text': 'color: white; margin: 0; font-size: 20px; font-weight: 600;',\n        'body': 'padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 12px 12px;',\n        'card': 'background: #f8fafc; border-radius: 10px; padding: 20px; margin: 20px 0;',\n        'info_row': 'display: flex; padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #E91E63;',\n        'label': 'color: #E91E63; font-weight: 600; min-width: 100px;',\n        'value': 'color: #1f2937;',\n        'success_box': 'background: #dcfce7; border: 1px solid #86efac; color: #166534; padding: 16px 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;',\n        'warning_box': 'background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px;',\n        'error_box': 'background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px;',\n        'footer': 'margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;',\n    }\n\n\ndef create_booking_notification_email(data):\n    \"\"\"Erstellt eine formatierte E-Mail f√ºr Buchungsbenachrichtigungen (Admin)\"\"\"\n    from config import PERIOD_TIMES\n    \n    teacher = data.get(\"teacher_name\", \"Unbekannt\")\n    teacher_class = data.get(\"teacher_class\", \"\")\n    date_raw = data.get(\"date\", \"\")\n    date = format_date_german(date_raw)\n    weekday_raw = data.get(\"weekday\", \"\")\n    weekday = get_german_weekday(weekday_raw)\n    period = data.get(\"period\", \"\")\n    period_time = PERIOD_TIMES.get(period, \"\")\n    offer = data.get(\"offer_label\", \"\")\n    offer_type = data.get(\"offer_type\", \"\")\n\n    students_json = data.get(\"students_json\", \"[]\")\n    students = json.loads(students_json) if isinstance(students_json, str) else students_json\n    count = len(students)\n\n    students_html = \"\".join([\n        f'<div style=\"padding: 8px 12px; background: white; border-radius: 6px; margin: 6px 0;\">‚Ä¢ {s[\"name\"]} (Klasse {s[\"klasse\"]})</div>'\n        for s in students\n    ]) if students else '<div style=\"color: #6b7280;\">Keine Sch√ºler*innen</div>'\n\n    subject = f\"üìö Neue Buchung: {offer} am {date}\"\n\n    html = f\"\"\"\n    <!DOCTYPE html><html><head><meta charset=\"utf-8\"></head>\n    <body style=\"margin: 0; padding: 20px; background: #f3f4f6;\">\n        <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n            <div style=\"background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding: 24px 30px;\">\n                <h2 style=\"color: white; margin: 0; font-size: 20px;\">üìö Neue Buchung eingegangen</h2>\n            </div>\n            <div style=\"padding: 30px;\">\n                <div style=\"background: #f8fafc; border-radius: 10px; padding: 20px;\">\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #3b82f6;\">\n                        <strong style=\"color: #3b82f6;\">üë§ Lehrkraft:</strong> {teacher} {f\"({teacher_class})\" if teacher_class else \"\"}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #3b82f6;\">\n                        <strong style=\"color: #3b82f6;\">üìÖ Datum:</strong> {weekday}, {date}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #3b82f6;\">\n                        <strong style=\"color: #3b82f6;\">‚è∞ Zeit:</strong> {period}. Stunde ({period_time} Uhr)\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #3b82f6;\">\n                        <strong style=\"color: #3b82f6;\">üìã Angebot:</strong> {offer} <span style=\"background: #3b82f6; color: white; padding: 2px 10px; border-radius: 12px; font-size: 11px; margin-left: 8px;\">{offer_type.upper()}</span>\n                    </div>\n                    <div style=\"padding: 16px; background: white; border-radius: 8px; margin: 12px 0;\">\n                        <strong style=\"color: #3b82f6;\">üë• Sch√ºler*innen ({count}):</strong>\n                        <div style=\"margin-top: 10px;\">{students_html}</div>\n                    </div>\n                </div>\n                <div style=\"margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                    Automatisch generiert am {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}<br>\n                    SportOase ‚Äì Ernst-Reuter-Schule Pattensen\n                </div>\n            </div>\n        </div>\n    </body></html>\n    \"\"\"\n\n    text = f\"\"\"\nNeue Buchung ‚Äì SportOase\n\nLehrkraft: {teacher} {f\"({teacher_class})\" if teacher_class else \"\"}\nDatum: {weekday}, {date}\nZeit: {period}. Stunde ({period_time} Uhr)\nAngebot: {offer} ({offer_type})\n\nSch√ºler*innen ({count}):\n{', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])}\n\n---\nAutomatisch generiert am {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n    \"\"\"\n\n    return subject, html, text\n\n\ndef send_booking_notification(data):\n    \"\"\"Sendet Buchungsbenachrichtigung an Admin\"\"\"\n    subject, html, text = create_booking_notification_email(data)\n    return send_email_resend(ADMIN_EMAIL, subject, html, text)\n\n\ndef create_user_confirmation_email(data):\n    \"\"\"Erstellt eine Best√§tigungs-E-Mail f√ºr den buchenden Benutzer\"\"\"\n    from config import PERIOD_TIMES\n    \n    teacher = data.get(\"teacher_name\", \"Unbekannt\")\n    teacher_class = data.get(\"teacher_class\", \"\")\n    date_raw = data.get(\"date\", \"\")\n    date = format_date_german(date_raw)\n    weekday_raw = data.get(\"weekday\", \"\")\n    weekday = get_german_weekday(weekday_raw)\n    period = data.get(\"period\", \"\")\n    period_time = PERIOD_TIMES.get(period, \"\")\n    offer = data.get(\"offer_label\", \"\")\n    offer_type = data.get(\"offer_type\", \"\")\n\n    students_json = data.get(\"students_json\", \"[]\")\n    students = json.loads(students_json) if isinstance(students_json, str) else students_json\n    count = len(students)\n\n    students_html = \"\".join([\n        f'<div style=\"padding: 8px 12px; background: white; border-radius: 6px; margin: 6px 0;\">‚Ä¢ {s[\"name\"]} (Klasse {s[\"klasse\"]})</div>'\n        for s in students\n    ]) if students else '<div style=\"color: #6b7280;\">Keine Sch√ºler*innen</div>'\n\n    subject = f\"‚úÖ Buchung best√§tigt: {offer} am {date}\"\n\n    html = f\"\"\"\n    <!DOCTYPE html><html><head><meta charset=\"utf-8\"></head>\n    <body style=\"margin: 0; padding: 20px; background: #f3f4f6;\">\n        <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n            <div style=\"background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); padding: 24px 30px;\">\n                <h2 style=\"color: white; margin: 0; font-size: 20px;\">‚úÖ Buchung best√§tigt</h2>\n            </div>\n            <div style=\"padding: 30px;\">\n                <div style=\"background: #dcfce7; border: 1px solid #86efac; color: #166534; padding: 16px 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;\">\n                    <strong>üéâ Deine Buchung wurde erfolgreich gespeichert!</strong>\n                </div>\n                <div style=\"background: #f8fafc; border-radius: 10px; padding: 20px;\">\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #E91E63;\">\n                        <strong style=\"color: #E91E63;\">üë§ Lehrkraft:</strong> {teacher} {f\"({teacher_class})\" if teacher_class else \"\"}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #E91E63;\">\n                        <strong style=\"color: #E91E63;\">üìÖ Datum:</strong> {weekday}, {date}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #E91E63;\">\n                        <strong style=\"color: #E91E63;\">‚è∞ Zeit:</strong> {period}. Stunde ({period_time} Uhr)\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #E91E63;\">\n                        <strong style=\"color: #E91E63;\">üìã Angebot:</strong> {offer} <span style=\"background: #E91E63; color: white; padding: 2px 10px; border-radius: 12px; font-size: 11px; margin-left: 8px;\">{offer_type.upper()}</span>\n                    </div>\n                    <div style=\"padding: 16px; background: white; border-radius: 8px; margin: 12px 0;\">\n                        <strong style=\"color: #E91E63;\">üë• Angemeldete Sch√ºler*innen ({count}):</strong>\n                        <div style=\"margin-top: 10px;\">{students_html}</div>\n                    </div>\n                </div>\n                <div style=\"margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                    Bei Fragen melde dich gerne bei Mauro.<br>\n                    SportOase ‚Äì Ernst-Reuter-Schule Pattensen\n                </div>\n            </div>\n        </div>\n    </body></html>\n    \"\"\"\n\n    text = f\"\"\"\nBuchung best√§tigt ‚Äì SportOase\n\nDeine Buchung wurde erfolgreich gespeichert!\n\nLehrkraft: {teacher} {f\"({teacher_class})\" if teacher_class else \"\"}\nDatum: {weekday}, {date}\nZeit: {period}. Stunde ({period_time} Uhr)\nAngebot: {offer} ({offer_type})\n\nAngemeldete Sch√ºler*innen ({count}):\n{', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])}\n\n---\nBei Fragen melde dich gerne bei Mauro.\nSportOase ‚Äì Ernst-Reuter-Schule Pattensen\n    \"\"\"\n\n    return subject, html, text\n\n\ndef send_user_booking_confirmation(email, data):\n    \"\"\"Sendet Buchungsbest√§tigung an den buchenden Benutzer\"\"\"\n    subject, html, text = create_user_confirmation_email(data)\n    return send_email_resend(email, subject, html, text)\n\n\ndef send_exclusive_pending_email(email, data):\n    \"\"\"Sendet E-Mail bei ausstehender Einzelbuchung (Freigabe erforderlich)\"\"\"\n    from config import PERIOD_TIMES\n    \n    students = data.get('students', [])\n    if not students:\n        return False\n    \n    student = students[0]\n    student_name = student.get('name', 'Unbekannt')\n    student_class = student.get('klasse', '')\n    \n    teacher = data.get('teacher_name', 'Unbekannt')\n    teacher_class = data.get('teacher_class', '')\n    date = format_date_german(data.get('date', 'Unbekannt'))\n    weekday_raw = data.get('weekday', '')\n    weekday = get_german_weekday(weekday_raw)\n    period = data.get('period', '?')\n    period_time = PERIOD_TIMES.get(period, \"\")\n    offer = data.get('offer_label', 'Unbekannt')\n    \n    subject = f\"‚è≥ Einzelbuchung angefragt ‚Äì Warte auf Freigabe\"\n    \n    html = f\"\"\"\n    <!DOCTYPE html><html><head><meta charset=\"utf-8\"></head>\n    <body style=\"margin: 0; padding: 20px; background: #f3f4f6;\">\n        <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n            <div style=\"background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); padding: 24px 30px;\">\n                <h2 style=\"color: white; margin: 0; font-size: 20px;\">‚è≥ Einzelbuchung angefragt</h2>\n            </div>\n            <div style=\"padding: 30px;\">\n                <div style=\"background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px;\">\n                    <strong>‚ö†Ô∏è Deine Buchung wartet auf Freigabe durch Mauro</strong>\n                    <p style=\"margin: 10px 0 0 0; font-size: 14px;\">Du bekommst eine E-Mail, sobald deine Anfrage bearbeitet wurde.</p>\n                </div>\n                <div style=\"background: #f8fafc; border-radius: 10px; padding: 20px;\">\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #f59e0b;\">\n                        <strong style=\"color: #E91E63;\">üë§ Lehrkraft:</strong> {teacher} {f\"({teacher_class})\" if teacher_class else \"\"}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #f59e0b;\">\n                        <strong style=\"color: #E91E63;\">üìÖ Datum:</strong> {weekday}, {date}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #f59e0b;\">\n                        <strong style=\"color: #E91E63;\">‚è∞ Zeit:</strong> {period}. Stunde ({period_time} Uhr)\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #f59e0b;\">\n                        <strong style=\"color: #E91E63;\">üìã Angebot:</strong> {offer}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #f59e0b;\">\n                        <strong style=\"color: #E91E63;\">üë§ Sch√ºler*in:</strong> {student_name} (Klasse {student_class})\n                    </div>\n                </div>\n                <div style=\"margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                    Bei Fragen melde dich gerne bei Mauro.<br>\n                    SportOase ‚Äì Ernst-Reuter-Schule Pattensen\n                </div>\n            </div>\n        </div>\n    </body></html>\n    \"\"\"\n    \n    text = f\"\"\"\nEinzelbuchung angefragt ‚Äì SportOase\n\nDeine Buchung wartet auf Freigabe durch Mauro.\nDu bekommst eine E-Mail, sobald deine Anfrage bearbeitet wurde.\n\nLehrkraft: {teacher} {f\"({teacher_class})\" if teacher_class else \"\"}\nDatum: {weekday}, {date}\nZeit: {period}. Stunde ({period_time} Uhr)\nAngebot: {offer}\nSch√ºler*in: {student_name} (Klasse {student_class})\n\n---\nBei Fragen melde dich gerne bei Mauro.\nSportOase ‚Äì Ernst-Reuter-Schule Pattensen\n    \"\"\"\n    \n    return send_email_resend(email, subject, html, text)\n\n\ndef send_exclusive_approved_email(teacher_email, teacher_name, student_name, date_str, period):\n    \"\"\"Sendet Best√§tigungs-E-Mail wenn eine exklusive Buchung genehmigt wurde\"\"\"\n    from config import PERIOD_TIMES\n\n    period_time = PERIOD_TIMES.get(period, \"\")\n    date_formatted = format_date_german(date_str)\n\n    subject = f\"‚úÖ Einzelbuchung genehmigt ‚Äì SportOase\"\n\n    html = f\"\"\"\n    <!DOCTYPE html><html><head><meta charset=\"utf-8\"></head>\n    <body style=\"margin: 0; padding: 20px; background: #f3f4f6;\">\n        <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n            <div style=\"background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); padding: 24px 30px;\">\n                <h2 style=\"color: white; margin: 0; font-size: 20px;\">üéâ Einzelbuchung genehmigt!</h2>\n            </div>\n            <div style=\"padding: 30px;\">\n                <div style=\"background: #dcfce7; border: 1px solid #86efac; color: #166534; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px;\">\n                    <strong>Hallo {teacher_name}!</strong>\n                    <p style=\"margin: 10px 0 0 0;\">Deine exklusive Einzelbuchung wurde <strong>von Mauro genehmigt</strong>. üéâ</p>\n                </div>\n                <div style=\"background: #f8fafc; border-radius: 10px; padding: 20px;\">\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #22c55e;\">\n                        <strong style=\"color: #E91E63;\">üìÖ Datum:</strong> {date_formatted}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #22c55e;\">\n                        <strong style=\"color: #E91E63;\">‚è∞ Zeit:</strong> {period}. Stunde ({period_time} Uhr)\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #22c55e;\">\n                        <strong style=\"color: #E91E63;\">üë§ Sch√ºler*in:</strong> {student_name}\n                    </div>\n                </div>\n                <div style=\"background: #dbeafe; border: 1px solid #93c5fd; color: #1e40af; padding: 14px 18px; border-radius: 10px; margin-top: 20px; font-size: 14px;\">\n                    üí° Der Slot ist jetzt vollst√§ndig f√ºr deine*n Sch√ºler*in reserviert.\n                </div>\n                <div style=\"margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                    Bei Fragen melde dich gerne bei Mauro.<br>\n                    SportOase ‚Äì Ernst-Reuter-Schule Pattensen\n                </div>\n            </div>\n        </div>\n    </body></html>\n    \"\"\"\n\n    text = f\"\"\"\nEinzelbuchung genehmigt ‚Äì SportOase\n\nHallo {teacher_name}!\n\nDeine exklusive Einzelbuchung wurde von Mauro genehmigt.\n\nDatum: {date_formatted}\nZeit: {period}. Stunde ({period_time} Uhr)\nSch√ºler*in: {student_name}\n\nDer Slot ist jetzt vollst√§ndig f√ºr deine*n Sch√ºler*in reserviert.\n\n---\nBei Fragen melde dich gerne bei Mauro.\nSportOase ‚Äì Ernst-Reuter-Schule Pattensen\n    \"\"\"\n\n    return send_email_resend(teacher_email, subject, html, text)\n\n\ndef send_exclusive_rejected_email(teacher_email, teacher_name, student_name, date_str, period, rejection_reason=None):\n    \"\"\"Sendet Ablehnungs-E-Mail wenn eine exklusive Buchung abgelehnt wurde\"\"\"\n    from config import PERIOD_TIMES\n\n    period_time = PERIOD_TIMES.get(period, \"\")\n    date_formatted = format_date_german(date_str)\n    \n    reason_html = \"\"\n    reason_text = \"\"\n    if rejection_reason:\n        reason_html = f\"\"\"\n            <div style=\"background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 14px 18px; border-radius: 10px; margin: 16px 0;\">\n                <strong>üí¨ Begr√ºndung von Mauro:</strong><br>\n                <span style=\"display: block; margin-top: 8px;\">{rejection_reason}</span>\n            </div>\n        \"\"\"\n        reason_text = f\"\\nBegr√ºndung von Mauro:\\n{rejection_reason}\\n\"\n\n    subject = f\"‚ùå Einzelbuchung abgelehnt ‚Äì SportOase\"\n\n    html = f\"\"\"\n    <!DOCTYPE html><html><head><meta charset=\"utf-8\"></head>\n    <body style=\"margin: 0; padding: 20px; background: #f3f4f6;\">\n        <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n            <div style=\"background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); padding: 24px 30px;\">\n                <h2 style=\"color: white; margin: 0; font-size: 20px;\">Einzelbuchung abgelehnt</h2>\n            </div>\n            <div style=\"padding: 30px;\">\n                <div style=\"background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px;\">\n                    <strong>Hallo {teacher_name},</strong>\n                    <p style=\"margin: 10px 0 0 0;\">Leider wurde deine exklusive Einzelbuchung <strong>von Mauro abgelehnt</strong>.</p>\n                </div>\n                <div style=\"background: #f8fafc; border-radius: 10px; padding: 20px;\">\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">üìÖ Datum:</strong> {date_formatted}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">‚è∞ Zeit:</strong> {period}. Stunde ({period_time} Uhr)\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">üë§ Sch√ºler*in:</strong> {student_name}\n                    </div>\n                </div>\n                {reason_html}\n                <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 14px 18px; border-radius: 10px; margin-top: 16px; font-size: 14px;\">\n                    üí° Du kannst deine*n Sch√ºler*in gerne regul√§r (ohne exklusive Reservierung) anmelden, falls Pl√§tze verf√ºgbar sind.\n                </div>\n                <div style=\"margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                    Bei Fragen melde dich gerne bei Mauro.<br>\n                    SportOase ‚Äì Ernst-Reuter-Schule Pattensen\n                </div>\n            </div>\n        </div>\n    </body></html>\n    \"\"\"\n\n    text = f\"\"\"\nEinzelbuchung abgelehnt ‚Äì SportOase\n\nHallo {teacher_name},\n\nLeider wurde deine exklusive Einzelbuchung von Mauro abgelehnt.\n\nDatum: {date_formatted}\nZeit: {period}. Stunde ({period_time} Uhr)\nSch√ºler*in: {student_name}\n{reason_text}\nDu kannst deine*n Sch√ºler*in gerne regul√§r (ohne exklusive Reservierung) anmelden, falls Pl√§tze verf√ºgbar sind.\n\n---\nBei Fragen melde dich gerne bei Mauro.\nSportOase ‚Äì Ernst-Reuter-Schule Pattensen\n    \"\"\"\n\n    return send_email_resend(teacher_email, subject, html, text)\n\n\ndef send_booking_removed_due_to_exclusive(teacher_email, teacher_name, booking_info, exclusive_info):\n    \"\"\"Sendet E-Mail wenn eine Buchung wegen genehmigter Exklusivbuchung entfernt wurde\"\"\"\n    from config import PERIOD_TIMES\n    \n    date_formatted = format_date_german(booking_info.get('date', 'Unbekannt'))\n    period = booking_info.get('period', '?')\n    period_time = PERIOD_TIMES.get(period, \"\")\n    students = booking_info.get('students', [])\n    offer = booking_info.get('offer_label', 'Unbekannt')\n    \n    students_html = \"\".join([\n        f'<div style=\"padding: 6px 10px; background: white; border-radius: 4px; margin: 4px 0;\">‚Ä¢ {s.get(\"name\", \"?\")} (Klasse {s.get(\"klasse\", \"?\")})</div>'\n        for s in students\n    ]) if students else '<div>Keine Sch√ºler*innen</div>'\n    \n    students_list = \", \".join([f\"{s.get('name', '?')} ({s.get('klasse', '?')})\" for s in students])\n    \n    subject = f\"‚ö†Ô∏è Buchung storniert ‚Äì SportOase\"\n    \n    html = f\"\"\"\n    <!DOCTYPE html><html><head><meta charset=\"utf-8\"></head>\n    <body style=\"margin: 0; padding: 20px; background: #f3f4f6;\">\n        <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n            <div style=\"background: linear-gradient(135deg, #E91E63 0%, #C2185B 100%); padding: 24px 30px;\">\n                <h2 style=\"color: white; margin: 0; font-size: 20px;\">‚ö†Ô∏è Buchung storniert</h2>\n            </div>\n            <div style=\"padding: 30px;\">\n                <div style=\"background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 16px 20px; border-radius: 10px; margin-bottom: 20px;\">\n                    <strong>Hallo {teacher_name},</strong>\n                    <p style=\"margin: 10px 0 0 0;\">Leider wurde deine Buchung automatisch storniert, da eine <strong>exklusive Einzelbuchung</strong> f√ºr denselben Slot von Mauro genehmigt wurde.</p>\n                </div>\n                <div style=\"background: #f8fafc; border-radius: 10px; padding: 20px;\">\n                    <h4 style=\"margin: 0 0 15px 0; color: #E91E63; font-size: 14px;\">üìã Deine stornierte Buchung:</h4>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">üìÖ Datum:</strong> {date_formatted}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">‚è∞ Zeit:</strong> {period}. Stunde ({period_time} Uhr)\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">üìö Angebot:</strong> {offer}\n                    </div>\n                    <div style=\"padding: 12px 16px; background: white; border-radius: 8px; margin: 8px 0; border-left: 4px solid #ef4444;\">\n                        <strong style=\"color: #E91E63;\">üë• Sch√ºler*innen:</strong>\n                        <div style=\"margin-top: 8px;\">{students_html}</div>\n                    </div>\n                </div>\n                <div style=\"background: #f0f9ff; border: 1px solid #bae6fd; color: #0369a1; padding: 14px 18px; border-radius: 10px; margin-top: 16px; font-size: 14px;\">\n                    üí° Bitte buche deine Sch√ºler*innen f√ºr einen anderen Slot neu ein.\n                </div>\n                <div style=\"margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 12px;\">\n                    Bei Fragen melde dich gerne bei Mauro.<br>\n                    SportOase ‚Äì Ernst-Reuter-Schule Pattensen\n                </div>\n            </div>\n        </div>\n    </body></html>\n    \"\"\"\n    \n    text = f\"\"\"\nBuchung storniert ‚Äì SportOase\n\nHallo {teacher_name},\n\nLeider wurde deine Buchung automatisch storniert, da eine exklusive Einzelbuchung f√ºr denselben Slot von Mauro genehmigt wurde.\n\nDeine stornierte Buchung:\n- Datum: {date_formatted}\n- Zeit: {period}. Stunde ({period_time} Uhr)\n- Angebot: {offer}\n- Sch√ºler*innen: {students_list}\n\nBitte buche deine Sch√ºler*innen f√ºr einen anderen Slot neu ein.\n\n---\nBei Fragen melde dich gerne bei Mauro.\nSportOase ‚Äì Ernst-Reuter-Schule Pattensen\n    \"\"\"\n    \n    return send_email_resend(teacher_email, subject, html, text)\n","path":null,"size_bytes":31089,"size_tokens":null},"static/style.css":{"content":"/* \n   SportOase Buchungssystem - Modern UI Design\n   Modernes, cleanes Design inspiriert von zeitgem√§√üen Web-Apps\n   Mit Dark Mode Unterst√ºtzung\n*/\n\n:root {\n    /* ERS Pink als Prim√§rfarbe */\n    --primary: #E91E63;\n    --primary-dark: #C2185B;\n    --primary-light: #FCE4EC;\n    --accent: #4CAF50;\n    --accent-warn: #FF9800;\n    /* Neutrale Graut√∂ne */\n    --text-primary: #212121;\n    --text-secondary: #616161;\n    --text-tertiary: #9E9E9E;\n    --bg-primary: #FFFFFF;\n    --bg-secondary: #FAFAFA;\n    --bg-tertiary: #F5F5F5;\n    --border: #E0E0E0;\n    --border-light: #EEEEEE;\n    /* Schatten */\n    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);\n    --shadow: 0 2px 4px rgba(0, 0, 0, 0.08);\n    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);\n    --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.12);\n    /* Radien */\n    --radius-sm: 4px;\n    --radius: 8px;\n    --radius-lg: 12px;\n    --radius-xl: 16px;\n    /* Spezielle Farben */\n    --login-gradient: linear-gradient(135deg, #F8BBD9 0%, #E91E63 100%);\n    --success-bg: #E8F5E9;\n    --success-text: #2E7D32;\n    --error-bg: #FFEBEE;\n    --error-text: #C62828;\n    --blocked-bg: #FFEBEE;\n    --blocked-text: #C62828;\n}\n\n/* Dark Mode - Homogenes dunkles Design */\n[data-theme=\"dark\"] {\n    /* ERS Pink bleibt Prim√§rfarbe, etwas heller f√ºr Dark Mode */\n    --primary: #F06292;\n    --primary-dark: #E91E63;\n    --primary-light: #311B28;\n    --accent: #81C784;\n    --accent-warn: #FFB74D;\n    /* Dunkle Graut√∂ne */\n    --text-primary: #FAFAFA;\n    --text-secondary: #BDBDBD;\n    --text-tertiary: #757575;\n    --bg-primary: #121212;\n    --bg-secondary: #1E1E1E;\n    --bg-tertiary: #2D2D2D;\n    --border: #424242;\n    --border-light: #333333;\n    /* Schatten */\n    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);\n    --shadow: 0 2px 4px rgba(0, 0, 0, 0.4);\n    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.5);\n    --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.6);\n    /* Spezielle Farben */\n    --login-gradient: linear-gradient(135deg, #1E1E1E 0%, #311B28 100%);\n    --success-bg: #1B3B1B;\n    --success-text: #81C784;\n    --error-bg: #3B1B1B;\n    --error-text: #EF9A9A;\n    --blocked-bg: #3B1B1B;\n    --blocked-text: #EF9A9A;\n}\n\n* {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n}\n\nbody {\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', 'Helvetica Neue', Arial, sans-serif;\n    line-height: 1.5;\n    color: var(--text-primary);\n    background: var(--bg-secondary);\n    -webkit-font-smoothing: antialiased;\n    -moz-osx-font-smoothing: grayscale;\n}\n\n.container {\n    max-width: 1400px;\n    margin: 0 auto;\n    padding: 0 2rem;\n}\n\n/* Top Navigation - Modern Minimal */\n.top-nav {\n    background: var(--bg-primary);\n    border-bottom: 1px solid var(--border);\n    padding: 0.75rem 0;\n    backdrop-filter: blur(10px);\n    position: sticky;\n    top: 0;\n    z-index: 100;\n}\n\n.top-nav nav {\n    display: flex;\n    gap: 0.5rem;\n    justify-content: flex-end;\n    align-items: center;\n}\n\n.nav-logo-link {\n    display: flex;\n    align-items: center;\n    margin-right: auto;\n    padding: 0 !important;\n}\n\n.nav-logo {\n    height: 32px;\n    width: auto;\n    transition: opacity 0.2s;\n}\n\n.nav-logo:hover {\n    opacity: 0.8;\n}\n\n.top-nav nav a {\n    color: var(--text-secondary);\n    text-decoration: none;\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    font-weight: 500;\n    font-size: 0.875rem;\n}\n\n.top-nav nav a:hover {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n}\n\n/* User Info in Navigation */\n.user-info {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.25rem 0.75rem;\n    background: var(--bg-tertiary);\n    border-radius: var(--radius);\n    margin-left: 0.5rem;\n}\n\n.user-name {\n    font-size: 0.8rem;\n    font-weight: 500;\n    color: var(--text-primary);\n    max-width: 150px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n}\n\n.user-role-badge {\n    font-size: 0.65rem;\n    font-weight: 600;\n    padding: 0.15rem 0.5rem;\n    border-radius: 9999px;\n    text-transform: uppercase;\n    letter-spacing: 0.025em;\n    white-space: nowrap;\n}\n\n.user-role-badge.admin {\n    background: var(--primary);\n    color: white;\n}\n\n.user-role-badge.teacher {\n    background: var(--accent);\n    color: white;\n}\n\n/* Exclusive Booking Styles */\n.exclusive-text {\n    font-size: 0.75rem;\n    font-weight: 600;\n    color: #9333ea;\n    background: #f3e8ff;\n    padding: 0.2rem 0.5rem;\n    border-radius: 4px;\n}\n\n.exclusive-checkbox {\n    background: #fef3c7;\n    border: 2px solid #f59e0b;\n    padding: 0.75rem;\n    border-radius: 8px;\n}\n\n.warning-text {\n    color: #92400e;\n    font-size: 0.8rem;\n    margin-top: 0.5rem;\n}\n\n.exclusive-booking-group {\n    margin-top: 1rem;\n}\n\n/* Prominente Exklusiv-Buchung Hervorhebung */\n.exclusive-highlight {\n    background: linear-gradient(135deg, #fef3c7, #fde68a);\n    border: 3px solid #f59e0b;\n    border-radius: 12px;\n    padding: 1rem;\n    margin-bottom: 1rem;\n    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);\n    animation: pulse-border 2s ease-in-out infinite;\n}\n\n.exclusive-highlight .checkbox-text strong {\n    color: #92400e;\n    font-size: 1rem;\n}\n\n.exclusive-highlight .warning-text {\n    background: rgba(255, 255, 255, 0.7);\n    padding: 0.75rem;\n    border-radius: 8px;\n    margin-top: 0.75rem;\n}\n\n@keyframes pulse-border {\n    0%, 100% {\n        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);\n    }\n    50% {\n        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.5);\n    }\n}\n\n/* Exklusiver Slot in Wochen√ºbersicht */\n.period-exclusive {\n    background: linear-gradient(135deg, #fef3c7, #fde68a) !important;\n    border: 2px solid #f59e0b !important;\n}\n\n.exclusive-header {\n    background: linear-gradient(135deg, #f59e0b, #d97706);\n    color: white;\n    padding: 0.5rem;\n    border-radius: 6px;\n    text-align: center;\n    font-weight: 600;\n    margin-bottom: 0.5rem;\n}\n\n.exclusive-star {\n    font-size: 1.1rem;\n    margin-right: 0.25rem;\n}\n\n.exclusive-info {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n    padding: 0.5rem;\n    font-size: 0.8rem;\n}\n\n.exclusive-student {\n    font-weight: 600;\n    color: #92400e;\n}\n\n.exclusive-teacher {\n    font-size: 0.75rem;\n    color: #78716c;\n}\n\n/* Pending exclusive booking indicator */\n.pending-exclusive {\n    background: #fef3c7;\n    border: 2px dashed #f59e0b;\n    padding: 0.5rem;\n    border-radius: 8px;\n    margin-top: 0.5rem;\n}\n\n.pending-exclusive-text {\n    font-size: 0.75rem;\n    color: #92400e;\n    font-weight: 500;\n}\n\n/* Pending Exclusive Hint in Slot */\n.pending-exclusive-hint {\n    background: linear-gradient(135deg, #fef3c7, #fde68a);\n    border: 1px dashed #f59e0b;\n    border-radius: 6px;\n    padding: 0.35rem 0.5rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.35rem;\n    font-size: 0.7rem;\n    color: #92400e;\n    margin-bottom: 0.4rem;\n}\n\n.pending-exclusive-hint .pending-icon {\n    font-size: 0.8rem;\n}\n\n.pending-exclusive-hint .pending-text {\n    font-weight: 600;\n    white-space: nowrap;\n}\n\n/* Pending Exclusive Admin Section */\n.pending-stat {\n    background: #fef3c7 !important;\n    border: 2px solid #f59e0b !important;\n}\n\n.pending-exclusive-section {\n    background: linear-gradient(135deg, #fef3c7, #fde68a);\n    border: 2px solid #f59e0b;\n    border-radius: 12px;\n    margin-bottom: 1.5rem;\n}\n\n.pending-exclusive-section .section-header h3 {\n    color: #92400e;\n}\n\n.pending-exclusive-list {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.pending-exclusive-card {\n    background: white;\n    border-radius: 8px;\n    padding: 1rem;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    flex-wrap: wrap;\n    gap: 1rem;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n}\n\n.pending-info {\n    flex: 1;\n    min-width: 200px;\n}\n\n.pending-date {\n    display: flex;\n    gap: 0.5rem;\n    margin-bottom: 0.5rem;\n}\n\n.date-badge, .period-badge {\n    background: var(--primary);\n    color: white;\n    padding: 0.2rem 0.5rem;\n    border-radius: 4px;\n    font-size: 0.8rem;\n}\n\n.period-badge {\n    background: var(--accent);\n}\n\n.pending-teacher {\n    margin-bottom: 0.3rem;\n}\n\n.pending-student {\n    color: #666;\n    font-size: 0.9rem;\n    margin-bottom: 0.3rem;\n}\n\n.pending-offer {\n    font-size: 0.85rem;\n    color: #888;\n}\n\n.pending-notes {\n    font-size: 0.8rem;\n    color: #666;\n    font-style: italic;\n    margin-top: 0.3rem;\n}\n\n.pending-actions {\n    display: flex;\n    gap: 0.5rem;\n}\n\n.btn-approve, .btn-reject {\n    padding: 0.5rem 1rem;\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 0.9rem;\n    font-weight: 500;\n    transition: all 0.2s;\n}\n\n.btn-approve {\n    background: #d4edda;\n    color: #155724;\n}\n\n.btn-approve:hover {\n    background: #28a745;\n    color: white;\n}\n\n.btn-reject {\n    background: #f8d7da;\n    color: #721c24;\n}\n\n.btn-reject:hover {\n    background: #dc3545;\n    color: white;\n}\n\n@media (max-width: 768px) {\n    .pending-exclusive-card {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .pending-actions {\n        justify-content: center;\n    }\n}\n\n/* User Info - Mobile */\n@media (max-width: 768px) {\n    .user-info {\n        flex-direction: column;\n        gap: 0.2rem;\n        padding: 0.3rem 0.5rem;\n    }\n    \n    .user-name {\n        font-size: 0.7rem;\n        max-width: 100px;\n    }\n    \n    .user-role-badge {\n        font-size: 0.55rem;\n        padding: 0.1rem 0.4rem;\n    }\n}\n\n/* Main Content */\nmain {\n    min-height: 85vh;\n    padding: 2rem 0;\n}\n\nh2 {\n    font-size: 1.875rem;\n    font-weight: 700;\n    margin-bottom: 0.5rem;\n    color: var(--text-primary);\n    letter-spacing: -0.025em;\n}\n\nh3 {\n    font-size: 1.25rem;\n    font-weight: 600;\n    margin: 1rem 0 0.75rem 0;\n    color: var(--text-primary);\n}\n\nh4 {\n    font-size: 1rem;\n    font-weight: 600;\n    margin: 0.75rem 0 0.5rem 0;\n    color: var(--text-primary);\n}\n\n/* Flash Messages - Modern */\n.messages {\n    margin-bottom: 1.5rem;\n}\n\n.message {\n    padding: 0.875rem 1rem;\n    margin-bottom: 0.75rem;\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    font-weight: 500;\n    border-left: 3px solid;\n    background: var(--bg-primary);\n}\n\n.message-success {\n    border-color: var(--accent);\n    color: var(--accent);\n    background: #F0FDF4;\n}\n\n.message-error {\n    border-color: #EF4444;\n    color: #DC2626;\n    background: #FEF2F2;\n}\n\n/* Login Page - Modern Centered Card */\n.login-container {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    min-height: 100vh;\n    background: var(--login-gradient);\n    padding: 1rem;\n}\n\n.login-box {\n    background: var(--bg-primary);\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    padding: 2.5rem;\n    width: 100%;\n    max-width: 420px;\n}\n\n.login-logo {\n    text-align: center;\n    margin-bottom: 2rem;\n}\n\n.login-logo img {\n    width: 200px;\n    height: 200px;\n    border-radius: 50%;\n    box-shadow: var(--shadow-md);\n}\n\n.login-box h2 {\n    text-align: center;\n    font-size: 1.5rem;\n    margin-bottom: 2rem;\n    color: var(--text-primary);\n}\n\n/* Form Inputs - Modern */\n.form-group {\n    margin-bottom: 1.25rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 500;\n    font-size: 0.875rem;\n    color: var(--text-primary);\n}\n\n.form-group input,\n.form-group select,\n.form-group textarea {\n    width: 100%;\n    padding: 0.75rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    transition: all 0.2s;\n    background: var(--bg-primary);\n    color: var(--text-primary);\n}\n\n.form-group input:focus,\n.form-group select:focus,\n.form-group textarea:focus {\n    outline: none;\n    border-color: var(--primary);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n/* Email Confirmation Checkbox */\n.email-confirmation-group {\n    background: var(--bg-tertiary);\n    padding: 1rem;\n    border-radius: var(--radius);\n    margin-top: 1.5rem;\n    border: 1px solid var(--border);\n}\n\n.checkbox-label {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    cursor: pointer;\n    font-weight: 500;\n}\n\n.checkbox-label input[type=\"checkbox\"] {\n    width: 20px;\n    height: 20px;\n    accent-color: var(--primary);\n    cursor: pointer;\n}\n\n.checkbox-text {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-size: 0.95rem;\n    color: var(--text-primary);\n}\n\n.checkbox-icon {\n    font-size: 1.1rem;\n}\n\n.hint-text {\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    margin-top: 0.5rem;\n    margin-left: 2rem;\n}\n\n/* Buttons - Modern Minimal */\n.btn, button[type=\"submit\"] {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0.625rem 1.25rem;\n    font-size: 0.875rem;\n    font-weight: 500;\n    border-radius: var(--radius);\n    border: none;\n    cursor: pointer;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    text-decoration: none;\n    gap: 0.5rem;\n}\n\n.btn-primary {\n    background: var(--primary);\n    color: white;\n}\n\n.btn-primary:hover {\n    background: var(--primary-dark);\n    transform: translateY(-1px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-secondary {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n}\n\n.btn-secondary:hover {\n    background: var(--border);\n}\n\n.btn-success {\n    background: var(--accent);\n    color: white;\n}\n\n.btn-success:hover {\n    background: var(--success-text);\n}\n\n.btn-block {\n    background: var(--error-text);\n    color: white;\n    font-size: 0.75rem;\n    padding: 0.375rem 0.75rem;\n}\n\n.btn-block:hover {\n    background: var(--blocked-text);\n}\n\n.btn-small {\n    font-size: 0.75rem;\n    padding: 0.375rem 0.75rem;\n}\n\n/* Dashboard Top Section - Unified Cards */\n.dashboard-top-section {\n    display: flex;\n    gap: 1rem;\n    margin-bottom: 1rem;\n    flex-wrap: wrap;\n}\n\n.dashboard-card {\n    background: var(--bg-primary);\n    border-radius: var(--radius-lg);\n    padding: 0.875rem 1.25rem;\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    border: 1px solid var(--border);\n    box-shadow: var(--shadow-sm);\n    transition: all 0.2s ease;\n}\n\n.dashboard-card:hover {\n    box-shadow: var(--shadow);\n    border-color: var(--primary-light);\n}\n\n.dashboard-card .card-icon {\n    font-size: 1.25rem;\n    width: 36px;\n    height: 36px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: linear-gradient(135deg, var(--primary-light) 0%, rgba(233, 30, 99, 0.15) 100%);\n    border-radius: 10px;\n}\n\n.dashboard-card .card-text {\n    font-weight: 600;\n    color: var(--text-primary);\n    font-size: 0.9375rem;\n}\n\n.dashboard-card-title {\n    flex: 1;\n    min-width: 200px;\n}\n\n.dashboard-card-title .card-text {\n    font-size: 1rem;\n    color: var(--primary);\n}\n\n.dashboard-card-date {\n    min-width: fit-content;\n}\n\n.date-form-inline {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    margin: 0;\n}\n\n.date-input-inline {\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    padding: 0.375rem 0.5rem;\n    font-size: 0.875rem;\n    background: var(--bg-secondary);\n    color: var(--text-primary);\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.date-input-inline:hover {\n    border-color: var(--primary);\n}\n\n.date-input-inline:focus {\n    outline: none;\n    border-color: var(--primary);\n    box-shadow: 0 0 0 2px var(--primary-light);\n}\n\n.calendar-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 36px;\n    height: 36px;\n    border-radius: var(--radius);\n    background: var(--primary);\n    color: white;\n    text-decoration: none;\n    font-size: 1.1rem;\n    margin-left: 0.5rem;\n    transition: all 0.2s;\n    flex-shrink: 0;\n}\n\n.calendar-btn:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n/* Hilfe-Sektion (aufklappbar) */\n.help-section {\n    background: var(--bg-primary);\n    border-radius: var(--radius-lg);\n    margin-bottom: 1.5rem;\n    box-shadow: var(--shadow);\n    border: 1px solid var(--border);\n    overflow: hidden;\n}\n\n.help-toggle {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    padding: 0.875rem 1.25rem;\n    cursor: pointer;\n    font-weight: 600;\n    color: var(--text-primary);\n    background: var(--bg-tertiary);\n    transition: background 0.2s;\n    list-style: none;\n}\n\n.help-toggle::-webkit-details-marker {\n    display: none;\n}\n\n.help-toggle:hover {\n    background: var(--bg-secondary);\n}\n\n.help-icon {\n    font-size: 1.25rem;\n    width: 36px;\n    height: 36px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: linear-gradient(135deg, var(--primary-light) 0%, rgba(233, 30, 99, 0.15) 100%);\n    border-radius: 10px;\n}\n\n.toggle-arrow {\n    margin-left: auto;\n    font-size: 0.75rem;\n    transition: transform 0.2s;\n}\n\ndetails.help-section[open] .toggle-arrow {\n    transform: rotate(180deg);\n}\n\n.help-content {\n    padding: 1.5rem;\n    border-top: 1px solid var(--border);\n}\n\n.help-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: 1.5rem;\n}\n\n.help-card {\n    background: var(--bg-secondary);\n    border-radius: var(--radius);\n    padding: 1.25rem;\n    border: 1px solid var(--border-light);\n}\n\n.help-card h4 {\n    color: var(--text-primary);\n    margin-bottom: 1rem;\n    font-size: 1rem;\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n}\n\n.help-steps {\n    padding-left: 1.25rem;\n    color: var(--text-secondary);\n    font-size: 0.875rem;\n}\n\n.help-steps li {\n    margin-bottom: 0.5rem;\n}\n\n.help-steps li strong {\n    color: var(--text-primary);\n}\n\n.feature-list {\n    list-style: none;\n    padding: 0;\n}\n\n.feature-list li {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    padding: 0.5rem 0;\n    font-size: 0.875rem;\n    color: var(--text-secondary);\n    border-bottom: 1px solid var(--border-light);\n}\n\n.feature-list li:last-child {\n    border-bottom: none;\n}\n\n.feature-icon {\n    font-size: 1rem;\n}\n\n.faq-item {\n    margin-bottom: 1rem;\n}\n\n.faq-item:last-child {\n    margin-bottom: 0;\n}\n\n.faq-item strong {\n    display: block;\n    color: var(--text-primary);\n    font-size: 0.875rem;\n    margin-bottom: 0.25rem;\n}\n\n.faq-item p {\n    color: var(--text-secondary);\n    font-size: 0.8125rem;\n    margin: 0;\n}\n\n.slot-type-info {\n    display: flex;\n    flex-direction: column;\n    gap: 0.75rem;\n}\n\n.slot-type {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    font-size: 0.8125rem;\n    color: var(--text-secondary);\n}\n\n.help-card-full {\n    grid-column: 1 / -1;\n}\n\n.help-card-exclusive {\n    background: linear-gradient(135deg, #fffbeb, #fef3c7);\n    border: 2px solid #f59e0b;\n    grid-column: 1 / -1;\n}\n\n.help-card-exclusive h4 {\n    color: #92400e;\n}\n\n.exclusive-intro {\n    color: var(--text-secondary);\n    margin-bottom: 1rem;\n    font-size: 0.9rem;\n}\n\n.exclusive-info-list {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\n    gap: 0.75rem;\n    margin-bottom: 1rem;\n}\n\n.exclusive-step {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    background: rgba(255, 255, 255, 0.7);\n    padding: 0.6rem 0.75rem;\n    border-radius: 8px;\n    font-size: 0.85rem;\n}\n\n.exclusive-step .step-icon {\n    font-size: 1rem;\n}\n\n.exclusive-note {\n    background: rgba(245, 158, 11, 0.15);\n    padding: 0.75rem;\n    border-radius: 6px;\n    font-size: 0.8rem;\n    color: #92400e;\n    margin: 0;\n}\n\n[data-theme=\"dark\"] .help-card-exclusive {\n    background: linear-gradient(135deg, #422006, #78350f);\n    border-color: #f59e0b;\n}\n\n[data-theme=\"dark\"] .help-card-exclusive h4 {\n    color: #fbbf24;\n}\n\n[data-theme=\"dark\"] .exclusive-step {\n    background: rgba(0, 0, 0, 0.3);\n    color: #fef3c7;\n}\n\n[data-theme=\"dark\"] .exclusive-note {\n    background: rgba(245, 158, 11, 0.2);\n    color: #fcd34d;\n}\n\n.offer-descriptions-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n    gap: 1rem;\n}\n\n.offer-desc {\n    background: var(--bg-primary);\n    border: 1px solid var(--border-light);\n    border-radius: var(--radius-sm);\n    padding: 0.875rem;\n}\n\n.offer-desc strong {\n    display: block;\n    color: var(--primary);\n    font-size: 0.875rem;\n    margin-bottom: 0.375rem;\n}\n\n.offer-desc p {\n    color: var(--text-secondary);\n    font-size: 0.8125rem;\n    margin: 0;\n    line-height: 1.5;\n}\n\n.thanks-content {\n    color: var(--text-secondary);\n    font-size: 0.9rem;\n    line-height: 1.7;\n}\n\n.thanks-content p {\n    margin: 0 0 1rem 0;\n}\n\n.thanks-content p:last-child {\n    margin-bottom: 0;\n    padding-top: 0.5rem;\n    border-top: 1px solid var(--border-light);\n    color: var(--primary);\n}\n\n.type-badge {\n    padding: 0.25rem 0.75rem;\n    border-radius: var(--radius-sm);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n}\n\n.type-badge.type-fest {\n    background: var(--primary-light);\n    color: var(--primary-dark);\n}\n\n.type-badge.type-frei {\n    background: var(--success-bg);\n    color: var(--success-text);\n}\n\n@media (max-width: 768px) {\n    .dashboard-top-section {\n        flex-direction: column;\n        gap: 0.75rem;\n    }\n    \n    .dashboard-card {\n        padding: 0.75rem 1rem;\n    }\n    \n    .dashboard-card-title {\n        min-width: unset;\n    }\n    \n    .dashboard-card .card-icon {\n        width: 32px;\n        height: 32px;\n        font-size: 1.1rem;\n    }\n    \n    .help-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .help-toggle {\n        padding: 0.75rem 1rem;\n    }\n    \n    .help-icon {\n        width: 32px;\n        height: 32px;\n        font-size: 1.1rem;\n    }\n    \n    .help-content {\n        padding: 1rem;\n    }\n}\n\n.dashboard-title {\n    color: var(--text-primary);\n    font-size: 1.1rem;\n    font-weight: 600;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n}\n\n.dashboard-title .title-icon {\n    font-size: 1rem;\n}\n\n.title-icon {\n    font-size: 2.5rem;\n    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));\n}\n\n/* Week Title Styling */\n.week-title {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n    flex-wrap: wrap;\n    font-size: 1.5rem;\n    font-weight: 600;\n    color: var(--text-primary);\n}\n\n.week-icon {\n    font-size: 1.75rem;\n}\n\n.week-dates {\n    font-size: 0.875rem;\n    font-weight: 500;\n    color: var(--text-secondary);\n    background: var(--primary-light);\n    padding: 0.25rem 0.75rem;\n    border-radius: var(--radius);\n    margin-left: 0.5rem;\n}\n\n/* Dashboard */\n.dashboard {\n    max-width: 100%;\n}\n\n.dashboard > h2 {\n    margin-bottom: 2rem;\n}\n\n/* Date Selector - Modern */\n.date-selector {\n    background: var(--bg-primary);\n    padding: 1rem;\n    border-radius: var(--radius-lg);\n    margin-bottom: 1.5rem;\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.date-selector form {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n}\n\n.date-selector label {\n    font-weight: 500;\n    font-size: 0.875rem;\n    color: var(--text-secondary);\n}\n\n.date-selector input {\n    padding: 0.5rem 0.75rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.875rem;\n    background: var(--bg-primary);\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.date-selector input:hover {\n    border-color: var(--primary);\n}\n\n/* Selected Date Info */\n.selected-date-info {\n    margin-bottom: 2rem;\n}\n\n.selected-date-info h3 {\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    color: white;\n    padding: 1rem 1.5rem;\n    margin: 0;\n    border-radius: var(--radius-lg);\n    text-align: center;\n    font-size: 1.125rem;\n    font-weight: 600;\n    box-shadow: var(--shadow-md);\n}\n\n/* Week Overview - Modern Card */\n.week-overview {\n    background: var(--bg-primary);\n    padding: 1.25rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    margin-bottom: 1.5rem;\n    max-width: 900px;\n    margin-left: auto;\n    margin-right: auto;\n    border: 1px solid var(--border);\n}\n\n.week-header-with-nav {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 1.5rem;\n    padding-bottom: 1rem;\n    border-bottom: 1px solid var(--border-light);\n    gap: 1rem;\n}\n\n.week-header-with-nav h3 {\n    color: var(--text-primary);\n    font-size: 1rem;\n    font-weight: 600;\n    margin: 0;\n    padding: 0;\n    border: none;\n    flex: 1;\n    text-align: center;\n}\n\n.week-nav-arrow {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 36px;\n    height: 36px;\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    border-radius: var(--radius);\n    text-decoration: none;\n    transition: all 0.2s;\n    flex-shrink: 0;\n    border: 1px solid var(--border);\n}\n\n.week-nav-arrow:hover {\n    background: var(--primary);\n    color: white;\n    border-color: var(--primary);\n}\n\n.week-nav-arrow .arrow-icon {\n    font-size: 1rem;\n}\n\n/* Week Table Wrapper - Desktop */\n.week-table-wrapper {\n    position: relative;\n}\n\n.scroll-hint {\n    display: none;\n}\n\n/* Week Table - Modern Grid */\n.week-table {\n    width: 100%;\n    border-collapse: separate;\n    border-spacing: 0;\n    margin-top: 0;\n    table-layout: fixed;\n}\n\n.week-table th,\n.week-table td {\n    padding: 0.4rem 0.2rem;\n    text-align: center;\n    vertical-align: top;\n    border: 1px solid var(--border-light);\n    width: 16%;\n    overflow: hidden;\n}\n\n.week-table th:first-child,\n.week-table td:first-child {\n    width: 8%;\n}\n\n.week-table th {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    border-bottom: 2px solid var(--border);\n}\n\n.week-table th:first-child {\n    border-top-left-radius: var(--radius);\n}\n\n.week-table th:last-child {\n    border-top-right-radius: var(--radius);\n}\n\n.week-day-header {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n    white-space: nowrap;\n    overflow: visible;\n}\n\n.day-name {\n    font-size: 0.875rem;\n    font-weight: 700;\n    letter-spacing: 0.05em;\n    white-space: nowrap;\n}\n\n.day-date {\n    font-size: 0.75rem;\n    opacity: 0.7;\n    font-weight: 500;\n    white-space: nowrap;\n}\n\n/* Heutiger Tag - dezent hervorheben */\n.week-table th.today-column {\n    background: linear-gradient(135deg, var(--primary-light) 0%, rgba(233, 30, 99, 0.15) 100%);\n    border-bottom-color: var(--primary);\n}\n\n.week-table td.today-column {\n    background: rgba(233, 30, 99, 0.04);\n    border-left: 2px solid var(--primary-light);\n    border-right: 2px solid var(--primary-light);\n}\n\n.week-table tr:last-child td.today-column {\n    border-bottom: 2px solid var(--primary-light);\n}\n\n.today-header {\n    position: relative;\n}\n\n.today-header::after {\n    content: \"Heute\";\n    position: absolute;\n    top: -2px;\n    right: -2px;\n    background: var(--primary);\n    color: white;\n    font-size: 0.55rem;\n    padding: 0.1rem 0.3rem;\n    border-radius: 3px;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.02em;\n}\n\n.week-table td {\n    font-size: 0.8125rem;\n    background: var(--bg-primary);\n    transition: all 0.2s;\n}\n\n.week-table td:hover {\n    background: var(--bg-secondary);\n}\n\n/* Period Styles */\n.period-header {\n    font-weight: 600;\n    margin-bottom: 0.4rem;\n    padding: 0.35rem 0.25rem;\n    border-radius: var(--radius-sm);\n    font-size: 0.7rem;\n    text-align: center;\n    line-height: 1.2;\n}\n\n.period-fest .period-header {\n    background: var(--primary-light);\n    color: var(--primary-dark);\n}\n\n.period-frei .period-header {\n    background: var(--success-bg);\n    color: var(--success-text);\n}\n\n.period-blocked {\n    background: #fafafa !important;\n    opacity: 1;\n}\n\n.period-blocked:hover {\n    background: #f5f5f5 !important;\n}\n\n.blocked-header {\n    background: #f8f9fa;\n    color: #666;\n    border: 1px dashed #ccc;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 0.4rem;\n    padding: 0.75rem 0.5rem;\n    border-radius: var(--radius);\n    min-height: 70px;\n    justify-content: center;\n    text-align: center;\n}\n\n.blocked-icon {\n    font-size: 1.2rem;\n    opacity: 0.7;\n}\n\n.blocked-header .slot-detail {\n    font-size: 0.75rem;\n    font-weight: 500;\n    color: #888;\n    text-transform: none;\n    letter-spacing: 0;\n    margin-top: 0;\n}\n\n.period-past {\n    opacity: 0.5;\n    background: var(--bg-secondary) !important;\n}\n\n.slot-detail {\n    font-size: 0.75rem;\n    font-weight: 500;\n    margin-top: 0.25rem;\n}\n\n/* ===== Neue Slot-Karten mit Kursfarben ===== */\n.slot-card {\n    padding: 0.4rem;\n    border-radius: var(--radius);\n    position: relative;\n    min-height: 65px;\n    display: flex;\n    flex-direction: column;\n    background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,240,240,0.9) 100%);\n    border-left: 4px solid;\n    transition: all 0.2s;\n    overflow: hidden;\n    max-width: 100%;\n    box-sizing: border-box;\n}\n\n.slot-card:hover {\n    transform: scale(1.02);\n    box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n}\n\n/* Clickable slot for desktop booking */\n@media (min-width: 768px) {\n    .clickable-slot {\n        cursor: pointer;\n    }\n    \n    .clickable-slot:hover .slot-card {\n        transform: scale(1.03);\n        box-shadow: 0 6px 16px rgba(233, 30, 99, 0.2);\n        border-color: var(--primary);\n    }\n}\n\n.slot-course-name {\n    font-weight: 700;\n    font-style: italic;\n    font-size: 0.8rem;\n    color: #2c3e50;\n    margin-bottom: 0.25rem;\n    line-height: 1.2;\n    text-transform: uppercase;\n    letter-spacing: 0.02em;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n}\n\n.slot-students-list {\n    font-size: 0.7rem;\n    color: #555;\n    margin-bottom: 0.5rem;\n    line-height: 1.4;\n}\n\n.slot-students-list .student-name {\n    display: block;\n    margin: 0.1rem 0;\n    font-size: 0.7rem;\n    color: #666;\n}\n\n.slot-students-list .student-name.blurred {\n    filter: blur(3px);\n    user-select: none;\n}\n\n.slot-footer {\n    margin-top: auto;\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    flex-wrap: wrap;\n}\n\n.course-tag {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.25rem;\n    padding: 0.25rem 0.6rem;\n    border-radius: 20px;\n    font-size: 0.65rem;\n    font-weight: 600;\n    background: rgba(0,0,0,0.08);\n    color: #333;\n    white-space: nowrap;\n}\n\n.course-tag .tag-icon {\n    font-size: 0.75rem;\n}\n\n.slot-availability {\n    font-size: 0.65rem;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.03em;\n}\n\n.slot-availability .book-link {\n    color: var(--primary);\n    text-decoration: none;\n}\n\n.slot-availability .book-link:hover {\n    text-decoration: underline;\n}\n\n.slot-availability .full-text {\n    color: var(--error);\n}\n\n.slot-availability .status-text {\n    color: var(--text-secondary);\n}\n\n/* Kursfarben - Pastellt√∂ne (weniger ges√§ttigt) */\n.course-wochenstart {\n    border-color: #f5b041;\n    background: linear-gradient(135deg, rgba(245,176,65,0.08) 0%, rgba(248,196,113,0.05) 100%);\n}\n.course-wochenstart .course-tag {\n    background: #f5b041;\n    color: #5d4e37;\n}\n\n.course-konflikt {\n    border-color: #bb8fce;\n    background: linear-gradient(135deg, rgba(187,143,206,0.08) 0%, rgba(215,189,226,0.05) 100%);\n}\n.course-konflikt .course-tag {\n    background: #bb8fce;\n    color: #4a3656;\n}\n\n.course-koordination {\n    border-color: #7fb3d5;\n    background: linear-gradient(135deg, rgba(127,179,213,0.08) 0%, rgba(174,214,241,0.05) 100%);\n}\n.course-koordination .course-tag {\n    background: #7fb3d5;\n    color: #2e4a5f;\n}\n\n.course-sozial {\n    border-color: #76d7c4;\n    background: linear-gradient(135deg, rgba(118,215,196,0.08) 0%, rgba(163,228,215,0.05) 100%);\n}\n.course-sozial .course-tag {\n    background: #76d7c4;\n    color: #1e5245;\n}\n\n.course-fitness {\n    border-color: #7dcea0;\n    background: linear-gradient(135deg, rgba(125,206,160,0.08) 0%, rgba(171,235,198,0.05) 100%);\n}\n.course-fitness .course-tag {\n    background: #7dcea0;\n    color: #1e5131;\n}\n\n.course-motorik {\n    border-color: #f0b27a;\n    background: linear-gradient(135deg, rgba(240,178,122,0.08) 0%, rgba(245,203,167,0.05) 100%);\n}\n.course-motorik .course-tag {\n    background: #f0b27a;\n    color: #5d4230;\n}\n\n.course-turnen {\n    border-color: #f1948a;\n    background: linear-gradient(135deg, rgba(241,148,138,0.08) 0%, rgba(245,183,177,0.05) 100%);\n}\n.course-turnen .course-tag {\n    background: #f1948a;\n    color: #5d2a25;\n}\n\n.course-atem {\n    border-color: #85c1e9;\n    background: linear-gradient(135deg, rgba(133,193,233,0.08) 0%, rgba(174,214,241,0.05) 100%);\n}\n.course-atem .course-tag {\n    background: #85c1e9;\n    color: #21618c;\n}\n\n.course-bodyscan {\n    border-color: #c39bd3;\n    background: linear-gradient(135deg, rgba(195,155,211,0.08) 0%, rgba(215,189,226,0.05) 100%);\n}\n.course-bodyscan .course-tag {\n    background: #c39bd3;\n    color: #4a235a;\n}\n\n.course-ruhe {\n    border-color: #73c6b6;\n    background: linear-gradient(135deg, rgba(115,198,182,0.08) 0%, rgba(163,228,215,0.05) 100%);\n}\n.course-ruhe .course-tag {\n    background: #73c6b6;\n    color: #1e5245;\n}\n\n.course-frei {\n    border-color: #aab7b8;\n    background: linear-gradient(135deg, rgba(170,183,184,0.06) 0%, rgba(191,201,202,0.04) 100%);\n}\n.course-frei .course-tag {\n    background: #aab7b8;\n    color: #424949;\n}\n\n.course-default {\n    border-color: #99a3a4;\n    background: linear-gradient(135deg, rgba(153,163,164,0.08) 0%, rgba(178,186,187,0.05) 100%);\n}\n.course-default .course-tag {\n    background: #99a3a4;\n    color: #424949;\n}\n\n/* Admin Block Button in neuen Karten */\n.slot-card .admin-block-form {\n    position: absolute;\n    top: 0.25rem;\n    right: 0.25rem;\n}\n\n.slot-card .slot-block-mini {\n    font-size: 0.7rem;\n    padding: 0.15rem 0.3rem;\n    opacity: 0.5;\n}\n\n.slot-card:hover .slot-block-mini {\n    opacity: 1;\n}\n\n/* Buchen-Button - immer sichtbar */\n.book-btn {\n    display: block;\n    width: 100%;\n    padding: 0.5rem 0.75rem;\n    margin-top: 0.5rem;\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    color: white;\n    text-align: center;\n    text-decoration: none;\n    font-weight: 600;\n    font-size: 0.75rem;\n    border-radius: var(--radius);\n    box-shadow: 0 2px 4px rgba(233, 30, 99, 0.3);\n    transition: all 0.2s;\n}\n\n.book-btn:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 4px 8px rgba(233, 30, 99, 0.4);\n    background: linear-gradient(135deg, var(--primary-dark) 0%, #ad1457 100%);\n}\n\n.book-btn:active {\n    transform: translateY(0);\n}\n\n/* Desktop: Kleinerer Button, aber sichtbar */\n@media (min-width: 769px) {\n    .book-btn {\n        padding: 0.4rem 0.5rem;\n        font-size: 0.7rem;\n    }\n    \n    /* Slot-Card Hover-Effekt f√ºr bessere Klickbarkeit */\n    .clickable-slot {\n        cursor: pointer;\n    }\n    \n    .clickable-slot:hover .slot-card {\n        transform: scale(1.02);\n        box-shadow: 0 6px 16px rgba(233, 30, 99, 0.25);\n        border-color: var(--primary);\n    }\n}\n\n/* Mobile: Gr√∂√üerer Button */\n@media (max-width: 768px) {\n    .book-btn {\n        padding: 0.6rem 0.75rem;\n        font-size: 0.85rem;\n    }\n    \n    .slot-availability .availability-text {\n        display: block;\n        color: var(--text-secondary);\n    }\n}\n\n/* Booking Info - Optimized */\n.booking-info {\n    margin-top: 0.5rem;\n    padding: 0.5rem;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    font-size: 0.6875rem;\n    text-align: left;\n}\n\n.slot-stat {\n    font-weight: 600;\n    color: var(--text-secondary);\n    margin-bottom: 0.375rem;\n    text-align: center;\n}\n\n.booking-entry {\n    margin-top: 0.375rem;\n    padding-top: 0.375rem;\n    border-top: 1px solid var(--border-light);\n}\n\n.booking-entry:first-child {\n    margin-top: 0;\n    padding-top: 0;\n    border-top: none;\n}\n\n.booking-title {\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 0.25rem;\n}\n\n.student-name {\n    font-size: 0.6875rem;\n    color: var(--text-secondary);\n    margin-left: 0.5rem;\n}\n\n/* Datenschutz: Geblurrte Sch√ºlernamen f√ºr andere Benutzer */\n.student-blurred .blurred-text {\n    filter: blur(4px);\n    user-select: none;\n    display: inline-block;\n    -webkit-filter: blur(4px);\n}\n\n.student-blurred {\n    color: var(--text-secondary);\n    opacity: 0.7;\n    font-style: italic;\n}\n\n/* Slot Actions - All Buttons Equal Size */\n.slot-actions {\n    margin-top: 0.625rem;\n    display: flex;\n    flex-direction: column;\n    gap: 0.375rem;\n}\n\n.slot-actions form {\n    margin: 0;\n}\n\n.slot-btn {\n    display: block;\n    width: 100%;\n    padding: 0.5rem 0.75rem;\n    font-size: 0.6875rem;\n    font-weight: 600;\n    text-align: center;\n    border-radius: var(--radius-sm);\n    border: none;\n    cursor: pointer;\n    transition: all 0.2s;\n    text-decoration: none;\n}\n\n.slot-btn-primary {\n    background: var(--primary);\n    color: white;\n}\n\n.slot-btn-primary:hover {\n    background: var(--primary-dark);\n}\n\n.slot-btn-success {\n    background: var(--accent);\n    color: white;\n}\n\n.slot-btn-success:hover {\n    background: var(--success-text);\n}\n\n.slot-btn-block {\n    background: var(--accent-warn);\n    color: white;\n    border: none;\n    box-shadow: var(--shadow-sm);\n    display: inline-flex;\n    align-items: center;\n    gap: 0.375rem;\n    font-weight: 500;\n}\n\n.slot-btn-block:hover {\n    filter: brightness(0.9);\n    transform: translateY(-1px);\n    box-shadow: var(--shadow-md);\n}\n\n.btn-icon {\n    font-size: 1rem;\n    display: inline-block;\n}\n\n.slot-btn-disabled {\n    background: var(--bg-tertiary);\n    color: var(--text-tertiary);\n    cursor: not-allowed;\n}\n\n/* Day Schedule - Modern Table */\n.day-schedule {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.day-schedule h3 {\n    margin-bottom: 1.25rem;\n    font-size: 1.125rem;\n}\n\n.schedule-table {\n    width: 100%;\n    border-collapse: separate;\n    border-spacing: 0;\n}\n\n.schedule-table th,\n.schedule-table td {\n    padding: 0.875rem;\n    text-align: left;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.schedule-table th {\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    font-weight: 600;\n    font-size: 0.75rem;\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n}\n\n.schedule-table tbody tr:hover {\n    background: var(--bg-secondary);\n}\n\n.schedule-table tbody tr:last-child td {\n    border-bottom: none;\n}\n\n.blocked-row {\n    background: #FEF2F2 !important;\n}\n\n.past-row {\n    opacity: 0.5;\n}\n\n.unbookable-row {\n    opacity: 0.6;\n    background: var(--bg-tertiary) !important;\n    pointer-events: none;\n}\n\n.unbookable-row td {\n    color: var(--text-tertiary);\n}\n\n.weekend-row {\n    opacity: 0.5;\n    background: #FEF3C7 !important;\n}\n\n.time-restricted-row {\n    opacity: 0.65;\n    background: #FEF3C7 !important;\n}\n\n.capacity {\n    display: inline-block;\n    padding: 0.25rem 0.625rem;\n    background: var(--bg-tertiary);\n    border-radius: var(--radius-sm);\n    font-size: 0.8125rem;\n    font-weight: 500;\n}\n\n.capacity.full {\n    background: #FEE2E2;\n    color: #991B1B;\n}\n\n.blocked-text {\n    color: #DC2626;\n    font-weight: 600;\n}\n\n.time-message {\n    color: var(--text-tertiary);\n    font-size: 0.75rem;\n    font-style: italic;\n    margin-top: 0.25rem;\n}\n\n/* Booking Form - Modern */\n.booking-form {\n    background: var(--bg-primary);\n    padding: 2rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n    max-width: 600px;\n    margin: 0 auto;\n}\n\n.booking-info-box {\n    background: var(--bg-secondary);\n    padding: 1rem;\n    border-radius: var(--radius);\n    margin-bottom: 1.5rem;\n    border-left: 3px solid var(--primary);\n}\n\n.student-list {\n    list-style: none;\n    margin-bottom: 1.5rem;\n}\n\n.student-item {\n    display: flex;\n    gap: 0.75rem;\n    margin-bottom: 0.75rem;\n}\n\n.student-item input {\n    flex: 1;\n}\n\n.btn-remove {\n    padding: 0.5rem 0.75rem;\n    background: #FEE2E2;\n    color: #DC2626;\n    border: none;\n    border-radius: var(--radius);\n    cursor: pointer;\n    font-size: 0.875rem;\n    transition: all 0.2s;\n}\n\n.btn-remove:hover {\n    background: #FEF2F2;\n}\n\n.btn-add {\n    padding: 0.5rem 1rem;\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border: 1px dashed var(--border);\n    border-radius: var(--radius);\n    cursor: pointer;\n    font-size: 0.875rem;\n    font-weight: 500;\n    transition: all 0.2s;\n}\n\n.btn-add:hover {\n    border-color: var(--primary);\n    background: var(--primary-light);\n    color: var(--primary);\n}\n\n/* Admin Panel - Modern Layout */\n.admin-panel {\n    display: grid;\n    gap: 1.5rem;\n}\n\n.admin-section {\n    background: var(--bg-primary);\n    padding: 1.5rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-sm);\n    border: 1px solid var(--border);\n}\n\n.admin-section h3 {\n    margin-bottom: 1.25rem;\n    padding-bottom: 0.75rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.user-list,\n.booking-list {\n    list-style: none;\n}\n\n.user-item,\n.booking-item {\n    padding: 0.875rem;\n    border-bottom: 1px solid var(--border-light);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.user-item:last-child,\n.booking-item:last-child {\n    border-bottom: none;\n}\n\n.user-item:hover,\n.booking-item:hover {\n    background: var(--bg-secondary);\n}\n\n.badge {\n    display: inline-block;\n    padding: 0.25rem 0.625rem;\n    border-radius: var(--radius-sm);\n    font-size: 0.75rem;\n    font-weight: 600;\n}\n\n.badge-admin {\n    background: #DBEAFE;\n    color: #1E40AF;\n}\n\n.badge-teacher {\n    background: #D1FAE5;\n    color: #065F46;\n}\n\n/* Filter Form */\n.filter-form {\n    display: flex;\n    gap: 0.75rem;\n    margin-bottom: 1.5rem;\n    align-items: flex-end;\n}\n\n/* Responsive - Mobile Optimierung */\n@media (max-width: 768px) {\n    /* Container & Spacing */\n    .container {\n        padding: 0 0.75rem;\n    }\n    \n    main {\n        padding: 1rem 0;\n    }\n    \n    /* Typography */\n    h2 {\n        font-size: 1.5rem;\n    }\n    \n    h3 {\n        font-size: 1.125rem;\n    }\n    \n    /* Login Page */\n    .login-container {\n        padding: 0.5rem;\n    }\n    \n    .login-box {\n        padding: 1.5rem 1rem;\n        max-width: 100%;\n    }\n    \n    .login-logo img {\n        width: 120px;\n        height: 120px;\n    }\n    \n    /* Navigation */\n    .top-nav {\n        padding: 0.5rem 0;\n    }\n    \n    .top-nav nav {\n        flex-wrap: wrap;\n        gap: 0.25rem;\n    }\n    \n    .top-nav nav a {\n        font-size: 0.8125rem;\n        padding: 0.4rem 0.75rem;\n    }\n    \n    /* Buttons - Gr√∂√üer f√ºr Touch */\n    .btn, button[type=\"submit\"] {\n        padding: 0.75rem 1rem;\n        font-size: 0.9375rem;\n        min-height: 44px;\n    }\n    \n    .btn-small {\n        padding: 0.5rem 0.75rem;\n        font-size: 0.8125rem;\n    }\n    \n    /* Form Inputs - Gr√∂√üer f√ºr Touch */\n    .form-group input,\n    .form-group select,\n    .form-group textarea {\n        padding: 0.875rem;\n        font-size: 1rem;\n        min-height: 44px;\n    }\n    \n    /* Date Selector */\n    .date-selector {\n        padding: 0.75rem;\n    }\n    \n    .date-selector form {\n        flex-direction: column;\n        gap: 0.5rem;\n    }\n    \n    .date-selector input {\n        width: 100%;\n    }\n    \n    /* Week Overview */\n    .week-overview {\n        padding: 0.75rem;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n        max-width: 100%;\n        margin: 0;\n    }\n    \n    .week-header-with-nav {\n        flex-wrap: nowrap;\n        gap: 0.5rem;\n        margin-bottom: 1rem;\n    }\n    \n    .week-header-with-nav h3 {\n        font-size: 0.75rem;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n    }\n    \n    .week-nav-arrow {\n        width: 32px;\n        height: 32px;\n        min-width: 32px;\n    }\n    \n    /* Week Table Wrapper - Horizontal Scroll mit 2 Tagen sichtbar */\n    .week-table-wrapper {\n        position: relative;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n        scroll-snap-type: x mandatory;\n        scrollbar-width: thin;\n    }\n    \n    .week-table {\n        table-layout: fixed;\n        font-size: 0.75rem;\n        min-width: auto;\n        width: auto;\n    }\n    \n    .week-table th,\n    .week-table td {\n        padding: 0.4rem 0.3rem;\n        font-size: 0.75rem;\n        vertical-align: top;\n        scroll-snap-align: start;\n    }\n    \n    /* Erste Spalte (Stunde) - fixiert */\n    .week-table th:first-child,\n    .week-table td:first-child {\n        width: 45px;\n        min-width: 45px;\n        position: sticky;\n        left: 0;\n        background: var(--bg-primary);\n        z-index: 10;\n        border-right: 2px solid var(--border);\n    }\n    \n    /* Jede Tag-Spalte = 2 Tage sichtbar auf Tablets */\n    .week-table th:not(:first-child),\n    .week-table td:not(:first-child) {\n        min-width: 160px;\n        width: 160px;\n        padding: 0.35rem;\n    }\n    \n    .day-name {\n        font-size: 1rem;\n        font-weight: 700;\n        white-space: nowrap;\n        overflow: visible;\n    }\n    \n    .day-date {\n        font-size: 0.8rem;\n        white-space: nowrap;\n    }\n    \n    .week-day-header {\n        overflow: visible;\n        white-space: nowrap;\n    }\n    \n    .period-header {\n        font-size: 0.65rem;\n        padding: 0.25rem;\n        margin-bottom: 0.25rem;\n        line-height: 1.1;\n    }\n    \n    .slot-card {\n        min-height: 55px;\n        padding: 0.3rem;\n    }\n    \n    .booking-info {\n        font-size: 0.65rem;\n        padding: 0.3rem;\n        margin-top: 0.3rem;\n    }\n    \n    .slot-stat {\n        font-size: 0.65rem;\n        margin-bottom: 0.2rem;\n    }\n    \n    .booking-entry {\n        margin-top: 0.2rem;\n        padding-top: 0.2rem;\n    }\n    \n    .booking-title {\n        font-size: 0.65rem;\n    }\n    \n    .student-name {\n        font-size: 0.6rem;\n    }\n    \n    .slot-actions {\n        gap: 0.2rem;\n        margin-top: 0.3rem;\n    }\n    \n    .slot-btn {\n        padding: 0.3rem 0.5rem;\n        font-size: 0.65rem;\n        min-height: 28px;\n    }\n    \n    /* Compact Slot Mobile - Gr√∂√üer und lesbarer */\n    .slot-compact {\n        gap: 0.2rem;\n        padding: 0.3rem;\n    }\n    \n    .slot-type-label {\n        font-size: 0.65rem;\n        padding: 0.15rem 0.3rem;\n    }\n    \n    .slot-capacity {\n        font-size: 0.65rem;\n        padding: 0.15rem 0.25rem;\n    }\n    \n    .slot-book-btn {\n        font-size: 0.65rem;\n        padding: 0.3rem;\n    }\n    \n    .slot-full {\n        font-size: 0.65rem;\n        padding: 0.25rem;\n    }\n    \n    .booking-offer {\n        font-size: 0.6rem;\n        padding: 0.1rem 0.2rem;\n    }\n    \n    .mini-student {\n        font-size: 0.55rem;\n        padding: 0.1rem 0.15rem;\n    }\n    \n    .slot-block-mini {\n        font-size: 0.6rem;\n        padding: 0.2rem;\n    }\n    \n    /* Scroll-Hinweise */\n    .scroll-hint {\n        display: flex;\n        position: absolute;\n        top: 50%;\n        transform: translateY(-50%);\n        background: var(--primary);\n        color: white;\n        width: 28px;\n        height: 28px;\n        border-radius: 50%;\n        align-items: center;\n        justify-content: center;\n        font-size: 0.8rem;\n        z-index: 20;\n        opacity: 0.8;\n        pointer-events: none;\n        animation: pulse 2s infinite;\n    }\n    \n    .scroll-hint-left {\n        left: 50px;\n    }\n    \n    .scroll-hint-right {\n        right: 5px;\n    }\n    \n    @keyframes pulse {\n        0%, 100% { opacity: 0.6; transform: translateY(-50%) scale(1); }\n        50% { opacity: 1; transform: translateY(-50%) scale(1.1); }\n    }\n    \n    /* Day Schedule */\n    .day-schedule {\n        padding: 1rem;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n    }\n    \n    .schedule-table {\n        min-width: 600px;\n        font-size: 0.8125rem;\n    }\n    \n    .schedule-table th,\n    .schedule-table td {\n        padding: 0.625rem 0.5rem;\n        font-size: 0.8125rem;\n    }\n    \n    /* Booking Form */\n    .booking-form {\n        padding: 1rem;\n    }\n    \n    .booking-info-box {\n        padding: 0.75rem;\n        margin-bottom: 1rem;\n    }\n    \n    .booking-info-box h3 {\n        font-size: 1rem;\n        margin-bottom: 0.75rem;\n    }\n    \n    .booking-info-box p {\n        font-size: 0.875rem;\n        margin-bottom: 0.5rem;\n    }\n    \n    .student-list {\n        margin-bottom: 1rem;\n    }\n    \n    .student-item {\n        margin-bottom: 0.75rem;\n    }\n    \n    /* Admin Panel */\n    .admin-section {\n        padding: 1rem;\n    }\n    \n    .user-item,\n    .booking-item {\n        padding: 0.75rem;\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 0.5rem;\n    }\n    \n    /* Filter Form */\n    .filter-form {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    /* Selected Date Info */\n    .selected-date-info h3 {\n        font-size: 1rem;\n        padding: 0.75rem 1rem;\n    }\n    \n    /* Credits Button - Kleiner auf Mobile */\n    .credits-button {\n        width: 44px;\n        height: 44px;\n        bottom: 15px;\n        right: 15px;\n        font-size: 1.25rem;\n    }\n    \n    .credits-content {\n        width: 95%;\n        margin: 15% auto;\n        padding: 1.5rem;\n    }\n    \n    .credits-content h3 {\n        font-size: 1.25rem;\n        margin-bottom: 1rem;\n    }\n    \n    .credits-content p {\n        font-size: 0.875rem;\n    }\n    \n    .credits-close {\n        font-size: 1.75rem;\n        right: 1rem;\n        top: 1rem;\n    }\n    \n    /* Messages */\n    .messages {\n        margin-bottom: 1rem;\n    }\n    \n    .message {\n        padding: 0.75rem;\n        font-size: 0.8125rem;\n    }\n}\n\n/* Extra Small Devices */\n@media (max-width: 480px) {\n    .container {\n        padding: 0 0.25rem;\n    }\n    \n    h2 {\n        font-size: 1.25rem;\n    }\n    \n    .login-logo img {\n        width: 100px;\n        height: 100px;\n    }\n    \n    .week-header-with-nav {\n        padding: 0 0.25rem;\n    }\n    \n    .week-header-with-nav h3 {\n        font-size: 0.7rem;\n    }\n    \n    .week-title {\n        font-size: 0.85rem;\n    }\n    \n    .week-icon {\n        font-size: 1rem;\n    }\n    \n    .week-dates {\n        font-size: 0.6rem;\n        padding: 0.15rem 0.4rem;\n        display: block;\n        margin-top: 0.25rem;\n        margin-left: 0;\n    }\n    \n    .week-nav-arrow {\n        width: 28px;\n        height: 28px;\n        min-width: 28px;\n    }\n    \n    /* Wochentabelle - 2 Tage sichtbar auf kleinen Handys */\n    .week-overview {\n        padding: 0.4rem;\n    }\n    \n    .week-table th:not(:first-child),\n    .week-table td:not(:first-child) {\n        min-width: 140px;\n        width: 140px;\n        padding: 0.25rem;\n    }\n    \n    .week-table th:first-child,\n    .week-table td:first-child {\n        width: 36px;\n        min-width: 36px;\n        font-size: 0.65rem;\n    }\n    \n    .day-name {\n        font-size: 0.75rem;\n    }\n    \n    .day-date {\n        font-size: 0.6rem;\n    }\n    \n    .slot-compact {\n        gap: 0.15rem;\n        padding: 0.25rem;\n    }\n    \n    .slot-type-label {\n        font-size: 0.55rem;\n        padding: 0.1rem 0.2rem;\n    }\n    \n    .slot-capacity {\n        font-size: 0.55rem;\n        padding: 0.1rem 0.15rem;\n    }\n    \n    .slot-book-btn {\n        font-size: 0.55rem;\n        padding: 0.25rem;\n    }\n    \n    .slot-full {\n        font-size: 0.55rem;\n        padding: 0.2rem;\n    }\n    \n    .booking-offer {\n        font-size: 0.5rem;\n        padding: 0.05rem 0.1rem;\n    }\n    \n    .mini-student {\n        display: none;\n    }\n    \n    .slot-block-mini {\n        font-size: 0.5rem;\n        padding: 0.15rem;\n    }\n    \n    .credits-button {\n        width: 40px;\n        height: 40px;\n        bottom: 10px;\n        right: 10px;\n        font-size: 1.125rem;\n    }\n}\n\n/* Credits Button */\n.credits-button {\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    width: 50px;\n    height: 50px;\n    background: var(--primary);\n    color: white;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 1.5rem;\n    font-weight: bold;\n    cursor: pointer;\n    box-shadow: var(--shadow-lg);\n    transition: all 0.3s ease;\n    z-index: 1000;\n}\n\n.credits-button:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n/* Credits Modal */\n.credits-modal {\n    display: none;\n    position: fixed;\n    z-index: 1001;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.5);\n    backdrop-filter: blur(4px);\n}\n\n.credits-content {\n    background-color: var(--bg-primary);\n    margin: 10% auto;\n    padding: 2rem;\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    width: 90%;\n    max-width: 500px;\n    position: relative;\n}\n\n.credits-content h3 {\n    margin-top: 0;\n    margin-bottom: 1.5rem;\n    color: var(--text-primary);\n    font-size: 1.5rem;\n}\n\n.credits-content p {\n    margin-bottom: 1rem;\n    color: var(--text-secondary);\n    line-height: 1.6;\n}\n\n.credits-close {\n    position: absolute;\n    right: 1.5rem;\n    top: 1.5rem;\n    color: var(--text-tertiary);\n    font-size: 2rem;\n    font-weight: bold;\n    cursor: pointer;\n    transition: color 0.2s;\n}\n\n.credits-close:hover {\n    color: var(--text-primary);\n}\n\n/* Footer */\nfooter {\n    background: var(--bg-primary);\n    border-top: 1px solid var(--border);\n    padding: 2rem 0;\n    margin-top: 4rem;\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n}\n\n/* Notification System Styles */\n.notification-container {\n    position: relative;\n    display: inline-block;\n    margin: 0 10px;\n}\n\n.notification-bell {\n    background: none;\n    border: none;\n    font-size: 1.5rem;\n    cursor: pointer;\n    position: relative;\n    padding: 5px;\n    transition: transform 0.2s ease;\n}\n\n.notification-bell:hover {\n    transform: scale(1.1);\n}\n\n.notification-badge {\n    position: absolute;\n    top: -5px;\n    right: -5px;\n    background: #EF4444;\n    color: white;\n    border-radius: 12px;\n    padding: 2px 6px;\n    font-size: 0.75rem;\n    font-weight: bold;\n    min-width: 18px;\n    text-align: center;\n    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4);\n}\n\n.notification-dropdown {\n    display: none;\n    position: absolute;\n    top: 100%;\n    right: 0;\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    box-shadow: var(--shadow-lg);\n    min-width: 350px;\n    max-width: 400px;\n    max-height: 500px;\n    overflow: hidden;\n    z-index: 1000;\n    margin-top: 10px;\n}\n\n.notification-header {\n    padding: 1rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n}\n\n.notification-header h4 {\n    margin: 0;\n    font-size: 1rem;\n    color: var(--text-primary);\n}\n\n.mark-all-read {\n    background: none;\n    border: none;\n    color: var(--primary);\n    cursor: pointer;\n    font-size: 0.875rem;\n    padding: 4px 8px;\n    border-radius: var(--radius-sm);\n    transition: background 0.2s;\n}\n\n.mark-all-read:hover {\n    background: var(--bg-secondary);\n}\n\n.notification-list {\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.notification-item {\n    padding: 1rem;\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    transition: background 0.2s;\n}\n\n.notification-item:hover {\n    background: var(--bg-secondary);\n}\n\n.notification-item.read {\n    opacity: 0.6;\n}\n\n.notification-content {\n    flex: 1;\n}\n\n.notification-message {\n    margin: 0 0 0.5rem 0;\n    color: var(--text-primary);\n    font-size: 0.875rem;\n    line-height: 1.5;\n}\n\n.notification-time {\n    color: var(--text-tertiary);\n    font-size: 0.75rem;\n}\n\n.mark-read-btn {\n    background: var(--primary);\n    color: white;\n    border: none;\n    border-radius: 50%;\n    width: 24px;\n    height: 24px;\n    cursor: pointer;\n    font-size: 0.875rem;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s;\n    margin-left: 10px;\n    flex-shrink: 0;\n}\n\n.mark-read-btn:hover {\n    background: var(--primary-dark);\n    transform: scale(1.1);\n}\n\n.no-notifications {\n    padding: 2rem;\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n}\n\n/* Kontakt-Information Box */\n.contact-info-box {\n    margin: 2rem auto;\n    max-width: 800px;\n    background: linear-gradient(135deg, var(--primary-light) 0%, #ffffff 100%);\n    border: 2px solid var(--primary);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem 2rem;\n    box-shadow: var(--shadow-md);\n}\n\n.contact-content {\n    display: flex;\n    align-items: center;\n    gap: 1.5rem;\n}\n\n.contact-logo {\n    width: 80px;\n    height: 80px;\n    object-fit: contain;\n    flex-shrink: 0;\n}\n\n.contact-text {\n    flex: 1;\n}\n\n.contact-text p {\n    margin: 0;\n    color: var(--text-primary);\n    font-size: 1rem;\n    line-height: 1.6;\n}\n\n.contact-text strong {\n    color: var(--primary);\n    font-weight: 600;\n}\n\n/* Responsive: Mobile */\n@media (max-width: 480px) {\n    .contact-info-box {\n        padding: 1rem 1.25rem;\n        margin: 1.5rem 1rem;\n    }\n    \n    .contact-content {\n        flex-direction: column;\n        text-align: center;\n        gap: 1rem;\n    }\n    \n    .contact-logo {\n        width: 60px;\n        height: 60px;\n    }\n    \n    .contact-text p {\n        font-size: 0.9rem;\n    }\n}\n\n/* IServ SSO Login Styles */\n.login-separator {\n    margin: 1.5rem 0;\n    text-align: center;\n    position: relative;\n}\n\n.login-separator::before {\n    content: '';\n    position: absolute;\n    top: 50%;\n    left: 0;\n    right: 0;\n    height: 1px;\n    background: var(--border);\n}\n\n.login-separator span {\n    background: var(--bg-primary);\n    padding: 0 1rem;\n    position: relative;\n    color: var(--text-tertiary);\n    font-size: 0.875rem;\n    font-weight: 500;\n}\n\n.btn-iserv {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n    width: 100%;\n    padding: 0.875rem 1.5rem;\n    background: var(--primary);\n    color: white;\n    text-decoration: none;\n    border-radius: var(--radius);\n    font-weight: 600;\n    font-size: 1rem;\n    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n    box-shadow: var(--shadow-sm);\n    border: none;\n    cursor: pointer;\n}\n\n.btn-iserv:hover {\n    background: var(--primary-dark);\n    box-shadow: var(--shadow-md);\n    transform: translateY(-1px);\n}\n\n.btn-iserv:active {\n    transform: translateY(0);\n    box-shadow: var(--shadow-sm);\n}\n\n.btn-iserv svg {\n    flex-shrink: 0;\n}\n\n/* ============================================\n   BULK-SPERRUNG ADMIN PAGE\n   ============================================ */\n\n.admin-page {\n    padding: 2rem 0;\n}\n\n.admin-page .admin-header {\n    text-align: center;\n    margin-bottom: 2rem;\n}\n\n.admin-page .admin-header h2 {\n    font-size: 1.75rem;\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n}\n\n.admin-page .admin-header p {\n    color: var(--text-secondary);\n    margin: 0;\n}\n\n.admin-nav {\n    display: flex;\n    gap: 1rem;\n    margin-bottom: 2rem;\n    flex-wrap: wrap;\n}\n\n.bulk-block-section {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: 2rem;\n}\n\n.bulk-block-card {\n    background: var(--bg-primary);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    box-shadow: var(--shadow);\n    border: 1px solid var(--border);\n}\n\n.bulk-block-card h3 {\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n    font-size: 1.125rem;\n}\n\n.card-description {\n    color: var(--text-secondary);\n    font-size: 0.875rem;\n    margin-bottom: 1.5rem;\n    padding-bottom: 0.75rem;\n    border-bottom: 1px solid var(--border);\n}\n\n.bulk-unblock-card {\n    border-color: var(--accent);\n}\n\n.blocked-overview {\n    grid-column: 1 / -1;\n    margin-top: 1rem;\n}\n\n.btn-full-width {\n    width: 100%;\n    margin-top: 1rem;\n}\n\n.form-row {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n    gap: 1rem;\n    margin-bottom: 1rem;\n}\n\n.periods-grid {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 0.75rem;\n    margin-top: 0.5rem;\n}\n\n/* Reason Icon Buttons f√ºr Slot-Sperrung */\n.reason-icons {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.5rem;\n    margin-top: 0.5rem;\n}\n\n.reason-icon-btn {\n    width: 44px;\n    height: 44px;\n    font-size: 1.5rem;\n    border: 2px solid var(--border);\n    border-radius: var(--radius-md);\n    background: var(--bg-secondary);\n    cursor: pointer;\n    transition: all 0.2s ease;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.reason-icon-btn:hover {\n    border-color: var(--primary);\n    background: var(--primary-light);\n    transform: scale(1.1);\n}\n\n.reason-icon-btn.active {\n    border-color: var(--primary);\n    background: var(--primary-light);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n.period-checkbox {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.5rem 0.75rem;\n    background: var(--bg-secondary);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: all 0.2s;\n    border: 1px solid var(--border-light);\n}\n\n.period-checkbox:hover {\n    background: var(--bg-tertiary);\n    border-color: var(--primary);\n}\n\n.period-checkbox input[type=\"checkbox\"] {\n    width: 16px;\n    height: 16px;\n    accent-color: var(--primary);\n}\n\n.period-checkbox span {\n    font-size: 0.875rem;\n    color: var(--text-secondary);\n}\n\n.form-hint {\n    display: block;\n    margin-top: 0.5rem;\n    color: var(--text-tertiary);\n    font-size: 0.8125rem;\n}\n\n.bulk-actions {\n    display: flex;\n    gap: 1rem;\n    margin-top: 1.5rem;\n    padding-top: 1rem;\n    border-top: 1px solid var(--border-light);\n}\n\n.bulk-actions .btn {\n    flex: 1;\n    padding: 0.75rem 1.5rem;\n    font-weight: 600;\n}\n\n.btn-danger {\n    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);\n    color: white;\n}\n\n.btn-danger:hover {\n    background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);\n}\n\n.blocked-slots-list {\n    max-height: 400px;\n    overflow-y: auto;\n}\n\n.blocked-table {\n    width: 100%;\n    border-collapse: collapse;\n    font-size: 0.875rem;\n}\n\n.blocked-table th,\n.blocked-table td {\n    padding: 0.75rem 0.5rem;\n    text-align: left;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.blocked-table th {\n    color: var(--text-tertiary);\n    font-weight: 500;\n    font-size: 0.8125rem;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n}\n\n.blocked-table td {\n    color: var(--text-secondary);\n}\n\n.btn-xs {\n    padding: 0.25rem 0.5rem;\n    font-size: 0.75rem;\n    border-radius: var(--radius-sm);\n}\n\n.no-data {\n    text-align: center;\n    color: var(--text-tertiary);\n    padding: 2rem;\n}\n\n.hint {\n    text-align: center;\n    color: var(--text-tertiary);\n    font-size: 0.8125rem;\n    margin-top: 1rem;\n}\n\n@media (max-width: 900px) {\n    .bulk-block-section {\n        grid-template-columns: 1fr;\n    }\n    \n    .form-row {\n        grid-template-columns: 1fr;\n    }\n    \n    .periods-grid {\n        grid-template-columns: repeat(2, 1fr);\n    }\n    \n    .bulk-actions {\n        flex-direction: column;\n    }\n}\n\n/* ===== Dark Mode Toggle Switch ===== */\n.theme-toggle {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    margin-left: 0.5rem;\n}\n\n.theme-switch {\n    position: relative;\n    width: 52px;\n    height: 28px;\n    background: var(--bg-tertiary);\n    border-radius: 14px;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    border: 2px solid var(--border);\n}\n\n.theme-switch:hover {\n    border-color: var(--primary);\n}\n\n.theme-switch-input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n    position: absolute;\n}\n\n.theme-switch-slider {\n    position: absolute;\n    top: 2px;\n    left: 2px;\n    width: 20px;\n    height: 20px;\n    background: var(--bg-primary);\n    border-radius: 50%;\n    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 0.75rem;\n    box-shadow: var(--shadow-sm);\n}\n\n.theme-switch-slider::before {\n    content: '‚òÄÔ∏è';\n}\n\n.theme-switch-input:checked + .theme-switch-slider {\n    transform: translateX(24px);\n    background: var(--primary);\n}\n\n.theme-switch-input:checked + .theme-switch-slider::before {\n    content: 'üåô';\n}\n\n[data-theme=\"dark\"] .theme-switch {\n    background: var(--primary-light);\n    border-color: var(--primary);\n}\n\n/* Dark Mode spezifische Anpassungen */\n[data-theme=\"dark\"] .message-success {\n    border-color: var(--accent);\n    color: var(--success-text);\n    background: var(--success-bg);\n}\n\n[data-theme=\"dark\"] .message-error {\n    border-color: #f87171;\n    color: var(--error-text);\n    background: var(--error-bg);\n}\n\n[data-theme=\"dark\"] .period-fest .period-header {\n    background: #78350f;\n    color: #fcd34d;\n}\n\n[data-theme=\"dark\"] .period-frei .period-header {\n    background: #064e3b;\n    color: #6ee7b7;\n}\n\n[data-theme=\"dark\"] .period-blocked {\n    background: var(--bg-tertiary) !important;\n}\n\n[data-theme=\"dark\"] .blocked-header {\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .blocked-icon {\n    color: var(--text-tertiary);\n}\n\n[data-theme=\"dark\"] .blocked-text {\n    color: var(--text-secondary);\n}\n\n[data-theme=\"dark\"] .type-badge.type-fest {\n    background: var(--primary-light);\n    color: var(--primary);\n}\n\n[data-theme=\"dark\"] .type-badge.type-frei {\n    background: var(--success-bg);\n    color: var(--success-text);\n}\n\n[data-theme=\"dark\"] .capacity.full {\n    background: var(--blocked-bg);\n    color: var(--blocked-text);\n}\n\n[data-theme=\"dark\"] .blocked-row {\n    background: var(--blocked-bg) !important;\n}\n\n[data-theme=\"dark\"] .btn-remove {\n    background: var(--blocked-bg);\n    color: var(--error-text);\n}\n\n[data-theme=\"dark\"] .credits-content {\n    background: var(--bg-primary);\n    color: var(--text-primary);\n}\n\n[data-theme=\"dark\"] .booking-info-box {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] input,\n[data-theme=\"dark\"] select,\n[data-theme=\"dark\"] textarea {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .btn-danger,\n[data-theme=\"dark\"] .btn-block {\n    background: #dc2626;\n}\n\n[data-theme=\"dark\"] .week-dates {\n    background: var(--primary-light);\n    color: var(--primary-dark);\n}\n\n/* Dark Mode - Weitere Komponenten */\n[data-theme=\"dark\"] .dashboard-header {\n    background: var(--bg-secondary);\n    border-left-color: var(--primary);\n}\n\n[data-theme=\"dark\"] .btn-primary {\n    background: var(--primary);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .btn-primary:hover {\n    background: var(--primary-dark);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .btn-success {\n    background: var(--accent);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .btn-success:hover {\n    background: #6ee7b7;\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .slot-btn-primary {\n    background: var(--primary);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .slot-btn-primary:hover {\n    background: var(--primary-dark);\n}\n\n[data-theme=\"dark\"] .slot-btn-success {\n    background: var(--accent);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .slot-btn-success:hover {\n    background: #6ee7b7;\n}\n\n[data-theme=\"dark\"] .week-nav-arrow {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .week-nav-arrow:hover {\n    background: var(--primary);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .admin-stats-card,\n[data-theme=\"dark\"] .admin-quick-actions,\n[data-theme=\"dark\"] .admin-section {\n    background: var(--bg-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .admin-header {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] .stat-number {\n    color: var(--primary-dark);\n}\n\n[data-theme=\"dark\"] .quick-link {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .quick-link:hover {\n    background: var(--primary);\n    color: #0f172a;\n}\n\n[data-theme=\"dark\"] .selected-date-info h3 {\n    background: linear-gradient(135deg, #1e3a5f 0%, #0c4a6e 100%);\n}\n\n[data-theme=\"dark\"] .notification-dropdown {\n    background: var(--bg-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .notification-item {\n    border-color: var(--border-light);\n}\n\n[data-theme=\"dark\"] .notification-item:hover {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] .credits-button {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .credits-modal {\n    background: rgba(0, 0, 0, 0.8);\n}\n\n[data-theme=\"dark\"] .help-toggle {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] .help-toggle:hover {\n    background: var(--bg-secondary);\n}\n\n[data-theme=\"dark\"] .help-card {\n    background: var(--bg-tertiary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .schedule-table th {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] .schedule-table tbody tr:hover {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] .week-table th {\n    background: var(--bg-tertiary);\n}\n\n[data-theme=\"dark\"] .date-selector {\n    background: var(--bg-primary);\n    border-color: var(--border);\n}\n\n[data-theme=\"dark\"] .date-selector input {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border-color: var(--border);\n}\n\n/* ===== Kompakte Slot-Darstellung ===== */\n.slot-compact {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n    padding: 0.35rem;\n    min-height: auto;\n}\n\n.slot-header-row {\n    display: flex;\n    justify-content: space-between;\n    flex-wrap: nowrap;\n    align-items: center;\n    gap: 0.25rem;\n}\n\n.slot-type-label {\n    font-size: 0.7rem;\n    font-weight: 600;\n    padding: 0.2rem 0.4rem;\n    border-radius: 4px;\n    text-transform: uppercase;\n    letter-spacing: 0;\n    white-space: nowrap;\n    overflow: visible;\n    max-width: none;\n    flex-shrink: 0;\n}\n\n.slot-type-label.type-fest {\n    background: var(--primary-light);\n    color: var(--primary-dark);\n}\n\n.slot-type-label.type-frei {\n    background: var(--success-bg);\n    color: var(--success-text);\n}\n\n.slot-capacity {\n    font-size: 0.7rem;\n    font-weight: 700;\n    color: var(--text-secondary);\n    background: var(--bg-tertiary);\n    padding: 0.15rem 0.3rem;\n    border-radius: 4px;\n    flex-shrink: 0;\n}\n\n.slot-book-btn {\n    display: block;\n    width: 100%;\n    padding: 0.35rem 0.25rem;\n    background: var(--primary);\n    color: white;\n    font-size: 0.7rem;\n    font-weight: 600;\n    text-align: center;\n    text-decoration: none;\n    border-radius: 4px;\n    transition: all 0.2s;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n.slot-book-btn:hover {\n    background: var(--primary-dark);\n    transform: translateY(-1px);\n}\n\n.slot-full {\n    display: block;\n    width: 100%;\n    padding: 0.3rem;\n    background: var(--error-bg);\n    color: var(--error-text);\n    font-size: 0.7rem;\n    font-weight: 600;\n    text-align: center;\n    border-radius: 4px;\n}\n\n.slot-bookings {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n    margin-top: 0.25rem;\n    padding-top: 0.25rem;\n    border-top: 1px solid var(--border-light);\n}\n\n.slot-booking-entry {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.125rem;\n    align-items: center;\n}\n\n.booking-offer {\n    font-size: 0.65rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    background: var(--bg-tertiary);\n    padding: 0.1rem 0.25rem;\n    border-radius: 3px;\n    margin-right: 0.15rem;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    max-width: 100%;\n}\n\n.mini-student {\n    font-size: 0.6rem;\n    padding: 0.1rem 0.2rem;\n    background: var(--bg-secondary);\n    border-radius: 3px;\n    color: var(--text-secondary);\n}\n\n.mini-student.blurred {\n    filter: blur(3px);\n}\n\n.admin-block-form {\n    margin: 0;\n}\n\n.slot-block-mini {\n    width: 100%;\n    padding: 0.25rem;\n    font-size: 0.625rem;\n    background: var(--bg-tertiary);\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    cursor: pointer;\n    transition: all 0.2s;\n}\n\n.slot-block-mini:hover {\n    background: var(--primary-light);\n    border-color: var(--primary);\n}\n\n/* ===== Modern Admin Panel ===== */\n.admin-panel-modern {\n    max-width: 1200px;\n    margin: 0 auto;\n    padding: 1rem 0;\n}\n\n.admin-header {\n    text-align: center;\n    margin-bottom: 2rem;\n}\n\n.admin-header h2 {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n    font-size: 1.75rem;\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n}\n\n.admin-icon {\n    font-size: 1.5rem;\n}\n\n.admin-subtitle {\n    color: var(--text-secondary);\n    font-size: 0.95rem;\n    margin: 0;\n}\n\n.admin-cards {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));\n    gap: 1rem;\n    margin-bottom: 2rem;\n}\n\n.admin-card {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: 1.25rem 1rem;\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    text-decoration: none;\n    transition: all 0.2s;\n    text-align: center;\n}\n\n.admin-card:hover {\n    border-color: var(--primary);\n    box-shadow: var(--shadow-md);\n    transform: translateY(-2px);\n}\n\n.admin-card .card-icon {\n    font-size: 2rem;\n    margin-bottom: 0.5rem;\n}\n\n.admin-card .card-title {\n    font-size: 0.95rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 0.25rem;\n}\n\n.admin-card .card-desc {\n    font-size: 0.75rem;\n    color: var(--text-secondary);\n}\n\n.admin-stats {\n    display: flex;\n    justify-content: center;\n    gap: 2rem;\n    margin-bottom: 2rem;\n}\n\n.stat-card {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: 1rem 2rem;\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    border-radius: var(--radius-lg);\n    color: white;\n}\n\n.stat-number {\n    font-size: 2rem;\n    font-weight: 700;\n}\n\n.stat-label {\n    font-size: 0.8rem;\n    opacity: 0.9;\n}\n\n.admin-section-modern {\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    padding: 1.5rem;\n    margin-bottom: 1.5rem;\n}\n\n.section-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 1rem;\n    padding-bottom: 0.75rem;\n    border-bottom: 1px solid var(--border-light);\n    flex-wrap: wrap;\n    gap: 0.75rem;\n}\n\n.section-header h3 {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    font-size: 1.1rem;\n    color: var(--text-primary);\n    margin: 0;\n}\n\n.section-icon {\n    font-size: 1.2rem;\n}\n\n.info-hint {\n    font-size: 0.8rem;\n    color: var(--text-tertiary);\n    font-style: italic;\n}\n\n.users-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));\n    gap: 0.75rem;\n}\n\n.user-card {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    padding: 0.75rem;\n    background: var(--bg-secondary);\n    border-radius: var(--radius);\n}\n\n.user-avatar {\n    width: 40px;\n    height: 40px;\n    border-radius: 50%;\n    background: var(--primary-light);\n    color: var(--primary-dark);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-weight: 700;\n    font-size: 1rem;\n    flex-shrink: 0;\n}\n\n.user-avatar.admin {\n    background: var(--primary);\n    color: white;\n}\n\n.user-info {\n    flex: 1;\n    min-width: 0;\n}\n\n.user-email {\n    font-size: 0.85rem;\n    color: var(--text-primary);\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n.role-badge-modern {\n    display: inline-block;\n    font-size: 0.65rem;\n    padding: 0.15rem 0.4rem;\n    border-radius: 3px;\n    font-weight: 600;\n    text-transform: uppercase;\n}\n\n.role-badge-modern.admin {\n    background: var(--primary);\n    color: white;\n}\n\n.role-badge-modern.teacher {\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n}\n\n.filter-inline {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n}\n\n.filter-inline form {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n}\n\n.filter-inline input[type=\"date\"] {\n    padding: 0.4rem 0.6rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 0.85rem;\n}\n\n.btn-filter {\n    padding: 0.4rem 0.75rem;\n    background: var(--primary);\n    color: white;\n    border: none;\n    border-radius: var(--radius);\n    font-size: 0.8rem;\n    cursor: pointer;\n}\n\n.btn-filter-reset {\n    width: 28px;\n    height: 28px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: var(--bg-tertiary);\n    color: var(--text-secondary);\n    border-radius: var(--radius);\n    text-decoration: none;\n    font-size: 0.9rem;\n}\n\n.bookings-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));\n    gap: 1rem;\n}\n\n.booking-admin-card {\n    background: var(--bg-secondary);\n    border: 1px solid var(--border-light);\n    border-radius: var(--radius-lg);\n    overflow: hidden;\n}\n\n.booking-admin-header {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    padding: 0.75rem 1rem;\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    color: white;\n}\n\n.booking-date-badge {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    background: rgba(255, 255, 255, 0.2);\n    padding: 0.4rem 0.6rem;\n    border-radius: var(--radius);\n    min-width: 45px;\n}\n\n.date-day {\n    font-size: 1.25rem;\n    font-weight: 700;\n    line-height: 1;\n}\n\n.date-month {\n    font-size: 0.7rem;\n    opacity: 0.9;\n}\n\n.booking-time {\n    flex: 1;\n}\n\n.period-num {\n    display: block;\n    font-weight: 600;\n    font-size: 0.95rem;\n}\n\n.offer-name {\n    font-size: 0.8rem;\n    opacity: 0.9;\n}\n\n.booking-admin-body {\n    padding: 1rem;\n}\n\n.teacher-info {\n    margin-bottom: 0.75rem;\n}\n\n.teacher-info strong {\n    font-size: 0.95rem;\n    color: var(--text-primary);\n}\n\n.teacher-class {\n    display: block;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n}\n\n.students-info {\n    background: var(--bg-primary);\n    padding: 0.75rem;\n    border-radius: var(--radius);\n}\n\n.students-count {\n    display: block;\n    font-size: 0.8rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    margin-bottom: 0.4rem;\n}\n\n.students-mini-list {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n}\n\n.students-mini-list li {\n    padding: 0.15rem 0;\n}\n\n.booking-notes {\n    margin-top: 0.75rem;\n    padding: 0.75rem;\n    background: #FFF3E0;\n    border-radius: var(--radius);\n    border-left: 3px solid #FF9800;\n    display: flex;\n    align-items: flex-start;\n    gap: 0.5rem;\n}\n\n.notes-icon {\n    font-size: 0.9rem;\n    flex-shrink: 0;\n}\n\n.notes-text {\n    font-size: 0.8rem;\n    color: #795548;\n    line-height: 1.4;\n}\n\n[data-theme=\"dark\"] .booking-notes {\n    background: #3E2723;\n    border-left-color: #FFB74D;\n}\n\n[data-theme=\"dark\"] .notes-text {\n    color: #FFCC80;\n}\n\n.booking-admin-actions {\n    display: flex;\n    gap: 0.5rem;\n    padding: 0.75rem 1rem;\n    background: var(--bg-tertiary);\n    border-top: 1px solid var(--border-light);\n}\n\n.btn-action {\n    flex: 1;\n    padding: 0.5rem;\n    border: none;\n    border-radius: var(--radius);\n    font-size: 0.8rem;\n    font-weight: 500;\n    cursor: pointer;\n    text-align: center;\n    text-decoration: none;\n    transition: all 0.2s;\n}\n\n.btn-action.edit {\n    background: var(--primary);\n    color: white;\n}\n\n.btn-action.edit:hover {\n    background: var(--primary-dark);\n}\n\n.btn-action.delete {\n    background: var(--error);\n    color: white;\n}\n\n.btn-action.delete:hover {\n    background: #c0392b;\n}\n\n.no-bookings-admin {\n    text-align: center;\n    padding: 2rem;\n    color: var(--text-secondary);\n}\n\n.no-bookings-admin .no-icon {\n    font-size: 3rem;\n    display: block;\n    margin-bottom: 0.5rem;\n}\n\n@media (max-width: 768px) {\n    .admin-cards {\n        grid-template-columns: repeat(2, 1fr);\n    }\n    \n    .admin-stats {\n        gap: 1rem;\n    }\n    \n    .stat-card {\n        padding: 0.75rem 1.25rem;\n    }\n    \n    .stat-number {\n        font-size: 1.5rem;\n    }\n    \n    .section-header {\n        flex-direction: column;\n        align-items: flex-start;\n    }\n    \n    .users-grid {\n        grid-template-columns: 1fr;\n    }\n    \n    .bookings-grid {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* ===== Meine Buchungen Seite ===== */\n.my-bookings-page {\n    max-width: 900px;\n    margin: 0 auto;\n    padding: 1rem 0;\n}\n\n.my-bookings-page .page-header {\n    margin-bottom: 2rem;\n    text-align: center;\n}\n\n.my-bookings-page .page-header h2 {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.75rem;\n    font-size: 1.75rem;\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n}\n\n.my-bookings-page .page-icon {\n    font-size: 1.5rem;\n}\n\n.my-bookings-page .subtitle {\n    color: var(--text-secondary);\n    font-size: 0.95rem;\n    margin: 0;\n}\n\n.bookings-list {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n}\n\n.booking-card {\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n    overflow: hidden;\n    box-shadow: var(--shadow-sm);\n    transition: all 0.2s;\n}\n\n.booking-card:hover {\n    box-shadow: var(--shadow-md);\n    border-color: var(--primary-light);\n}\n\n.booking-card.booking-past {\n    opacity: 0.7;\n    background: var(--bg-tertiary);\n}\n\n.booking-card.booking-locked .booking-actions {\n    background: var(--bg-tertiary);\n}\n\n.booking-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 1rem 1.25rem;\n    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);\n    color: white;\n}\n\n.booking-date-info {\n    display: flex;\n    flex-direction: column;\n}\n\n.booking-weekday {\n    font-size: 1.125rem;\n    font-weight: 600;\n}\n\n.booking-date {\n    font-size: 0.9rem;\n    opacity: 0.9;\n}\n\n.booking-period {\n    text-align: right;\n}\n\n.period-badge {\n    display: inline-block;\n    background: rgba(255, 255, 255, 0.2);\n    padding: 0.25rem 0.75rem;\n    border-radius: var(--radius);\n    font-weight: 600;\n    font-size: 0.95rem;\n}\n\n.period-time {\n    display: block;\n    font-size: 0.8rem;\n    opacity: 0.9;\n    margin-top: 0.25rem;\n}\n\n.booking-body {\n    padding: 1.25rem;\n}\n\n.booking-body .booking-offer {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    margin-bottom: 1rem;\n    flex-wrap: wrap;\n}\n\n.booking-body .offer-label {\n    font-size: 1.1rem;\n    font-weight: 600;\n    color: var(--text-primary);\n    background: none;\n    padding: 0;\n}\n\n.offer-type-badge {\n    font-size: 0.75rem;\n    padding: 0.2rem 0.6rem;\n    border-radius: var(--radius);\n    font-weight: 500;\n}\n\n.offer-type-badge.type-fest {\n    background: var(--primary-light);\n    color: var(--primary-dark);\n}\n\n.offer-type-badge.type-frei {\n    background: var(--success-bg);\n    color: var(--success-text);\n}\n\n.booking-teacher-info {\n    margin-bottom: 0.75rem;\n    padding: 0.5rem 0.75rem;\n    background: var(--bg-tertiary);\n    border-radius: var(--radius);\n}\n\n.teacher-label {\n    font-size: 0.85rem;\n    color: var(--text-secondary);\n    margin-right: 0.5rem;\n}\n\n.teacher-name {\n    font-weight: 500;\n    color: var(--text-primary);\n}\n\n.booking-students {\n    margin-bottom: 0.75rem;\n}\n\n.students-label {\n    display: block;\n    font-size: 0.85rem;\n    color: var(--text-secondary);\n    margin-bottom: 0.5rem;\n}\n\n.students-list {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.5rem;\n}\n\n.students-list li {\n    background: var(--bg-tertiary);\n    padding: 0.35rem 0.75rem;\n    border-radius: var(--radius);\n    font-size: 0.9rem;\n    color: var(--text-primary);\n}\n\n.booking-meta {\n    margin-top: 0.75rem;\n    padding-top: 0.75rem;\n    border-top: 1px solid var(--border-light);\n}\n\n.created-at {\n    font-size: 0.8rem;\n    color: var(--text-tertiary);\n}\n\n.booking-actions {\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    padding: 1rem 1.25rem;\n    background: var(--bg-secondary);\n    border-top: 1px solid var(--border-light);\n    flex-wrap: wrap;\n}\n\n.booking-actions .btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 0.4rem;\n    padding: 0.5rem 1rem;\n    border-radius: var(--radius);\n    font-size: 0.9rem;\n    font-weight: 500;\n    cursor: pointer;\n    transition: all 0.2s;\n    border: none;\n    text-decoration: none;\n}\n\n.booking-actions .btn-edit {\n    background: var(--primary);\n    color: white;\n}\n\n.booking-actions .btn-edit:hover {\n    background: var(--primary-dark);\n}\n\n.booking-actions .btn-delete {\n    background: var(--error);\n    color: white;\n}\n\n.booking-actions .btn-delete:hover {\n    background: #c0392b;\n}\n\n.booking-actions .btn-icon {\n    font-size: 1rem;\n}\n\n.locked-info {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    color: var(--text-tertiary);\n    font-size: 0.9rem;\n}\n\n.lock-icon {\n    font-size: 1rem;\n}\n\n.no-bookings {\n    text-align: center;\n    padding: 3rem 1.5rem;\n    background: var(--bg-primary);\n    border: 1px solid var(--border);\n    border-radius: var(--radius-lg);\n}\n\n.no-bookings-icon {\n    font-size: 4rem;\n    margin-bottom: 1rem;\n}\n\n.no-bookings h3 {\n    color: var(--text-primary);\n    margin-bottom: 0.5rem;\n}\n\n.no-bookings p {\n    color: var(--text-secondary);\n    margin-bottom: 1.5rem;\n}\n\n/* Edit My Booking Page */\n.my-booking-edit .booking-info-summary {\n    background: var(--bg-tertiary);\n    padding: 1rem 1.25rem;\n    border-radius: var(--radius-lg);\n    margin-bottom: 1.5rem;\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: 0.75rem;\n}\n\n.my-booking-edit .info-item {\n    display: flex;\n    flex-direction: column;\n    gap: 0.25rem;\n}\n\n.my-booking-edit .info-label {\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    font-weight: 500;\n}\n\n.my-booking-edit .info-value {\n    font-size: 1rem;\n    color: var(--text-primary);\n    font-weight: 600;\n}\n\n.my-booking-edit .form-hint {\n    font-size: 0.8rem;\n    color: var(--text-secondary);\n    margin-top: 0.25rem;\n}\n\n/* Mobile Responsive f√ºr Meine Buchungen */\n@media (max-width: 768px) {\n    .my-bookings-page .page-header h2 {\n        font-size: 1.35rem;\n    }\n    \n    .booking-header {\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 0.75rem;\n    }\n    \n    .booking-period {\n        text-align: left;\n    }\n    \n    .booking-actions {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .booking-actions .btn {\n        justify-content: center;\n        width: 100%;\n    }\n    \n    .locked-info {\n        justify-content: center;\n    }\n    \n    .my-booking-edit .booking-info-summary {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* ===== Modal f√ºr Slot-Sperrung ===== */\n.modal-overlay {\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.6);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 1000;\n    padding: 1rem;\n    backdrop-filter: blur(4px);\n}\n\n.modal-content {\n    background: var(--bg-primary);\n    border-radius: var(--radius-xl);\n    box-shadow: var(--shadow-lg);\n    width: 100%;\n    max-width: 450px;\n    max-height: 90vh;\n    overflow-y: auto;\n    animation: modalSlideIn 0.2s ease-out;\n}\n\n@keyframes modalSlideIn {\n    from {\n        opacity: 0;\n        transform: translateY(-20px) scale(0.95);\n    }\n    to {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n    }\n}\n\n.modal-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 1.25rem 1.5rem;\n    border-bottom: 1px solid var(--border-light);\n}\n\n.modal-header h3 {\n    margin: 0;\n    font-size: 1.25rem;\n    color: var(--text-primary);\n}\n\n.modal-close {\n    background: none;\n    border: none;\n    font-size: 1.75rem;\n    color: var(--text-tertiary);\n    cursor: pointer;\n    padding: 0;\n    line-height: 1;\n    transition: color 0.2s;\n}\n\n.modal-close:hover {\n    color: var(--text-primary);\n}\n\n.modal-body {\n    padding: 1.5rem;\n}\n\n.modal-slot-info {\n    background: var(--bg-secondary);\n    padding: 0.75rem 1rem;\n    border-radius: var(--radius);\n    font-weight: 600;\n    color: var(--primary);\n    margin-bottom: 1.25rem;\n    text-align: center;\n}\n\n.modal-body .form-group {\n    margin-bottom: 1.25rem;\n}\n\n.modal-body label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 600;\n    color: var(--text-primary);\n}\n\n.modal-body .form-control {\n    width: 100%;\n    padding: 0.75rem 1rem;\n    border: 1px solid var(--border);\n    border-radius: var(--radius);\n    font-size: 1rem;\n    background: var(--bg-primary);\n    color: var(--text-primary);\n    transition: border-color 0.2s, box-shadow 0.2s;\n}\n\n.modal-body .form-control:focus {\n    outline: none;\n    border-color: var(--primary);\n    box-shadow: 0 0 0 3px var(--primary-light);\n}\n\n/* Icon Picker */\n.icon-picker {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 0.75rem;\n}\n\n.icon-option {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: 0.75rem;\n    border: 2px solid var(--border);\n    border-radius: var(--radius);\n    cursor: pointer;\n    transition: all 0.2s;\n    background: var(--bg-primary);\n}\n\n.icon-option:hover {\n    border-color: var(--primary);\n    background: var(--primary-light);\n}\n\n.icon-option input[type=\"radio\"] {\n    display: none;\n}\n\n.icon-option input[type=\"radio\"]:checked + .icon-display {\n    transform: scale(1.2);\n}\n\n.icon-option:has(input:checked) {\n    border-color: var(--primary);\n    background: var(--primary-light);\n    box-shadow: 0 0 0 2px var(--primary-light);\n}\n\n.icon-display {\n    font-size: 1.75rem;\n    margin-bottom: 0.25rem;\n    transition: transform 0.2s;\n}\n\n.icon-label {\n    font-size: 0.75rem;\n    color: var(--text-secondary);\n    font-weight: 500;\n}\n\n.modal-footer {\n    display: flex;\n    justify-content: flex-end;\n    gap: 0.75rem;\n    padding: 1rem 1.5rem;\n    border-top: 1px solid var(--border-light);\n    background: var(--bg-secondary);\n    border-radius: 0 0 var(--radius-xl) var(--radius-xl);\n}\n\n.modal-footer .btn {\n    padding: 0.625rem 1.25rem;\n    font-weight: 600;\n}\n\n.modal-footer .btn-secondary {\n    background: var(--bg-tertiary);\n    color: var(--text-primary);\n    border: 1px solid var(--border);\n}\n\n.modal-footer .btn-secondary:hover {\n    background: var(--border-light);\n}\n\n.modal-footer .btn-danger {\n    background: var(--error-text);\n    color: white;\n    border: none;\n}\n\n.modal-footer .btn-danger:hover {\n    background: #B71C1C;\n}\n\n/* Mobile Modal */\n@media (max-width: 480px) {\n    .modal-content {\n        max-height: 85vh;\n    }\n    \n    .icon-picker {\n        grid-template-columns: repeat(2, 1fr);\n    }\n    \n    .modal-footer {\n        flex-direction: column;\n    }\n    \n    .modal-footer .btn {\n        width: 100%;\n        justify-content: center;\n    }\n}\n","path":null,"size_bytes":91129,"size_tokens":null},"replit.md":{"content":"# SportOase Buchungssystem\n\n## Overview\n\nSportOase Buchungssystem is a web-based booking management system for the school sports facility (SportOase) at KGS Pattensen (Ernst-Reuter-Schule). Teachers can book time slots for 1-5 students, view a color-coded weekly schedule, and manage their own bookings. Administrators have full control over all bookings, slot blocking, and user management. Authentication is handled via IServ SSO (OAuth2/OpenID Connect).\n\n## User Preferences\n\n- Communication style: Simple, everyday language (German)\n- Design: Pink/Magenta color scheme (#E91E63) matching ERS school branding\n- Mobile-first: 1-day scrollable view on mobile, 5-day view on desktop\n\n## System Architecture\n\n### Frontend\n\n- **Templates**: Jinja2 (Flask) with base template for consistent layout\n- **Design**: Modern card-based UI with color-coded course slots\n- **Responsive**: Mobile-optimized with 1-day horizontal scroll view\n- **Key Pages**: Login, Dashboard (weekly overview), Booking form, Meine Buchungen, Admin panel\n\n### Backend\n\n- **Framework**: Flask (Python 3.11)\n- **Authentication**: IServ SSO (OAuth2/OpenID Connect via Authlib)\n- **Authorization**: Role-based (`@login_required`, `@admin_required`)\n- **Timezone**: Europe/Berlin (pytz)\n\n### File Structure\n\n```\n‚îú‚îÄ‚îÄ app.py              # Main application routes\n‚îú‚îÄ‚îÄ config.py           # Schedule, SMTP, settings\n‚îú‚îÄ‚îÄ models.py           # Database models (SQLAlchemy)\n‚îú‚îÄ‚îÄ database.py         # Database instance\n‚îú‚îÄ‚îÄ db_setup.py         # Database initialization\n‚îú‚îÄ‚îÄ oauth_config.py     # IServ OAuth configuration\n‚îú‚îÄ‚îÄ email_service.py    # SMTP email notifications\n‚îú‚îÄ‚îÄ templates/          # Jinja2 HTML templates\n‚îú‚îÄ‚îÄ static/             # CSS, logos\n‚îú‚îÄ‚îÄ render.yaml         # Render deployment config\n‚îî‚îÄ‚îÄ requirements.txt    # Python dependencies\n```\n\n### Data Storage\n\n- **Database**: PostgreSQL (Neon-backed via Replit, Render in production)\n- **ORM**: Flask-SQLAlchemy 3.1.1\n- **Tables**: users, bookings, slot_names, blocked_slots, notifications\n\n### Authentication & Authorization\n\n**IServ SSO**: OAuth2/OpenID Connect integration (Scope: `openid profile email roles`)\n\n**Admin-Zugang**:\n- E-Mail: `morelli.maurizio@kgs-pattensen.de` (immer Admin)\n\n**Lehrer-Zugang** (basierend auf IServ-ROLLEN):\n- Schulleitung\n- Lehrer / Lehrerin\n- Sozialp√§dagogen / Sozialp√§dagogin\n- P√§dagogische Mitarbeiter\n- Mitarbeiter / Mitarbeiterin\n\n**Kein Zugang**:\n- Sch√ºler (automatisch blockiert)\n- Alle anderen Rollen\n\n**App-Rechte**:\n- **Teachers**: Create bookings, edit/delete own bookings (up to 1 hour before)\n- **Admins**: Full access, no time restrictions\n\n### Key Features\n\n- **Color-coded Slots**: Each course type has unique color and icon tag\n- **Today Highlighting**: Current day visually distinguished in week view\n- **Meine Buchungen**: Teachers view/edit/delete their own bookings\n- **Slot Blocking**: Admins can bulk-block slots for holidays\n- **CSRF Protection**: All POST requests protected\n- **E-Mail Notifications**: SMTP-based booking confirmations\n\n### Course Colors & Tags\n\n| Course | Color | Tag |\n|--------|-------|-----|\n| Wochenstart-Aktivierung | Orange | ‚òÄÔ∏è Energie |\n| Konflikt-Reset | Violet | üõ°Ô∏è Reset |\n| Koordinationszirkel | Blue | üéØ Fokus |\n| Sozialtraining | Teal | üë• Team |\n| Mini-Fitness | Green | ‚ö° Power |\n| Motorik-Parcours | Orange | üèÉ Bewegung |\n| Turnen + Balance | Pink | ü§∏ Balance |\n| Atem & Reflexion | Cyan | üå¨Ô∏è Atem |\n| Bodyscan Light | Purple | üßò Scan |\n| Ruhezone | Mint | üçÉ Ruhe |\n| Freie Wahl | Gray | ‚≠ê Flexibel |\n\n## Environment Variables\n\n| Variable | Description | Location |\n|----------|-------------|----------|\n| `DATABASE_URL` | PostgreSQL connection string | Render |\n| `SESSION_SECRET` | Flask session secret (required) | Replit + Render |\n| `ISERV_CLIENT_ID` | OAuth Client ID from IServ | Replit + Render |\n| `ISERV_CLIENT_SECRET` | OAuth Client Secret from IServ | Replit + Render |\n| `ISERV_DOMAIN` | `kgs-pattensen.de` | Replit + Render |\n\n## E-Mail Service\n\nE-Mails werden √ºber **Resend** versendet.\n\n**In Replit:** Automatisch √ºber Replit Connector\n\n**In Render:** Environment Variables setzen:\n- `RESEND_API_KEY` - Resend API-Key (von resend.com)\n\nAbsender: `SportOase <onboarding@resend.dev>` (Resend Test-Adresse, keine Domain-Verifizierung n√∂tig)\n\n## Deployment\n\nProduction deployment on Render.com:\n- Build: `pip install -r requirements.txt`\n- Start: `gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 120 main:app`\n- Database: PostgreSQL (internal)\n\n## Support\n\n- **E-Mail**: morelli.maurizio@kgs-pattensen.de\n- **Telefon**: 0151 40349764\n","path":null,"size_bytes":4678,"size_tokens":null},"db_setup.py":{"content":"# Skript zur Initialisierung der PostgreSQL-Datenbank\n# Dieses Skript erstellt die Datenbank und legt einen Admin-Benutzer an\n\nimport os\nfrom app import app\nfrom models import create_user, get_user_by_username\nfrom database import db\n\ndef setup_database():\n    \"\"\"Initialisiert die Datenbank und erstellt einen Standard-Admin-Account\"\"\"\n    with app.app_context():\n        print(\"Erstelle Datenbank-Tabellen...\")\n        db.create_all()\n        print(\"Datenbank-Tabellen erfolgreich erstellt!\")\n        \n        # Pr√ºfe, ob bereits ein Admin existiert\n        admin = get_user_by_username('sportoase')\n        if not admin:\n            # Erstelle Standard-Admin mit korrekter E-Mail\n            admin_id = create_user('sportoase', 'mauro123', 'admin', 'sportoase.kg@gmail.com')\n            if admin_id:\n                print(f\"\\nAdmin-Account erstellt:\")\n                print(f\"  Benutzername: sportoase\")\n                print(f\"  Passwort: mauro123\")\n                print(f\"  E-Mail: sportoase.kg@gmail.com\")\n            else:\n                print(\"\\nFehler: Admin-Account konnte nicht erstellt werden.\")\n        else:\n            print(\"\\nAdmin-Account existiert bereits.\")\n        \n        print(\"\\nDatenbank-Setup abgeschlossen!\")\n        print(\"Sie k√∂nnen sich jetzt mit den Admin-Zugangsdaten anmelden.\")\n\nif __name__ == '__main__':\n    setup_database()\n","path":null,"size_bytes":1366,"size_tokens":null},"config.py":{"content":"import os\nfrom dotenv import load_dotenv\n\n# .env Datei laden\nload_dotenv()\n\n# =====================================================================\n#  Stundenzeiten\n# =====================================================================\n\nPERIOD_TIMES = {\n    1: {\n        \"start\": \"07:50\",\n        \"end\": \"08:35\"\n    },\n    2: {\n        \"start\": \"08:35\",\n        \"end\": \"09:20\"\n    },\n    3: {\n        \"start\": \"09:40\",\n        \"end\": \"10:25\"\n    },\n    4: {\n        \"start\": \"10:25\",\n        \"end\": \"11:20\"\n    },\n    5: {\n        \"start\": \"11:40\",\n        \"end\": \"12:25\"\n    },\n    6: {\n        \"start\": \"12:25\",\n        \"end\": \"13:10\"\n    },\n}\n\n# =====================================================================\n#  Feste Angebote\n# =====================================================================\n\nFIXED_OFFERS = {\n    \"Mon\": {\n        1: \"Wochenstart-Aktivierung\",\n        3: \"Konflikt-Reset & Deeskalation\",\n        5: \"Koordinationszirkel\"\n    },\n    \"Tue\": {},\n    \"Wed\": {\n        1: \"Sozialtraining / Gruppenreset\",\n        3: \"Aktivierung Mini-Fitness\",\n        5: \"Motorik-Parcours\"\n    },\n    \"Thu\": {\n        2: \"Konflikt-Reset\",\n        5: \"Turnen + Balance\"\n    },\n    \"Fri\": {\n        2: \"Atem & Reflexion\",\n        4: \"Bodyscan Light\",\n        5: \"Ruhezone / Entspannung\"\n    },\n}\n\n# =====================================================================\n#  Module\n# =====================================================================\n\nFREE_MODULES = [\n    \"Aktivierung\",\n    \"Regulation / Entspannung\",\n    \"Konflikt-Reset\",\n    \"Egal / flexibel\",\n]\n\n# =====================================================================\n#  Klassen\n# =====================================================================\n\nSCHOOL_CLASSES = [\n    \"5a\",\n    \"5b\",\n    \"5c\",\n    \"5d\",\n    \"5e\",\n    \"5f\",\n    \"6a (KES)\",\n    \"6b (KES)\",\n    \"6c (KES)\",\n    \"6d (KES)\",\n    \"6e (KES)\",\n    \"6f (KES)\",\n    \"7a (KES)\",\n    \"7b (KES)\",\n    \"7c (KES)\",\n    \"7d (KES)\",\n    \"7e (KES)\",\n    \"7f (KES)\",\n    \"G8G1\",\n    \"G8G2\",\n    \"G8G3\",\n    \"H8H\",\n    \"R8R1\",\n    \"R8R2\",\n    \"G9G1\",\n    \"G9G2\",\n    \"G9G3\",\n    \"H9H\",\n    \"R9R1\",\n    \"R9R2\",\n    \"R9R3\",\n    \"G10G1\",\n    \"G10G2\",\n    \"G10G3\",\n    \"H10H\",\n    \"R10R1\",\n    \"R10R2\",\n    \"G11a\",\n    \"G11b\",\n    \"G11c\",\n    \"G12Q1\",\n    \"G13Q2\",\n]\n\n# =====================================================================\n#  Regeln\n# =====================================================================\n\nMAX_STUDENTS_PER_PERIOD = 5\nBOOKING_ADVANCE_MINUTES = 60\n\n# =====================================================================\n#  SMTP (IServ) ‚Äî Port 587 + STARTTLS (empfohlen)\n# =====================================================================\n\n# !!! F√ºr dich relevant !!!\n# Dein SMTP-Server lautet: kgs-pattensen.de\n\nSMTP_HOST = os.getenv(\"SMTP_HOST\", \"kgs-pattensen.de\")\nSMTP_PORT = int(os.getenv(\"SMTP_PORT\", 587))  # STARTTLS\nSMTP_USER = os.getenv(\"SMTP_USER\", \"\")  # vollst√§ndige IServ-Adresse\nSMTP_PASS = os.getenv(\"SMTP_PASS\", \"\")  # IServ-Login\nSMTP_FROM = os.getenv(\"SMTP_FROM\", SMTP_USER)\nADMIN_EMAIL = os.getenv(\"ADMIN_EMAIL\", SMTP_USER)\n\n# =====================================================================\n#  Flask-Key / DB\n# =====================================================================\n\nSECRET_KEY = os.getenv(\"SESSION_SECRET\", \"dev-secret-key-change-in-production\")\nDATABASE_URL = os.getenv(\"DATABASE_URL\", \"postgresql://localhost/sportoase\")\n","path":null,"size_bytes":3440,"size_tokens":null},"main.py":{"content":"from app import app\n","path":null,"size_bytes":20,"size_tokens":null},"database.py":{"content":"from flask_sqlalchemy import SQLAlchemy\nfrom sqlalchemy.orm import DeclarativeBase\n\nclass Base(DeclarativeBase):\n    pass\n\ndb = SQLAlchemy(model_class=Base)\n","path":null,"size_bytes":157,"size_tokens":null},"DEPLOYMENT.md":{"content":"# Deployment Guide f√ºr Render\n\nDiese Anleitung beschreibt, wie Sie die SportOase-App auf Render deployen.\n\n## Voraussetzungen\n\n- GitHub Repository mit dem Code\n- Render Account (kostenlos verf√ºgbar)\n\n## Schritt 1: PostgreSQL-Datenbank erstellen\n\n1. Gehen Sie zu [Render Dashboard](https://dashboard.render.com/)\n2. Klicken Sie auf **New +** ‚Üí **PostgreSQL**\n3. Konfiguration:\n   - **Name**: `sportoase-db` (oder ein anderer Name)\n   - **Database**: Leer lassen (wird automatisch generiert)\n   - **User**: Leer lassen (wird automatisch generiert)\n   - **Region**: W√§hlen Sie die n√§chstgelegene Region\n   - **PostgreSQL Version**: 15 oder 16\n   - **Plan**: Free (l√§uft nach 90 Tagen ab, erfordert Backup/Neuaufbau)\n\n4. Klicken Sie auf **Create Database**\n5. Notieren Sie sich die **Internal Database URL** (wird sp√§ter ben√∂tigt)\n6. **WICHTIG**: √Ñndern Sie `postgres://` zu `postgresql://` in der URL\n\n## Schritt 2: Web Service erstellen\n\n1. Klicken Sie auf **New +** ‚Üí **Web Service**\n2. Verbinden Sie Ihr GitHub Repository\n3. Konfiguration:\n\n| Einstellung | Wert |\n|-------------|------|\n| **Name** | `sportoase-app` |\n| **Region** | Gleiche wie Datenbank |\n| **Branch** | `main` |\n| **Build Command** | `pip install -r requirements.txt` |\n| **Start Command** | `gunicorn app:app` |\n| **Plan** | Free |\n\n## Schritt 3: Umgebungsvariablen konfigurieren\n\nF√ºgen Sie diese Umgebungsvariablen hinzu (unter **Environment**):\n\n| Variable | Wert | Beschreibung |\n|----------|------|--------------|\n| `DATABASE_URL` | Internal Database URL von PostgreSQL | **Wichtig**: `postgres://` zu `postgresql://` √§ndern! |\n| `SESSION_SECRET` | Ein zuf√§lliger String | F√ºr Flask Sessions (z.B. 32+ Zeichen) |\n| `PYTHON_VERSION` | `3.11` | Python-Version |\n| `SMTP_HOST` | SMTP-Server | Optional: F√ºr E-Mail-Benachrichtigungen |\n| `SMTP_PORT` | `587` | Optional: SMTP Port |\n| `SMTP_USER` | Ihr SMTP Benutzername | Optional |\n| `SMTP_PASS` | Ihr SMTP Passwort | Optional |\n| `SMTP_FROM` | sportoase@sportoase.de | Optional: Absender-E-Mail |\n| `ADMIN_EMAIL` | sportoase.kg@gmail.com | Admin E-Mail f√ºr Benachrichtigungen |\n\n### Beispiel f√ºr SESSION_SECRET generieren:\n\n```python\nimport os\nprint(os.urandom(32).hex())\n```\n\n## Schritt 4: Datenbank initialisieren\n\n**WICHTIG**: Nach dem ersten Deployment MUSS die Datenbank initialisiert werden!\n\n1. Verbinden Sie sich mit der Render Shell (im Dashboard unter \"Shell\")\n2. F√ºhren Sie aus:\n\n```bash\npython db_setup.py\n```\n\nDies erstellt:\n- Alle Datenbank-Tabellen\n- Den Admin-Account mit:\n  - **Benutzername**: sportoase\n  - **Passwort**: mauro123\n  - **E-Mail**: sportoase.kg@gmail.com\n\n**WICHTIG**: √Ñndern Sie das Passwort nach dem ersten Login!\n\n## Schritt 5: Deployment √ºberpr√ºfen\n\n1. √ñffnen Sie die URL Ihrer App (z.B. `https://sportoase-app.onrender.com`)\n2. Melden Sie sich mit den Admin-Zugangsdaten an\n3. Pr√ºfen Sie, ob alles funktioniert\n\n## E-Mail-Konfiguration (optional)\n\nF√ºr E-Mail-Benachrichtigungen bei Buchungen k√∂nnen Sie einen SMTP-Service verwenden:\n\n### Gmail SMTP (f√ºr Tests):\n- Host: `smtp.gmail.com`\n- Port: `587`\n- User: Ihre Gmail-Adresse\n- Pass: App-spezifisches Passwort (nicht Ihr normales Passwort!)\n\n[Anleitung f√ºr Gmail App-Passwort](https://support.google.com/accounts/answer/185833)\n\n### Professionelle Services:\n- SendGrid (kostenlos bis 100 E-Mails/Tag)\n- Mailgun\n- Amazon SES\n\n## Wichtige Hinweise\n\n1. **Free Tier**: \n   - Web Service schl√§ft nach 15 Min Inaktivit√§t\n   - Erste Anfrage dauert 30-60s zum Aufwachen\n   - PostgreSQL l√§uft nach 90 Tagen ab (Backup erforderlich!)\n\n2. **Datenbank-Backup**:\n   ```bash\n   pg_dump DATABASE_URL > backup.sql\n   ```\n\n3. **Logs √ºberwachen**:\n   - Render Dashboard ‚Üí Ihre App ‚Üí Logs\n   - Hilft bei der Fehlersuche\n\n4. **Updates deployen**:\n   - Pushen Sie zu GitHub\n   - Render deployt automatisch\n   - **Nach gr√∂√üeren Datenbank-√Ñnderungen**: F√ºhren Sie `python db_setup.py` erneut aus\n\n## Troubleshooting\n\n### App startet nicht:\n- Pr√ºfen Sie die Logs in Render Dashboard\n- Stellen Sie sicher, dass `DATABASE_URL` mit `postgresql://` beginnt\n- √úberpr√ºfen Sie, ob alle Pakete in `requirements.txt` sind\n\n### Datenbank-Verbindungsfehler:\n- Verwenden Sie die **Internal Database URL** (nicht External)\n- Best√§tigen Sie, dass die Datenbank \"Available\" ist\n- Pr√ºfen Sie, ob Region von App und DB √ºbereinstimmt\n- **Wichtig**: Haben Sie `python db_setup.py` ausgef√ºhrt?\n\n### \"Tabelle existiert nicht\" Fehler:\n- Sie haben vergessen, `python db_setup.py` auszuf√ºhren!\n- Verbinden Sie sich mit der Shell und f√ºhren Sie das Skript aus\n\n### E-Mails werden nicht gesendet:\n- √úberpr√ºfen Sie SMTP-Einstellungen in den Umgebungsvariablen\n- Testen Sie SMTP-Zugangsdaten lokal\n- Pr√ºfen Sie, ob Port 587 erlaubt ist\n- F√ºr Gmail: Verwenden Sie ein App-spezifisches Passwort\n\n## Lokale Entwicklung\n\nF√ºr die lokale Entwicklung:\n\n1. Installieren Sie PostgreSQL lokal\n2. Erstellen Sie eine `.env` Datei:\n   ```\n   DATABASE_URL=postgresql://localhost:5432/sportoase_dev\n   SESSION_SECRET=dev-secret-key\n   ADMIN_EMAIL=sportoase.kg@gmail.com\n   ```\n3. F√ºhren Sie aus:\n   ```bash\n   python db_setup.py\n   uv run python app.py\n   ```\n\n## Support\n\nBei Fragen zu Render: https://render.com/docs\n","path":null,"size_bytes":5219,"size_tokens":null},"FIXES_NOVEMBER_2025.md":{"content":"# Performance-Fixes November 2025\n\n## Problem\nDie SportOase-App hatte zwei kritische Probleme in der Produktionsumgebung (sportoase.app):\n\n1. **Worker Timeouts**: Die Seite war extrem langsam, und es gab regelm√§√üig Gunicorn Worker-Timeouts\n2. **E-Mails kamen nicht an**: Buchungsbenachrichtigungen wurden nicht versendet\n\n## Ursachen\n\n### 1. Server-Sent Events (SSE) mit Gunicorn\nDas Problem lag am SSE-Endpoint `/notifications/stream`, der f√ºr Echtzeit-Benachrichtigungen verwendet wurde. Gunicorn ist nicht f√ºr Long-Polling und Server-Sent Events optimiert und verursachte:\n- Worker-Timeouts nach 30 Sekunden\n- Blockierte Worker-Threads\n- Extrem langsame Seitenlade-Zeiten\n\n### 2. Gmail-Integration funktioniert nur in Replit\nDie Replit Gmail-Integration ist nur in der Replit-Entwicklungsumgebung verf√ºgbar, nicht aber auf externen Deployments wie Render (sportoase.app).\n\n## L√∂sungen\n\n### 1. SSE deaktiviert ‚Üí Polling-System implementiert\n- ‚úÖ SSE-Endpoint (`/notifications/stream`) wurde deaktiviert\n- ‚úÖ Frontend nutzt jetzt Polling (alle 30 Sekunden) statt SSE\n- ‚úÖ Benachrichtigungen werden weiterhin angezeigt, nur ohne Echtzeit-Updates\n- ‚úÖ Keine Worker-Timeouts mehr\n\n### 2. SMTP E-Mail-Service eingerichtet\n- ‚úÖ Umstellung von Gmail-Integration auf Standard-SMTP\n- ‚úÖ `SMTP_USER` und `SMTP_PASS` als Replit Secrets konfiguriert\n- ‚úÖ E-Mails werden jetzt √ºber Gmail SMTP verschickt\n- ‚úÖ Funktioniert sowohl in Replit als auch in Produktion (Render)\n\n### 3. Deployment-Optimierung\n- ‚úÖ Gunicorn Timeout auf 120 Sekunden erh√∂ht\n- ‚úÖ 2 Worker-Prozesse konfiguriert\n- ‚úÖ `--reuse-port` f√ºr bessere Performance\n\n## Technische Details\n\n### Ge√§nderte Dateien:\n1. **app.py**: SSE-Endpoint auskommentiert\n2. **email_service.py**: Neu geschrieben mit SMTP-only Logik\n3. **templates/base.html**: SSE durch Polling ersetzt\n4. **config.py**: SMTP-Credentials aus Secrets laden\n5. **.replit**: Deployment-Konfiguration optimiert\n\n### Neue Secrets (bereits konfiguriert):\n- `SMTP_USER`: Gmail-Adresse f√ºr E-Mail-Versand\n- `SMTP_PASS`: Gmail App-Passwort (16-stellig)\n\n## Ergebnis\n‚úÖ **App l√§uft jetzt stabil und schnell**\n‚úÖ **Keine Worker-Timeouts mehr**\n‚úÖ **E-Mails werden zuverl√§ssig versendet**\n‚úÖ **Funktioniert sowohl in Replit als auch auf sportoase.app**\n\n## Hinweis f√ºr zuk√ºnftige Updates\nWenn Sie Echtzeit-Benachrichtigungen zur√ºck m√∂chten, sollten Sie:\n- Einen WebSocket-Server verwenden (statt SSE)\n- Oder einen separaten Event-Service (Redis + Socket.io)\n- Gunicorn ist nicht f√ºr Long-Polling geeignet\n\n---\nDatum: 15. November 2025\nStatus: ‚úÖ Alle Probleme behoben\n","path":null,"size_bytes":2611,"size_tokens":null},"notification_service.py":{"content":"import os\nimport json\nimport base64\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nimport subprocess\nfrom datetime import datetime\n\ndef get_gmail_access_token():\n    \"\"\"Holt das Access Token von der Replit Gmail Integration\"\"\"\n    try:\n        hostname = os.environ.get('REPLIT_CONNECTORS_HOSTNAME')\n        x_replit_token = None\n        \n        if os.environ.get('REPL_IDENTITY'):\n            x_replit_token = 'repl ' + os.environ['REPL_IDENTITY']\n        elif os.environ.get('WEB_REPL_RENEWAL'):\n            x_replit_token = 'depl ' + os.environ['WEB_REPL_RENEWAL']\n        \n        if not x_replit_token or not hostname:\n            print(\"Gmail Integration nicht verf√ºgbar - verwende Fallback SMTP\")\n            return None\n        \n        import requests\n        response = requests.get(\n            f'https://{hostname}/api/v2/connection?include_secrets=true&connector_names=google-mail',\n            headers={\n                'Accept': 'application/json',\n                'X_REPLIT_TOKEN': x_replit_token\n            }\n        )\n        \n        if response.status_code == 200:\n            data = response.json()\n            if data.get('items') and len(data['items']) > 0:\n                connection = data['items'][0]\n                access_token = connection.get('settings', {}).get('access_token') or \\\n                             connection.get('settings', {}).get('oauth', {}).get('credentials', {}).get('access_token')\n                return access_token\n        \n        return None\n    except Exception as e:\n        print(f\"Fehler beim Abrufen des Gmail Access Tokens: {e}\")\n        return None\n\ndef send_gmail_notification(to_email, subject, body_html, body_text=None):\n    \"\"\"Sendet eine Email-Benachrichtigung √ºber Gmail API\"\"\"\n    try:\n        access_token = get_gmail_access_token()\n        \n        if not access_token:\n            print(\"WARNUNG: Kein Gmail Access Token verf√ºgbar - Email wird nicht gesendet\")\n            print(\"Stellen Sie sicher, dass die Gmail-Integration eingerichtet ist\")\n            return False\n        \n        from google.auth.transport.requests import Request\n        from google.oauth2.credentials import Credentials\n        from googleapiclient.discovery import build\n        \n        creds = Credentials(token=access_token)\n        \n        service = build('gmail', 'v1', credentials=creds)\n        \n        message = MIMEMultipart('alternative')\n        message['To'] = to_email\n        message['From'] = 'me'\n        message['Subject'] = subject\n        \n        if body_text:\n            part1 = MIMEText(body_text, 'plain')\n            message.attach(part1)\n        \n        part2 = MIMEText(body_html, 'html')\n        message.attach(part2)\n        \n        raw_message = base64.urlsafe_b64encode(message.as_bytes()).decode('utf-8')\n        \n        send_message = service.users().messages().send(\n            userId='me',\n            body={'raw': raw_message}\n        ).execute()\n        \n        print(f\"Email erfolgreich gesendet an {to_email}: {send_message['id']}\")\n        return True\n        \n    except Exception as e:\n        print(f\"Fehler beim Senden der Gmail-Nachricht: {e}\")\n        return False\n\ndef create_booking_notification_email(booking_data):\n    \"\"\"Erstellt eine formatierte Email-Benachrichtigung f√ºr eine neue Buchung\"\"\"\n    teacher_name = booking_data.get('teacher_name', 'Unbekannt')\n    teacher_class = booking_data.get('teacher_class', '')\n    date = booking_data.get('date', '')\n    period = booking_data.get('period', '')\n    offer_label = booking_data.get('offer_label', '')\n    offer_type = booking_data.get('offer_type', '')\n    \n    students = []\n    try:\n        students_json = booking_data.get('students_json', '[]')\n        students = json.loads(students_json) if isinstance(students_json, str) else students_json\n    except:\n        students = []\n    \n    students_count = len(students)\n    \n    if students:\n        students_names = ', '.join([f\"{s['name']} ({s['klasse']})\" for s in students])\n    else:\n        students_names = 'Keine Sch√ºler angegeben'\n    \n    subject = f\"üìÖ Neue Buchung: {offer_label} am {date}\"\n    \n    body_html = f\"\"\"\n    <html>\n    <head>\n        <style>\n            body {{ font-family: Arial, sans-serif; line-height: 1.6; color: #333; }}\n            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; }}\n            .header {{ background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                       color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }}\n            .header h2 {{ margin: 0; }}\n            .content {{ background: #f8f9fa; padding: 20px; border-radius: 8px; }}\n            .info-row {{ margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }}\n            .label {{ font-weight: bold; color: #38bdf8; }}\n            .students-list {{ margin-top: 10px; padding-left: 20px; }}\n            .footer {{ margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; \n                      text-align: center; color: #666; font-size: 12px; }}\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>üè´ SportOase - Neue Buchung</h2>\n            </div>\n            <div class=\"content\">\n                <div class=\"info-row\">\n                    <span class=\"label\">üë§ Lehrkraft:</span> {teacher_name}\n                    {f' ({teacher_class})' if teacher_class else ''}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">üìÖ Datum:</span> {date}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">üïê Stunde:</span> Stunde {period}\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">üìã Angebot:</span> {offer_label}\n                    <span style=\"background: {'#4ade80' if offer_type == 'fest' else '#60a5fa'}; \n                                 color: white; padding: 2px 8px; border-radius: 12px; \n                                 font-size: 11px; margin-left: 8px;\">\n                        {offer_type.upper()}\n                    </span>\n                </div>\n                <div class=\"info-row\">\n                    <span class=\"label\">üë• Anzahl Sch√ºler:</span> {students_count}\n                    <div class=\"students-list\">\n                        {students_names}\n                    </div>\n                </div>\n            </div>\n            <div class=\"footer\">\n                <p>Diese Nachricht wurde automatisch vom SportOase Buchungssystem generiert.</p>\n                <p>Zeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Neue Buchung\n\nLehrkraft: {teacher_name} {f'({teacher_class})' if teacher_class else ''}\nDatum: {date}\nStunde: Stunde {period}\nAngebot: {offer_label} ({offer_type.upper()})\nAnzahl Sch√ºler: {students_count}\nSch√ºler: {students_names}\n\nZeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n    \"\"\"\n    \n    return subject, body_html, body_text\n\ndef send_booking_notification(booking_data, admin_email):\n    \"\"\"Sendet eine Buchungsbenachrichtigung an den Admin\"\"\"\n    try:\n        subject, body_html, body_text = create_booking_notification_email(booking_data)\n        return send_gmail_notification(admin_email, subject, body_html, body_text)\n    except Exception as e:\n        print(f\"Fehler beim Senden der Buchungsbenachrichtigung: {e}\")\n        return False\n","path":null,"size_bytes":7606,"size_tokens":null},"test_gmail.py":{"content":"#!/usr/bin/env python3\n\"\"\"Test-Skript f√ºr Gmail-Integration und Benachrichtigungen\"\"\"\n\nimport os\nfrom notification_service import send_gmail_notification, send_booking_notification\nfrom datetime import datetime\n\ndef test_simple_email():\n    \"\"\"Sendet eine einfache Test-Email\"\"\"\n    print(\"=\" * 50)\n    print(\"TEST 1: Einfache Test-Email\")\n    print(\"=\" * 50)\n    \n    admin_email = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n    subject = \"‚úÖ SportOase Gmail-Integration Test\"\n    \n    body_html = \"\"\"\n    <html>\n    <head>\n        <style>\n            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n            .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n            .header { background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); \n                     color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }\n            .content { background: #f8f9fa; padding: 20px; border-radius: 8px; }\n        </style>\n    </head>\n    <body>\n        <div class=\"container\">\n            <div class=\"header\">\n                <h2>üéâ Gmail-Integration erfolgreich!</h2>\n            </div>\n            <div class=\"content\">\n                <p>Die Gmail-Integration f√ºr das SportOase Buchungssystem wurde erfolgreich eingerichtet.</p>\n                <p><strong>Testzeit:</strong> \"\"\" + datetime.now().strftime('%d.%m.%Y um %H:%M Uhr') + \"\"\"</p>\n                <p>E-Mail-Benachrichtigungen funktionieren jetzt einwandfrei! ‚úÖ</p>\n            </div>\n        </div>\n    </body>\n    </html>\n    \"\"\"\n    \n    body_text = f\"\"\"\nSportOase - Gmail-Integration Test\n\nDie Gmail-Integration wurde erfolgreich eingerichtet.\nTestzeit: {datetime.now().strftime('%d.%m.%Y um %H:%M Uhr')}\n\nE-Mail-Benachrichtigungen funktionieren jetzt einwandfrei!\n    \"\"\"\n    \n    success = send_gmail_notification(admin_email, subject, body_html, body_text)\n    \n    if success:\n        print(f\"‚úÖ Test-Email erfolgreich gesendet an {admin_email}\")\n    else:\n        print(f\"‚ùå Fehler beim Senden der Test-Email\")\n    \n    return success\n\ndef test_booking_notification():\n    \"\"\"Testet eine Buchungsbenachrichtigung\"\"\"\n    print(\"\\n\" + \"=\" * 50)\n    print(\"TEST 2: Buchungsbenachrichtigung\")\n    print(\"=\" * 50)\n    \n    admin_email = os.environ.get('ADMIN_EMAIL', 'sportoase.kg@gmail.com')\n    \n    # Simuliere Buchungsdaten\n    booking_data = {\n        'teacher_name': 'Max Mustermann',\n        'teacher_class': '5a',\n        'date': '2025-11-20',\n        'period': 3,\n        'offer_label': 'Basketball',\n        'offer_type': 'fest',\n        'students_json': '[{\"name\": \"Anna Schmidt\", \"klasse\": \"5a\"}, {\"name\": \"Tom M√ºller\", \"klasse\": \"5b\"}]'\n    }\n    \n    success = send_booking_notification(booking_data, admin_email)\n    \n    if success:\n        print(f\"‚úÖ Buchungsbenachrichtigung erfolgreich gesendet an {admin_email}\")\n    else:\n        print(f\"‚ùå Fehler beim Senden der Buchungsbenachrichtigung\")\n    \n    return success\n\nif __name__ == '__main__':\n    print(\"\\nüîç Starte Gmail-Integration Tests...\\n\")\n    \n    # Test 1: Einfache Email\n    test1_result = test_simple_email()\n    \n    # Test 2: Buchungsbenachrichtigung\n    test2_result = test_booking_notification()\n    \n    # Zusammenfassung\n    print(\"\\n\" + \"=\" * 50)\n    print(\"ZUSAMMENFASSUNG\")\n    print(\"=\" * 50)\n    print(f\"Test 1 (Einfache Email): {'‚úÖ BESTANDEN' if test1_result else '‚ùå FEHLGESCHLAGEN'}\")\n    print(f\"Test 2 (Buchungsbenachrichtigung): {'‚úÖ BESTANDEN' if test2_result else '‚ùå FEHLGESCHLAGEN'}\")\n    \n    if test1_result and test2_result:\n        print(\"\\nüéâ Alle Tests erfolgreich! Gmail-Integration funktioniert perfekt.\")\n    else:\n        print(\"\\n‚ö†Ô∏è Einige Tests sind fehlgeschlagen. Bitte Logs pr√ºfen.\")\n","path":null,"size_bytes":3762,"size_tokens":null},"GOOGLE_CALENDAR_SETUP.md":{"content":"# Google Calendar Integration Setup\n\nDiese Anleitung erkl√§rt, wie Sie die Google Calendar Integration f√ºr das SportOase Buchungssystem einrichten.\n\n## Schritt 1: Google Cloud Service Account erstellen\n\n1. Gehen Sie zur [Google Cloud Console](https://console.cloud.google.com/)\n2. Erstellen Sie ein neues Projekt oder w√§hlen Sie ein bestehendes aus\n3. Aktivieren Sie die **Google Calendar API**:\n   - Navigieren Sie zu \"APIs & Services\" > \"Library\"\n   - Suchen Sie nach \"Google Calendar API\"\n   - Klicken Sie auf \"Enable\"\n\n## Schritt 2: Service Account erstellen\n\n1. Gehen Sie zu \"APIs & Services\" > \"Credentials\"\n2. Klicken Sie auf \"Create Credentials\" > \"Service Account\"\n3. Geben Sie einen Namen ein (z.B. \"sportoase-calendar\")\n4. Klicken Sie auf \"Create and Continue\"\n5. √úberspringen Sie die optionalen Schritte und klicken Sie auf \"Done\"\n\n## Schritt 3: Service Account Key erstellen\n\n1. Klicken Sie auf den neu erstellten Service Account\n2. Gehen Sie zum Tab \"Keys\"\n3. Klicken Sie auf \"Add Key\" > \"Create new key\"\n4. W√§hlen Sie **JSON** als Schl√ºsseltyp\n5. Klicken Sie auf \"Create\"\n6. Eine JSON-Datei wird heruntergeladen - **bewahren Sie diese sicher auf!**\n\n## Schritt 4: Service Account Zugriff auf Calendar geben\n\n1. √ñffnen Sie [Google Calendar](https://calendar.google.com/)\n2. W√§hlen Sie den Kalender aus, in dem die Buchungen erscheinen sollen\n3. Klicken Sie auf die drei Punkte neben dem Kalender > \"Settings and sharing\"\n4. Scrollen Sie zu \"Share with specific people\"\n5. Klicken Sie auf \"Add people\"\n6. Geben Sie die **Service Account E-Mail** ein (steht in der JSON-Datei als `client_email`)\n7. W√§hlen Sie die Berechtigung **\"Make changes to events\"**\n8. Klicken Sie auf \"Send\"\n\n## Schritt 5: Umgebungsvariablen konfigurieren\n\n### F√ºr Replit:\n1. √ñffnen Sie die **Secrets** in Replit (üîí Icon in der Sidebar)\n2. F√ºgen Sie folgende Secrets hinzu:\n\n**GOOGLE_CALENDAR_CREDENTIALS**\n```\nDer komplette Inhalt der JSON-Datei als String\n```\n\n**GOOGLE_CALENDAR_ID** (optional)\n```\nprimary\n```\n(Oder die spezifische Calendar ID, wenn Sie einen anderen Kalender verwenden m√∂chten)\n\n### F√ºr Render / andere Umgebungen:\n1. Gehen Sie zu den Environment Variables\n2. F√ºgen Sie hinzu:\n   - **GOOGLE_CALENDAR_CREDENTIALS**: Kompletter JSON-Inhalt als String\n   - **GOOGLE_CALENDAR_ID**: `primary` (oder spezifische Calendar ID)\n\n## Schritt 6: Datenbank-Migration ausf√ºhren\n\nF√ºhren Sie das Migrations-Script aus, um die `calendar_event_id` Spalte hinzuzuf√ºgen:\n\n```bash\npython migration_add_calendar_event_id.py\n```\n\n## Schritt 7: Anwendung neu starten\n\nStarten Sie die Anwendung neu, damit die √Ñnderungen wirksam werden.\n\n## Testen\n\n1. Erstellen Sie eine neue Buchung √ºber die Webseite\n2. √úberpr√ºfen Sie Ihren Google Calendar - es sollte ein neuer Eintrag erscheinen\n3. Die Logs sollten zeigen: `‚úì Google Calendar Service erfolgreich initialisiert`\n\n## Fehlersuche\n\n### \"Google Calendar nicht konfiguriert\"\n- √úberpr√ºfen Sie, ob die `GOOGLE_CALENDAR_CREDENTIALS` Secret gesetzt ist\n- Stellen Sie sicher, dass es g√ºltiges JSON ist\n\n### \"403 Forbidden\" Fehler\n- √úberpr√ºfen Sie, ob der Service Account Zugriff auf den Kalender hat\n- Stellen Sie sicher, dass die Google Calendar API aktiviert ist\n\n### Kalender-Eintr√§ge erscheinen nicht\n- √úberpr√ºfen Sie die `GOOGLE_CALENDAR_ID` (sollte `primary` sein f√ºr den Hauptkalender)\n- Pr√ºfen Sie die Logs auf Fehlermeldungen\n\n## Hinweise\n\n- Die Calendar-Integration ist **optional** - die App funktioniert auch ohne sie\n- Wenn die Integration nicht konfiguriert ist, werden nur E-Mails versendet\n- Bei Buchungsl√∂schungen wird automatisch auch der Calendar-Eintrag gel√∂scht\n- Jeder Calendar-Eintrag enth√§lt:\n  - Titel: \"SportOase: [Angebot]\"\n  - Datum und Uhrzeit der Stunde\n  - Lehrkraft und Klasse\n  - Liste aller gebuchten Sch√ºler\n  - Erinnerungen (1 Tag vorher, 1 Stunde vorher)\n","path":null,"size_bytes":3857,"size_tokens":null},"calendar_service.py":{"content":"\"\"\"\nGoogle Calendar Service f√ºr SportOase Buchungssystem\nErstellt automatisch Kalendereintr√§ge bei Buchungen\n\"\"\"\n\nimport os\nimport json\nfrom datetime import datetime, timedelta\nfrom google.oauth2 import service_account\nfrom googleapiclient.discovery import build\nfrom googleapiclient.errors import HttpError\n\n# Globale Variablen f√ºr Calendar Service\n_calendar_service = None\n_calendar_enabled = False\n\ndef init_calendar_service():\n    \"\"\"\n    Initialisiert den Google Calendar Service mit Service Account Credentials\n    Gibt True zur√ºck wenn erfolgreich, False wenn Kalender deaktiviert ist\n    \"\"\"\n    global _calendar_service, _calendar_enabled\n    \n    # Pr√ºfe ob Google Calendar Credentials vorhanden sind\n    credentials_json = os.environ.get('GOOGLE_CALENDAR_CREDENTIALS')\n    \n    if not credentials_json:\n        print(\"INFO: Google Calendar nicht konfiguriert (GOOGLE_CALENDAR_CREDENTIALS fehlt)\")\n        _calendar_enabled = False\n        return False\n    \n    try:\n        # Parse die Service Account Credentials aus dem JSON String\n        credentials_info = json.loads(credentials_json)\n        \n        # Erstelle Credentials Objekt\n        credentials = service_account.Credentials.from_service_account_info(\n            credentials_info,\n            scopes=['https://www.googleapis.com/auth/calendar']\n        )\n        \n        # Erstelle Calendar Service\n        _calendar_service = build('calendar', 'v3', credentials=credentials)\n        _calendar_enabled = True\n        print(\"‚úì Google Calendar Service erfolgreich initialisiert\")\n        return True\n        \n    except json.JSONDecodeError as e:\n        print(f\"FEHLER: Google Calendar Credentials sind kein g√ºltiges JSON: {e}\")\n        _calendar_enabled = False\n        return False\n    except Exception as e:\n        print(f\"FEHLER: Google Calendar Service konnte nicht initialisiert werden: {e}\")\n        _calendar_enabled = False\n        return False\n\ndef is_calendar_enabled():\n    \"\"\"Gibt True zur√ºck wenn Google Calendar aktiviert ist\"\"\"\n    return _calendar_enabled\n\ndef create_booking_event(booking_data):\n    \"\"\"\n    Erstellt einen Google Calendar Eintrag f√ºr eine Buchung\n    \n    Args:\n        booking_data: Dictionary mit Buchungsdaten\n            - date: Datum als String (YYYY-MM-DD)\n            - period: Stundennummer (1-6)\n            - teacher_name: Name der Lehrkraft\n            - teacher_class: Klasse der Lehrkraft\n            - students: Liste von Sch√ºlern [{'name': '...', 'class': '...'}, ...]\n            - offer_label: Label des Angebots\n    \n    Returns:\n        Dictionary mit 'success' (True/False) und 'event_id' oder 'error'\n    \"\"\"\n    global _calendar_service, _calendar_enabled\n    \n    # Wenn Calendar nicht aktiviert, gebe Warnung zur√ºck\n    if not _calendar_enabled:\n        return {\n            'success': False,\n            'error': 'Google Calendar ist nicht konfiguriert'\n        }\n    \n    try:\n        from config import PERIOD_TIMES\n        \n        # Hole Zeitdaten f√ºr die Stunde\n        period = booking_data['period']\n        period_time = PERIOD_TIMES[period]\n        \n        # Erstelle Start- und End-Datetime\n        booking_date = datetime.strptime(booking_data['date'], '%Y-%m-%d')\n        \n        # Parse Start- und Endzeit\n        start_hour, start_minute = map(int, period_time['start'].split(':'))\n        end_hour, end_minute = map(int, period_time['end'].split(':'))\n        \n        start_datetime = booking_date.replace(hour=start_hour, minute=start_minute)\n        end_datetime = booking_date.replace(hour=end_hour, minute=end_minute)\n        \n        # Formatiere f√ºr Google Calendar (ISO 8601)\n        start_time = start_datetime.isoformat()\n        end_time = end_datetime.isoformat()\n        \n        # Erstelle Sch√ºlerliste f√ºr Beschreibung\n        students_list = '\\n'.join([\n            f\"  ‚Ä¢ {s['name']} ({s.get('klasse', s.get('class', 'N/A'))})\" \n            for s in booking_data['students']\n        ])\n        \n        # Erstelle Event\n        event = {\n            'summary': f\"SportOase: {booking_data['offer_label']}\",\n            'description': f\"\"\"SportOase Buchung\n            \nLehrkraft: {booking_data['teacher_name']} ({booking_data['teacher_class']})\nAngebot: {booking_data['offer_label']}\nStunde: {period}. Stunde ({period_time['start']} - {period_time['end']})\n\nSch√ºler ({len(booking_data['students'])}):\n{students_list}\n\n--- \nErstellt durch SportOase Buchungssystem\n\"\"\",\n            'start': {\n                'dateTime': start_time,\n                'timeZone': 'Europe/Berlin',\n            },\n            'end': {\n                'dateTime': end_time,\n                'timeZone': 'Europe/Berlin',\n            },\n            'reminders': {\n                'useDefault': False,\n                'overrides': [\n                    {'method': 'email', 'minutes': 24 * 60},  # 1 Tag vorher\n                    {'method': 'popup', 'minutes': 60},       # 1 Stunde vorher\n                ],\n            },\n        }\n        \n        # Hole Calendar ID aus Umgebungsvariablen (default: primary)\n        calendar_id = os.environ.get('GOOGLE_CALENDAR_ID', 'primary')\n        \n        # Erstelle Event in Google Calendar\n        created_event = _calendar_service.events().insert(\n            calendarId=calendar_id,\n            body=event\n        ).execute()\n        \n        print(f\"‚úì Google Calendar Eintrag erstellt: {created_event.get('htmlLink')}\")\n        \n        return {\n            'success': True,\n            'event_id': created_event['id'],\n            'event_link': created_event.get('htmlLink')\n        }\n        \n    except HttpError as error:\n        error_msg = f\"Google Calendar API Fehler: {error}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n    except Exception as e:\n        error_msg = f\"Fehler beim Erstellen des Calendar Eintrags: {e}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n\ndef delete_booking_event(event_id):\n    \"\"\"\n    L√∂scht einen Google Calendar Eintrag\n    \n    Args:\n        event_id: Die Google Calendar Event ID\n    \n    Returns:\n        Dictionary mit 'success' (True/False) und optional 'error'\n    \"\"\"\n    global _calendar_service, _calendar_enabled\n    \n    if not _calendar_enabled:\n        return {\n            'success': False,\n            'error': 'Google Calendar ist nicht konfiguriert'\n        }\n    \n    if not event_id:\n        return {\n            'success': False,\n            'error': 'Keine Event ID angegeben'\n        }\n    \n    try:\n        calendar_id = os.environ.get('GOOGLE_CALENDAR_ID', 'primary')\n        \n        _calendar_service.events().delete(\n            calendarId=calendar_id,\n            eventId=event_id\n        ).execute()\n        \n        print(f\"‚úì Google Calendar Eintrag gel√∂scht: {event_id}\")\n        \n        return {'success': True}\n        \n    except HttpError as error:\n        error_msg = f\"Google Calendar API Fehler: {error}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n    except Exception as e:\n        error_msg = f\"Fehler beim L√∂schen des Calendar Eintrags: {e}\"\n        print(f\"FEHLER: {error_msg}\")\n        return {\n            'success': False,\n            'error': error_msg\n        }\n","path":null,"size_bytes":7408,"size_tokens":null},"migration_add_oauth_fields.py":{"content":"# Datenbank-Migration: F√ºgt OAuth-Felder zur users-Tabelle hinzu\n# F√ºhre dieses Skript einmalig aus, um die Datenbank zu aktualisieren\n\nfrom app import app, db\n\ndef add_oauth_fields():\n    \"\"\"F√ºgt oauth_provider und oauth_id Felder zur users-Tabelle hinzu\"\"\"\n    with app.app_context():\n        try:\n            # ALTER TABLE mit PostgreSQL\n            db.session.execute(db.text('''\n                ALTER TABLE users \n                ADD COLUMN IF NOT EXISTS oauth_provider VARCHAR(50),\n                ADD COLUMN IF NOT EXISTS oauth_id VARCHAR(200)\n            '''))\n            \n            # Password_hash nullable machen\n            db.session.execute(db.text('''\n                ALTER TABLE users \n                ALTER COLUMN password_hash DROP NOT NULL\n            '''))\n            \n            # Unique Constraint hinzuf√ºgen\n            db.session.execute(db.text('''\n                ALTER TABLE users \n                ADD CONSTRAINT unique_oauth_user \n                UNIQUE (oauth_provider, oauth_id)\n            '''))\n            \n            # Index auf email hinzuf√ºgen falls noch nicht vorhanden\n            db.session.execute(db.text('''\n                CREATE INDEX IF NOT EXISTS ix_users_email ON users(email)\n            '''))\n            \n            db.session.commit()\n            print(\"‚úÖ OAuth-Felder erfolgreich zur users-Tabelle hinzugef√ºgt!\")\n            print(\"   - oauth_provider VARCHAR(50)\")\n            print(\"   - oauth_id VARCHAR(200)\")\n            print(\"   - password_hash ist jetzt nullable\")\n            print(\"   - Unique Constraint auf (oauth_provider, oauth_id)\")\n            print(\"   - Index auf email-Feld\")\n            \n        except Exception as e:\n            db.session.rollback()\n            print(f\"‚ùå Fehler bei der Migration: {e}\")\n            print(\"Hinweis: Wenn Felder bereits existieren, ist das normal.\")\n\nif __name__ == '__main__':\n    print(\"Starte OAuth-Felder Migration...\")\n    add_oauth_fields()\n","path":null,"size_bytes":1970,"size_tokens":null},"oauth_config.py":{"content":"# IServ OAuth2/OpenID Connect Konfiguration f√ºr SportOase\n# Diese Datei konfiguriert die SSO-Integration mit IServ\n# Unterst√ºtzt sowohl ROLES als auch GROUPS f√ºr maximale Kompatibilit√§t\n\nimport os\nimport json\nfrom authlib.integrations.flask_client import OAuth\n\n\ndef init_oauth(app):\n    \"\"\"Initialisiert OAuth2 mit IServ-Konfiguration\"\"\"\n    oauth = OAuth(app)\n\n    # IServ-Instanz-Domain aus Umgebungsvariablen\n    iserv_domain = os.environ.get('ISERV_DOMAIN', 'kgs-pattensen.de')\n    iserv_base_url = f'https://{iserv_domain}'\n\n    # Registriere IServ als OAuth-Provider\n    # Scopes: openid, profile, email, roles UND groups f√ºr maximale Kompatibilit√§t\n    # IServ-Dokumentation: https://doku.iserv.de/manage/system/sso/\n    iserv = oauth.register(\n        name='iserv',\n        client_id=os.environ.get('ISERV_CLIENT_ID'),\n        client_secret=os.environ.get('ISERV_CLIENT_SECRET'),\n        server_metadata_url=f'{iserv_base_url}/.well-known/openid-configuration',\n        client_kwargs={'scope': 'openid profile email roles groups'})\n\n    return oauth, iserv\n\n\ndef get_admin_email():\n    \"\"\"Gibt die E-Mail-Adresse des Admin-Benutzers zur√ºck\"\"\"\n    return 'morelli.maurizio@kgs-pattensen.de'\n\n\ndef is_admin_email(email):\n    \"\"\"Pr√ºft, ob die E-Mail-Adresse dem Admin geh√∂rt\"\"\"\n    return email and email.lower().strip() == get_admin_email().lower()\n\n\ndef extract_roles_from_userinfo(userinfo):\n    \"\"\"\n    Extrahiert Rollennamen aus IServ userinfo.\n    \n    IServ-Format laut Dokumentation (Scope: roles):\n    {\n        \"roles\": [\n            {\"uuid\": \"...\", \"id\": 123, \"name\": \"Lehrer\"},\n            {\"uuid\": \"...\", \"id\": 456, \"name\": \"Mitarbeiter\"}\n        ]\n    }\n    \n    Gibt eine Liste von Rollennamen zur√ºck (lowercase).\n    \"\"\"\n    roles = []\n    \n    # IServ liefert Rollen im Feld \"roles\" als Liste von Objekten\n    if 'roles' in userinfo:\n        roles_data = userinfo['roles']\n        print(f\"   üìã Raw 'roles' data: {roles_data}\")\n        \n        if isinstance(roles_data, list):\n            for role_item in roles_data:\n                if isinstance(role_item, dict):\n                    # IServ-Format: {\"uuid\": \"...\", \"id\": 123, \"name\": \"Lehrer\"}\n                    if 'name' in role_item and isinstance(role_item['name'], str):\n                        roles.append(role_item['name'].lower().strip())\n                        print(f\"   ‚úì Rolle extrahiert: {role_item['name']}\")\n                elif isinstance(role_item, str):\n                    # Fallback: direkter String\n                    roles.append(role_item.lower().strip())\n                    print(f\"   ‚úì Rolle (String): {role_item}\")\n        elif isinstance(roles_data, str):\n            # Falls roles ein einzelner String ist\n            roles.append(roles_data.lower().strip())\n            print(f\"   ‚úì Rolle (einzelner String): {roles_data}\")\n    else:\n        print(f\"   ‚ö†Ô∏è Kein 'roles' Feld in userinfo gefunden\")\n    \n    # Entferne Duplikate und leere Strings\n    return list(set(r for r in roles if r))\n\n\ndef extract_groups_from_userinfo(userinfo):\n    \"\"\"\n    Extrahiert Gruppennamen aus IServ userinfo.\n    \n    IServ-Format laut Dokumentation (Scope: groups):\n    {\n        \"groups\": [\n            {\"id\": 123, \"uuid\": \"...\", \"act\": \"lehrer\", \"name\": \"Lehrer\"},\n            {\"id\": 456, \"uuid\": \"...\", \"act\": \"mitarbeiter\", \"name\": \"Mitarbeiter\"}\n        ]\n    }\n    \n    Gibt eine Liste von Gruppennamen zur√ºck (lowercase).\n    \"\"\"\n    groups = []\n    \n    if 'groups' in userinfo:\n        groups_data = userinfo['groups']\n        print(f\"   üìã Raw 'groups' data: {groups_data}\")\n        \n        if isinstance(groups_data, list):\n            for group_item in groups_data:\n                if isinstance(group_item, dict):\n                    # IServ-Format: {\"id\": 123, \"uuid\": \"...\", \"act\": \"lehrer\", \"name\": \"Lehrer\"}\n                    if 'name' in group_item and isinstance(group_item['name'], str):\n                        groups.append(group_item['name'].lower().strip())\n                        print(f\"   ‚úì Gruppe extrahiert (name): {group_item['name']}\")\n                    if 'act' in group_item and isinstance(group_item['act'], str):\n                        groups.append(group_item['act'].lower().strip())\n                        print(f\"   ‚úì Gruppe extrahiert (act): {group_item['act']}\")\n                elif isinstance(group_item, str):\n                    groups.append(group_item.lower().strip())\n                    print(f\"   ‚úì Gruppe (String): {group_item}\")\n        elif isinstance(groups_data, str):\n            groups.append(groups_data.lower().strip())\n            print(f\"   ‚úì Gruppe (einzelner String): {groups_data}\")\n    else:\n        print(f\"   ‚ö†Ô∏è Kein 'groups' Feld in userinfo gefunden\")\n    \n    return list(set(g for g in groups if g))\n\n\ndef determine_user_role(userinfo):\n    \"\"\"\n    Bestimmt die Rolle des Benutzers basierend auf IServ-ROLLEN und GRUPPEN.\n    \n    Regelwerk:\n    1. Admin-E-Mail ‚Üí admin (immer erlaubt)\n    2. Rolle/Gruppe enth√§lt \"Lehrer\", \"Mitarbeiter\", etc. ‚Üí teacher\n    3. Rolle/Gruppe enth√§lt \"Sch√ºler\" ‚Üí KEIN ZUGANG\n    4. Keine passende Rolle/Gruppe ‚Üí KEIN ZUGANG\n    \n    Args:\n        userinfo: Dictionary mit Benutzerdaten von IServ\n    \n    Returns:\n        Tuple: (role, iserv_role) wobei:\n        - role: 'admin', 'teacher' oder None (kein Zugang)\n        - iserv_role: Die erkannte IServ-Rolle/Gruppe\n    \"\"\"\n    email = userinfo.get('email', '').lower().strip()\n\n    # === AUSF√úHRLICHES LOGGING ===\n    print(\"=\" * 70)\n    print(f\"üîê IServ OAuth Login-Versuch\")\n    print(f\"   E-Mail: {email}\")\n    print(f\"   UserInfo Keys: {list(userinfo.keys())}\")\n    print(\"-\" * 70)\n    \n    # Logge die komplette userinfo f√ºr Debugging\n    print(f\"   üìã Komplette UserInfo:\")\n    for key, value in userinfo.items():\n        value_str = str(value)\n        if len(value_str) > 300:\n            value_str = value_str[:300] + \"...\"\n        print(f\"      {key}: {value_str}\")\n    \n    print(\"-\" * 70)\n    \n    # Extrahiere Rollen UND Gruppen\n    roles = extract_roles_from_userinfo(userinfo)\n    groups = extract_groups_from_userinfo(userinfo)\n    \n    # Kombiniere Rollen und Gruppen f√ºr die Pr√ºfung\n    all_memberships = roles + groups\n    \n    print(\"-\" * 70)\n    print(f\"   üè∑Ô∏è Extrahierte Rollen: {roles}\")\n    print(f\"   üë• Extrahierte Gruppen: {groups}\")\n    print(f\"   üìä Kombinierte Mitgliedschaften: {all_memberships}\")\n    print(\"=\" * 70)\n\n    # 1. Admin-E-Mail hat immer Admin-Zugang\n    if is_admin_email(email):\n        print(f\"   ‚úÖ Admin erkannt (E-Mail-Match: {get_admin_email()})\")\n        return 'admin', 'Administrator'\n\n    # Pr√ºfe E-Mail-Domain\n    if not email.endswith('@kgs-pattensen.de'):\n        print(f\"   ‚ùå KEIN ZUGANG - Keine @kgs-pattensen.de E-Mail\")\n        return None, None\n\n    # 2. Pr√ºfe auf erlaubte Rollen/Gruppen\n    # Diese Keywords geben Zugang (EINHEITLICHE RECHTE als 'teacher'):\n    allowed_keywords = [\n        # Schulleitung\n        'schulleitung',\n        # Lehrer\n        'lehrer',\n        'lehrerin',\n        'teacher',\n        # Sozialp√§dagogen\n        'sozialp√§dagog',\n        'sozialpaedagog',\n        'sozialp√§dagogin',\n        # P√§dagogische Mitarbeiter\n        'p√§dagogische mitarbeiter',\n        'paedagogische mitarbeiter',\n        'p√§dagogischer mitarbeiter',\n        # Mitarbeiter (allgemein)\n        'mitarbeiter',\n        'mitarbeitende',\n        'mitarbeiterin',\n        # Sekretariat\n        'sekretariat',\n        'verwaltung',\n    ]\n    \n    # Sch√ºler werden blockiert\n    blocked_keywords = [\n        'sch√ºler',\n        'schueler',\n        'sch√ºlerin',\n        'schuelerin',\n        'student',\n        'students',\n    ]\n    \n    # Zuerst pr√ºfen ob blockierte Rolle/Gruppe vorhanden\n    for membership in all_memberships:\n        for blocked in blocked_keywords:\n            if blocked in membership:\n                print(f\"   ‚ùå KEIN ZUGANG - Sch√ºler-Rolle/Gruppe erkannt: '{membership}'\")\n                return None, None\n    \n    # Dann pr√ºfen ob erlaubte Rolle/Gruppe vorhanden\n    for membership in all_memberships:\n        for allowed in allowed_keywords:\n            if allowed in membership:\n                # Formatiere f√ºr Anzeige\n                display_role = membership.replace('_', ' ').title()\n                print(f\"   ‚úÖ Zugang gew√§hrt - Rolle/Gruppe erkannt: '{membership}' (matched '{allowed}')\")\n                return 'teacher', display_role\n    \n    # Keine passende Rolle/Gruppe gefunden\n    if all_memberships:\n        print(f\"   ‚ùå KEIN ZUGANG - Keine erlaubte Rolle/Gruppe gefunden\")\n        print(f\"   ‚ÑπÔ∏è Gefundene Mitgliedschaften: {all_memberships}\")\n        print(f\"   ‚ÑπÔ∏è Erlaubte Keywords: {allowed_keywords[:5]}... (und weitere)\")\n    else:\n        print(f\"   ‚ùå KEIN ZUGANG - Keine Rollen/Gruppen in userinfo gefunden\")\n        print(f\"   ‚ö†Ô∏è HINWEIS: Stellen Sie sicher, dass in IServ Admin ‚Üí Single-Sign-On\")\n        print(f\"      die Scopes 'roles' und/oder 'groups' f√ºr diese App aktiviert sind!\")\n    \n    return None, None\n","path":null,"size_bytes":9087,"size_tokens":null},"migration_add_calendar_event_id.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nMigrations-Script: F√ºgt calendar_event_id Spalte zur bookings Tabelle hinzu\n\nDieses Script erweitert die bookings Tabelle um die calendar_event_id Spalte,\ndie f√ºr die Google Calendar Integration ben√∂tigt wird.\n\"\"\"\n\nimport os\nimport psycopg2\nfrom urllib.parse import urlparse\n\ndef add_calendar_event_id_column():\n    \"\"\"F√ºgt die calendar_event_id Spalte zur bookings Tabelle hinzu\"\"\"\n    \n    # Hole DATABASE_URL\n    database_url = os.environ.get('DATABASE_URL')\n    if not database_url:\n        print(\"FEHLER: DATABASE_URL Umgebungsvariable nicht gesetzt!\")\n        return False\n    \n    try:\n        # Verbinde zur Datenbank\n        conn = psycopg2.connect(database_url)\n        cursor = conn.cursor()\n        \n        print(\"Verbunden mit der Datenbank...\")\n        \n        # Pr√ºfe ob Spalte bereits existiert\n        cursor.execute(\"\"\"\n            SELECT column_name \n            FROM information_schema.columns \n            WHERE table_name='bookings' AND column_name='calendar_event_id';\n        \"\"\")\n        \n        if cursor.fetchone():\n            print(\"‚úì Spalte 'calendar_event_id' existiert bereits - keine Migration n√∂tig\")\n            cursor.close()\n            conn.close()\n            return True\n        \n        # F√ºge Spalte hinzu\n        print(\"F√ºge Spalte 'calendar_event_id' zur Tabelle 'bookings' hinzu...\")\n        cursor.execute(\"\"\"\n            ALTER TABLE bookings \n            ADD COLUMN calendar_event_id VARCHAR(200);\n        \"\"\")\n        \n        conn.commit()\n        print(\"‚úì Migration erfolgreich abgeschlossen!\")\n        print(\"  - Spalte 'calendar_event_id' wurde zur Tabelle 'bookings' hinzugef√ºgt\")\n        \n        cursor.close()\n        conn.close()\n        return True\n        \n    except Exception as e:\n        print(f\"FEHLER bei der Migration: {e}\")\n        return False\n\nif __name__ == '__main__':\n    print(\"=\" * 60)\n    print(\"SportOase - Datenbank Migration\")\n    print(\"F√ºgt calendar_event_id Spalte hinzu\")\n    print(\"=\" * 60)\n    print()\n    \n    success = add_calendar_event_id_column()\n    \n    print()\n    if success:\n        print(\"‚úì Migration erfolgreich abgeschlossen!\")\n    else:\n        print(\"‚úó Migration fehlgeschlagen - bitte Fehler √ºberpr√ºfen\")\n    print(\"=\" * 60)\n","path":null,"size_bytes":2275,"size_tokens":null},"ISERV_INTEGRATION_SETUP.md":{"content":"# IServ SSO Integration - Setup-Anleitung f√ºr SportOase\n\nDiese Anleitung beschreibt, wie Sie die SportOase-App mit IServ SSO (Single Sign-On) verbinden.\n\n## √úbersicht\n\nDie SportOase-App unterst√ºtzt **OAuth2/OpenID Connect** f√ºr die Authentifizierung √ºber IServ. Damit k√∂nnen sich Lehrkr√§fte mit ihrem IServ-Account anmelden, ohne ein separates Passwort f√ºr SportOase zu ben√∂tigen.\n\n### Rollenverwaltung\n\n- **Admin**: `morelli.maurizio@kgs-pattensen.de` erh√§lt automatisch Admin-Rechte\n- **Lehrer**: Alle anderen IServ-Benutzer erhalten normale Lehrkraft-Rechte (keine Admin-Funktionen)\n\n## Schritt 1: IServ-Admin-Konfiguration\n\n### 1.1 Neue OAuth-Anwendung registrieren\n\nDer IServ-Administrator muss folgende Schritte durchf√ºhren:\n\n1. In IServ einloggen als Administrator\n2. Navigieren zu: **Verwaltung ‚Üí System ‚Üí Single-Sign-On**\n3. Klicken auf **\"Hinzuf√ºgen\"**\n\n### 1.2 Allgemeine Einstellungen\n\nFolgende Daten eingeben:\n\n| Feld | Wert |\n|------|------|\n| **Name** | SportOase Buchungssystem |\n| **Beschreibung** | Buchungssystem f√ºr die SportOase-Anmeldungen |\n| **Vertrauensw√ºrdig** | ‚úÖ Ja (Haken setzen) |\n\n**Wichtig**: Nach dem Speichern werden automatisch generiert:\n- **Client-ID** (z.B. `sportoase_1234567`)\n- **Client-Secret** (z.B. `a1b2c3d4...xyz`)\n\n‚û°Ô∏è **Diese Werte notieren und sicher aufbewahren!**\n\n### 1.3 Redirect URIs konfigurieren\n\nIn der OAuth-Konfiguration unter \"Anwendung\" folgende Callback-URL eintragen:\n\n**F√ºr Replit:**\n```\nhttps://sportoase.app/oauth/callback\n```\n\n**F√ºr andere Domains:**\n```\nhttps://IHR_DOMAIN/oauth/callback\n```\n\n### 1.4 Scopes\n\nStandardm√§√üig ben√∂tigte Scopes (automatisch konfiguriert):\n- `openid` - Grundlegende Authentifizierung\n- `profile` - Name des Benutzers\n- `email` - E-Mail-Adresse\n\n### 1.5 Benutzerrechte\n\nSicherstellen, dass die gew√ºnschten Benutzer/Gruppen die Berechtigung **\"OAuth verwenden\"** haben:\n\n1. Navigieren zu: **Verwaltung ‚Üí Benutzer**\n2. Benutzer/Gruppe ausw√§hlen\n3. Unter \"Rechte\" ‚Üí **\"OAuth verwenden\"** aktivieren\n\n## Schritt 2: SportOase-App Konfiguration (Replit)\n\n### 2.1 Umgebungsvariablen setzen\n\nIn Replit ‚Üí **Secrets** (Schloss-Symbol) folgende Werte hinzuf√ºgen:\n\n| Secret-Name | Wert | Beschreibung |\n|-------------|------|--------------|\n| `ISERV_DOMAIN` | `kgs-pattensen.de` | IServ-Instanz-Domain (ohne https://) |\n| `ISERV_CLIENT_ID` | `[Client-ID von IServ]` | Von IServ generierte Client-ID |\n| `ISERV_CLIENT_SECRET` | `[Client-Secret von IServ]` | Von IServ generiertes Client-Secret |\n\n### 2.2 Beispiel\n\n```\nISERV_DOMAIN=kgs-pattensen.de\nISERV_CLIENT_ID=sportoase_abc123\nISERV_CLIENT_SECRET=xyz789...\n```\n\n### 2.3 Workflow neu starten\n\nNach dem Setzen der Secrets:\n1. Workflow stoppen\n2. Workflow neu starten\n3. Login-Seite aufrufen\n\n‚û°Ô∏è Der **\"Mit IServ anmelden\"** Button sollte jetzt sichtbar sein!\n\n## Schritt 3: Testen\n\n### 3.1 IServ-Login testen\n\n1. Auf der SportOase Login-Seite auf **\"Mit IServ anmelden\"** klicken\n2. Weiterleitung zu IServ ‚Üí Anmeldung mit IServ-Benutzername und Passwort\n3. Best√§tigung der Datenweitergabe (beim ersten Login)\n4. Automatische Weiterleitung zur√ºck zu SportOase\n5. ‚úÖ Erfolgreich angemeldet!\n\n### 3.2 Admin-Rechte pr√ºfen\n\n**Admin-Account** (`morelli.maurizio@kgs-pattensen.de`):\n- ‚úÖ Zugriff auf Admin-Bereich\n- ‚úÖ Kann Buchungen verwalten\n- ‚úÖ Kann Slots blockieren\n- ‚úÖ Kann Slot-Namen √§ndern\n- ‚úÖ Kann Passwort √§ndern\n\n**Lehrer-Accounts** (alle anderen):\n- ‚úÖ K√∂nnen buchen\n- ‚úÖ K√∂nnen eigene Buchungen sehen\n- ‚ùå **Kein** Zugriff auf Admin-Funktionen\n\n## Technische Details\n\n### OAuth-Endpunkte\n\nIServ stellt folgende OAuth2/OIDC-Endpunkte bereit:\n\n```\nDiscovery: https://kgs-pattensen.de/.well-known/openid-configuration\nAuthorization: https://kgs-pattensen.de/iserv/oauth/v2/auth\nToken: https://kgs-pattensen.de/iserv/oauth/v2/token\nUserInfo: https://kgs-pattensen.de/iserv/public/oauth/userinfo\n```\n\n### Datenfluss\n\n1. Benutzer klickt auf \"Mit IServ anmelden\"\n2. Weiterleitung zu IServ Authorization Endpoint\n3. Benutzer meldet sich bei IServ an\n4. IServ leitet zur√ºck mit Authorization Code\n5. SportOase tauscht Code gegen Access Token\n6. SportOase ruft UserInfo-Endpoint auf\n7. Benutzer wird in SportOase angelegt/aktualisiert\n8. Session wird erstellt ‚Üí Benutzer ist angemeldet\n\n### Sicherheit\n\n‚úÖ **OAuth2 + OpenID Connect** (Standard-Protokoll f√ºr SSO)\n‚úÖ **HTTPS** erforderlich (automatisch in Replit)\n‚úÖ **State-Parameter** gegen CSRF-Angriffe\n‚úÖ **Client-Secret** wird sicher auf Server gespeichert (nie im Browser)\n‚úÖ **Automatische Token-Verwaltung** durch Authlib\n\n## Fehlerbehebung\n\n### \"IServ-Login ist nicht konfiguriert\"\n\n‚û°Ô∏è Pr√ºfen Sie, ob `ISERV_CLIENT_ID` und `ISERV_CLIENT_SECRET` in Replit Secrets gesetzt sind\n\n### \"Fehler beim IServ-Login\"\n\n‚û°Ô∏è Pr√ºfen Sie:\n1. Redirect URI in IServ korrekt eingetragen?\n2. Client-ID und Client-Secret korrekt kopiert?\n3. IServ-Domain korrekt (`kgs-pattensen.de` ohne `https://`)?\n\n### Button \"Mit IServ anmelden\" nicht sichtbar\n\n‚û°Ô∏è Secrets gesetzt und Workflow neu gestartet?\n\n### Benutzer erh√§lt keine Admin-Rechte\n\n‚û°Ô∏è Ist die E-Mail-Adresse exakt `morelli.maurizio@kgs-pattensen.de`?\n\n## Duales Login-System\n\nDie SportOase-App unterst√ºtzt **beide** Login-Methoden gleichzeitig:\n\n1. **Traditioneller Login** (Benutzername + Passwort)\n   - F√ºr bestehende Accounts\n   - F√ºr Notf√§lle, falls IServ nicht erreichbar ist\n\n2. **IServ SSO Login**\n   - F√ºr alle IServ-Benutzer\n   - Automatische Account-Erstellung\n   - Keine separaten Passw√∂rter notwendig\n\n## Support\n\nBei Fragen oder Problemen:\n- **IServ-Konfiguration**: Kontaktieren Sie Ihren IServ-Administrator\n- **SportOase-App**: Kontaktieren Sie `sportoase.kg@gmail.com`\n\n## Changelog\n\n- **2025-11-24**: IServ SSO Integration implementiert\n- Unterst√ºtzung f√ºr OAuth2/OpenID Connect\n- Automatische Rollenzuweisung (Admin vs. Lehrer)\n- Duales Login-System (traditionell + SSO)\n","path":null,"size_bytes":5911,"size_tokens":null},"test_email_smtp.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nTest-Script f√ºr E-Mail-Versand via SMTP\nTestet, ob Buchungsbenachrichtigungen an sportoase.kgs@gmail.com funktionieren\n\"\"\"\n\nimport os\nimport sys\n\n# F√ºge aktuelles Verzeichnis zum Python-Pfad hinzu\nsys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))\n\nfrom email_service import send_booking_notification\n\ndef test_email_sending():\n    \"\"\"Testet den E-Mail-Versand mit einem Beispiel-Buchung\"\"\"\n    \n    print(\"=\" * 60)\n    print(\"TEST: E-Mail-Versand f√ºr Buchungsbenachrichtigungen\")\n    print(\"=\" * 60)\n    \n    # Pr√ºfe SMTP-Konfiguration\n    smtp_user = os.environ.get('SMTP_USER')\n    smtp_pass = os.environ.get('SMTP_PASS')\n    \n    print(f\"\\n‚úì SMTP_USER: {smtp_user if smtp_user else '‚ùå NICHT GESETZT'}\")\n    print(f\"‚úì SMTP_PASS: {'‚úì Gesetzt' if smtp_pass else '‚ùå NICHT GESETZT'}\")\n    \n    if not smtp_user or not smtp_pass:\n        print(\"\\n‚ùå FEHLER: SMTP-Zugangsdaten sind nicht konfiguriert!\")\n        print(\"Bitte setzen Sie SMTP_USER und SMTP_PASS in den Replit Secrets.\")\n        return False\n    \n    # Test-Buchungsdaten\n    booking_data = {\n        'teacher_name': 'Max Mustermann',\n        'teacher_class': '5A',\n        'date': '2025-11-18',\n        'weekday': 'Montag',\n        'period': 3,\n        'offer_label': 'Konflikt-Reset & Deeskalation',\n        'offer_type': 'fest',\n        'students_json': '[{\"name\": \"Anna Schmidt\", \"klasse\": \"5A\"}, {\"name\": \"Tom Weber\", \"klasse\": \"5B\"}]'\n    }\n    \n    admin_email = 'sportoase.kgs@gmail.com'\n    \n    print(f\"\\nüìß Sende Test-E-Mail an: {admin_email}\")\n    print(f\"   Lehrkraft: {booking_data['teacher_name']}\")\n    print(f\"   Datum: {booking_data['date']} ({booking_data['weekday']})\")\n    print(f\"   Stunde: {booking_data['period']}. Stunde\")\n    print(f\"   Angebot: {booking_data['offer_label']}\")\n    \n    # E-Mail senden\n    success = send_booking_notification(booking_data, admin_email)\n    \n    if success:\n        print(\"\\n‚úÖ E-Mail wurde erfolgreich versendet!\")\n        print(f\"‚úÖ √úberpr√ºfen Sie das Postfach: {admin_email}\")\n        return True\n    else:\n        print(\"\\n‚ùå E-Mail-Versand fehlgeschlagen!\")\n        print(\"√úberpr√ºfen Sie die Logs f√ºr Details.\")\n        return False\n\nif __name__ == '__main__':\n    test_email_sending()\n","path":null,"size_bytes":2275,"size_tokens":null},"PRODUCTION_DEPLOYMENT_TODO.md":{"content":"# Production Deployment Checkliste - SportOase\n\n## Status: VORBEREITET - Warte auf IServ-Konfiguration\n\n---\n\n## ‚úÖ ERLEDIGT\n\n### Sicherheit & Konfiguration\n- [x] SESSION_SECRET wird streng erzwungen (keine Fallback-Werte)\n- [x] Keine sensiblen Daten in Logs (DATABASE_URL entfernt)\n- [x] IServ SSO Integration implementiert (OAuth2/OpenID Connect)\n- [x] CSRF-Protection auf allen POST-Routes\n- [x] Render Production Database konfiguriert (DATABASE_URL in Production-Env gesetzt)\n\n### Datenbank\n- [x] User-Model erweitert f√ºr OAuth (oauth_provider, oauth_id, nullable password)\n- [x] Migration f√ºr OAuth-Felder vorhanden (migration_add_oauth_fields.py)\n- [x] Dual-Login unterst√ºtzt (Passwort + IServ SSO)\n\n### Code-Qualit√§t\n- [x] Architect Review durchgef√ºhrt - APPROVED\n- [x] Keine Mock-Daten im Code\n- [x] Saubere Fehlerbehandlung\n\n---\n\n## ‚è≥ N√ÑCHSTE SCHRITTE - PRODUCTION READY MACHEN\n\n### 1. IServ-Integration aktivieren (BLOCKIERT - braucht Admin)\n\n**Was fehlt:**\n```bash\n# Diese 3 Umgebungsvariablen m√ºssen in Replit Secrets gesetzt werden:\nISERV_BASE_URL=https://kgs-pattensen.de  # IServ-Server-URL\nISERV_CLIENT_ID=<vom IServ-Admin>        # OAuth Client-ID\nISERV_CLIENT_SECRET=<vom IServ-Admin>    # OAuth Client-Secret\n```\n\n**Wo bekommt man das:**\n- IServ-Administrator muss im IServ-Panel konfigurieren:\n  - Pfad: `Verwaltung ‚Üí System ‚Üí Single-Sign-On`\n  - Neue OAuth2-App erstellen\n  - Redirect URI: `https://sportoase.app/oauth/callback`\n  - Scopes: `openid profile email`\n\n**Was passiert danach:**\n- Button \"Mit IServ anmelden\" erscheint auf Login-Seite\n- IServ-User k√∂nnen sich direkt mit Schul-Zugangsdaten anmelden\n- Rolle wird automatisch zugewiesen:\n  - morelli.maurizio@kgs-pattensen.de ‚Üí Admin\n  - Alle anderen IServ-User ‚Üí Lehrer\n\n---\n\n### 2. Production-Datenbank Migration durchf√ºhren\n\n**Aktueller Stand:**\n- Production DATABASE_URL ist gesetzt ‚úì\n- Migration-Script existiert (migration_add_oauth_fields.py) ‚úì\n\n**Was zu tun ist:**\n```bash\n# WICHTIG: VOR dem Render-Deployment ausf√ºhren!\n# Option A: Migration direkt auf Render-DB laufen lassen\npython3 migration_add_oauth_fields.py\n\n# Option B: Falls existierende Production-DB vorhanden\n# 1. Backup der Production-DB erstellen\n# 2. Migration testen\n# 3. Bei Erfolg: Live schalten\n```\n\n**Was die Migration macht:**\n- F√ºgt `oauth_provider` (VARCHAR 50) zu User-Tabelle hinzu\n- F√ºgt `oauth_id` (VARCHAR 255) zu User-Tabelle hinzu\n- Macht `password_hash` nullable (f√ºr OAuth-only User)\n- Erstellt unique constraint auf (oauth_provider, oauth_id)\n\n---\n\n### 3. SMTP/Email-Konfiguration √ºberpr√ºfen\n\n**Aktueller Stand:**\n- Gmail-Integration ist als Connector vorhanden (needs setup)\n- SMTP-Variablen f√ºr Fallback sollten gesetzt sein\n\n**Was zu tun ist:**\n```bash\n# Diese Variablen sollten in Production gesetzt sein:\nSMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_USER=sportoase.kg@gmail.com\nSMTP_PASS=<App-Passwort>\nSMTP_FROM=sportoase.kg@gmail.com\nADMIN_EMAIL=sportoase.kg@gmail.com\n```\n\n**ODER:** Gmail-Connector richtig konfigurieren (bevorzugt)\n\n---\n\n### 4. Render Deployment vorbereiten\n\n**Was zu √ºberpr√ºfen:**\n- [ ] Alle Environment Variables in Render gesetzt:\n  - SESSION_SECRET (neuen zuf√§lligen Wert generieren!)\n  - DATABASE_URL (bereits gesetzt ‚úì)\n  - ISERV_BASE_URL\n  - ISERV_CLIENT_ID\n  - ISERV_CLIENT_SECRET\n  - SMTP_* Variablen\n\n- [ ] Render Build-Settings:\n  ```\n  Build Command: pip install -r requirements.txt\n  Start Command: gunicorn --bind 0.0.0.0:$PORT --reuse-port main:app\n  ```\n\n- [ ] Python Version: 3.11\n\n---\n\n### 5. Nach Deployment: Testing\n\n**Test-Checkliste:**\n- [ ] Normale Login funktioniert (Passwort)\n- [ ] IServ SSO Login funktioniert\n- [ ] Admin-User (morelli.maurizio@kgs-pattensen.de) hat Admin-Rechte\n- [ ] Andere IServ-User haben Lehrer-Rechte\n- [ ] Buchungen k√∂nnen erstellt werden\n- [ ] Email-Benachrichtigungen funktionieren\n- [ ] Dashboard l√§dt korrekt\n- [ ] Keine Fehler in Production-Logs\n\n---\n\n## üìù Wichtige Notizen\n\n### Sicherheit\n- **SESSION_SECRET**: NIEMALS den Replit-Wert in Production verwenden! Neuen generieren.\n- **Database Credentials**: Bereits sicher (nicht in Logs)\n- **OAuth Secrets**: Werden vom IServ-Admin bereitgestellt\n\n### Rollback-Plan\nFalls nach Deployment Probleme auftreten:\n1. IServ-Button kann durch Entfernen der ISERV_* Variablen deaktiviert werden\n2. Traditioneller Login bleibt immer funktionsf√§hig\n3. Database-Backup vor Migration erstellen!\n\n### Support-Kontakte\n- IServ-Administrator: [Name eintragen]\n- Render Support: https://render.com/support\n- Gmail API: Google Workspace Admin\n\n---\n\n## üéØ Deployment-Reihenfolge (WICHTIG!)\n\n```\n1. IServ-Admin kontaktieren ‚Üí Client-ID/Secret erhalten\n   ‚Üì\n2. Environment Variables in Render setzen (inkl. neues SESSION_SECRET!)\n   ‚Üì\n3. Database-Backup erstellen\n   ‚Üì\n4. Migration auf Production-DB ausf√ºhren\n   ‚Üì\n5. App auf Render deployen\n   ‚Üì\n6. Testing durchf√ºhren (siehe Checkliste oben)\n   ‚Üì\n7. Bei Erfolg: User informieren, dass IServ-Login verf√ºgbar ist\n```\n\n---\n\n**Zuletzt aktualisiert:** 24. November 2025\n**Version:** 1.0 - IServ SSO Integration abgeschlossen\n","path":null,"size_bytes":5114,"size_tokens":null},"render.yaml":{"content":"services:\n  - type: web\n    name: sportoase-buchungssystem\n    runtime: python\n    plan: starter\n    region: frankfurt\n    branch: main\n    buildCommand: pip install -r requirements.txt\n    startCommand: gunicorn --bind 0.0.0.0:$PORT --workers 2 --timeout 120 --preload main:app\n    healthCheckPath: /\n    envVars:\n      - key: PYTHON_VERSION\n        value: 3.11.0\n      - key: DATABASE_URL\n        fromDatabase:\n          name: sportoase-db\n          property: connectionString\n      - key: SESSION_SECRET\n        generateValue: true\n      - key: ISERV_CLIENT_ID\n        sync: false\n      - key: ISERV_CLIENT_SECRET\n        sync: false\n      - key: ISERV_DOMAIN\n        value: kgs-pattensen.de\n      - key: SMTP_USER\n        sync: false\n      - key: SMTP_PASS\n        sync: false\n      - key: GOOGLE_CALENDAR_CREDENTIALS\n        sync: false\n      - key: GOOGLE_CALENDAR_ID\n        value: sportoase.kgs@gmail.com\n\ndatabases:\n  - name: sportoase-db\n    databaseName: sportoase\n    plan: starter\n    region: frankfurt\n","path":null,"size_bytes":1016,"size_tokens":null},"gunicorn_config.py":{"content":"import multiprocessing\nimport os\n\nbind = \"0.0.0.0:5000\"\nworkers = multiprocessing.cpu_count() * 2 + 1\nworker_class = \"sync\"\nworker_connections = 1000\ntimeout = 120\nkeepalive = 5\n\nmax_requests = 1000\nmax_requests_jitter = 50\n\nerrorlog = \"-\"\nloglevel = \"info\"\naccesslog = \"-\"\naccess_log_format = '%(h)s %(l)s %(u)s %(t)s \"%(r)s\" %(s)s %(b)s \"%(f)s\" \"%(a)s\"'\n\npreload_app = False\n\ndef on_starting(server):\n    \"\"\"Called just before the master process is initialized.\"\"\"\n    server.log.info(\"Starting SportOase Buchungssystem\")\n\ndef on_reload(server):\n    \"\"\"Called to recycle workers during a reload via SIGHUP.\"\"\"\n    server.log.info(\"Reloading SportOase Buchungssystem\")\n\ndef when_ready(server):\n    \"\"\"Called just after the server is started.\"\"\"\n    server.log.info(\"SportOase Buchungssystem is ready to serve requests\")\n\ndef on_exit(server):\n    \"\"\"Called just before exiting Gunicorn.\"\"\"\n    server.log.info(\"Shutting down SportOase Buchungssystem\")\n","path":null,"size_bytes":952,"size_tokens":null}},"version":2}